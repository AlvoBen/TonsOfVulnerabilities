using System;
using System.ComponentModel;
using System.Collections;
using System.Collections.Generic;
using System.Data;
using System.Diagnostics;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using System.Xml;
using System.Windows.Threading;
using Epi;
using Epi.Core;
using Epi.Data;
using Epi.Fields;
using EpiDashboard;
using EpiDashboard.Rules;

namespace EpiDashboard
{



    public class DashboardHelper
    {
        //Private Members
                int Combined_Frequency_Row_Limit = 250;
                int Frequency_Row_Limit = 200;
                int LineList_Row_Limit = 2000;
                int Aberration_Row_Limit = 366;
                int Frequency_Strata_Limit = 100;
                int Frequency_Crosstab_Limit = 100;
                IDbDriver db;
                DashboardControl dashboardControl;
                CaseInsensitiveEqualityComparer caseInsensitiveEqualityComparer = new CaseInsensitiveEqualityComparer();
                DataTable mainTable;
                DataSet ds;
                object syncLock = new object();
                object syncLockView = new object();
                object syncLockDistinct = new object();
        //

        //Constructors



        public DashboardHelper()
        {
            this.TableName = string.Empty;
            Construct();
        }






        public DashboardHelper(View view, IDbDriver db)
        {
            //Input Validation
            if (view == null)
            {
                throw new ApplicationException("View can not be null."); // TODO: Update text and move string to shared strings
            }

            if (db == null)
            {
                throw new ApplicationException("Data driver can not be null."); // TODO: Update text and move string to shared strings
            }
            //

            this.View = view;
            this.TableName = string.Empty;
            this.db = db;
            Construct();
        }






        public DashboardHelper(string tableName, IDbDriver db)
        {
            //Input Validation
            if (string.IsNullOrEmpty(tableName.Trim()))
            {
                throw new ApplicationException("Table name cannot be null or empty."); // TODO: Update text and move string to shared strings
            }

            if (db == null)
            {
                throw new ApplicationException("Data driver can not be null."); // TODO: Update text and move string to shared strings
            }
            //

            this.View = null;
            this.TableName = tableName;
            this.db = db;
            Construct();
        }







        public DashboardHelper(string tableName, string customQuery, IDbDriver db)
        {
            //Input Validation
            if (string.IsNullOrEmpty(tableName.Trim()))
            {
                throw new ApplicationException("Table name cannot be null or empty."); // TODO: Update text and move string to shared strings
            }

            if (string.IsNullOrEmpty(customQuery.Trim()))
            {
                throw new ApplicationException("Query name cannot be null or empty."); // TODO: Update text and move string to shared strings
            }

            if (db == null)
            {
                throw new ApplicationException("Data driver can not be null."); // TODO: Update text and move string to shared strings
            }
            //

            this.View = null;
            this.TableName = string.Empty;
            this.db = db;
            this.CustomQuery = customQuery;
            Construct();
        }
        //

        //Public Properties



        public bool IsAutoClosing { get {return _IsAutoClosing; } set{ _IsAutoClosing=value; } } bool _IsAutoClosing;




        internal string CurrentCanvas
        {
            get
            {
                return this.dashboardControl.CurrentCanvas;
            }
        }




        public string CustomQuery { get {return _CustomQuery; } set{ _CustomQuery=value; } } string _CustomQuery;




        public int RecordCount { get {return _RecordCount; } set{ _RecordCount=value; } } int _RecordCount;




        public bool UseAdvancedUserDataFilter { get {return _UseAdvancedUserDataFilter; } set{ _UseAdvancedUserDataFilter=value; } } bool _UseAdvancedUserDataFilter;




        public string AdvancedUserDataFilter { get {return _AdvancedUserDataFilter; } set{ _AdvancedUserDataFilter=value; } } string _AdvancedUserDataFilter;





        public View View { get {return _View; } set{ _View=value; } } View _View;





        public RecordProcessingScope RecordProcessScope
        {
            get
            {
                return this.DataFilters.RecordProcessScope;
            }
            set
            {
                this.DataFilters.RecordProcessScope = value;
            }
        }




        public bool UserVarsNeedUpdating { get {return _UserVarsNeedUpdating; } set{ _UserVarsNeedUpdating=value; } } bool _UserVarsNeedUpdating;




        public DateTime LastCacheTime { get {return _LastCacheTime; } set{ _LastCacheTime=value; } } DateTime _LastCacheTime;




        public string TimeToCache { get {return _TimeToCache; } set{ _TimeToCache=value; } } string _TimeToCache;




        public Dictionary TableColumnNames { get {return _TableColumnNames; } set{ _TableColumnNames=value; } } Dictionary _TableColumnNames;




        public DataTable FieldTable { get {return _FieldTable; } set{ _FieldTable=value; } } DataTable _FieldTable;




        public List ConnectionsForRelate { get {return _ConnectionsForRelate; } set{ _ConnectionsForRelate=value; } } List _ConnectionsForRelate;




        public IDbDriver Database
        {
            get
            {
                return this.db;
            }
        }




        public DataSet DataSet
        {
            get
            {
                return this.ds;
            }
        }





        public string TableName { get {return _TableName; } set{ _TableName=value; } } string _TableName;





        public string SafeTableName
        {
            get
            {
                return FormatTableName(this.TableName);
            }
        }




        public bool IsUsingEpiProject
        {
            get
            {
                if (this.View == null)
                {
                    return false;
                }
                else
                {
                    return true;
                }
            }
        }




        public DataFilters DataFilters { get {return _DataFilters; } set{ _DataFilters=value; } } DataFilters _DataFilters;




        public DashboardRules Rules { get {return _Rules; } set{ _Rules=value; } } DashboardRules _Rules;




        public Configuration Config { get {return _Config; } set{ _Config=value; } } Configuration _Config;
        //

        //Events
        public event NotificationEventHandler NotificationEvent;
        //

        //Public Methods




        public void SetDashboardControl(DashboardControl control)
        {
            this.dashboardControl = control;
        }





        public string ToHTML(string htmlFileName = "")
        {
            StringBuilder htmlOutput = new StringBuilder();

            htmlOutput.AppendLine("");
            if (IsUsingEpiProject)
            {
                htmlOutput.AppendLine("Current form:</em> ");
                htmlOutput.AppendLine("" + this.View.FullName + "</strong>");
            }
            else
            {
                htmlOutput.AppendLine("Current data source:</em> ");
                htmlOutput.AppendLine("" + this.Database.ConnectionDescription + "</strong>");
            }

            htmlOutput.AppendLine("<br/>");

            if (DataFilters.Count > 0 || (UseAdvancedUserDataFilter && !string.IsNullOrEmpty(AdvancedUserDataFilter)))
            {
                htmlOutput.AppendLine("Active data filters:</em> ");
                htmlOutput.AppendLine("" + GenerateFilterCriteria() + "</strong>");
                htmlOutput.AppendLine("<br />");
            }

            htmlOutput.AppendLine("Record count:</em> ");
            htmlOutput.AppendLine("" + this.RecordCount.ToString() + "</strong>");

            switch (this.RecordProcessScope)
            {
                case RecordProcessingScope.Undeleted:
                    htmlOutput.AppendLine(" (Deleted records excluded)</em> ");
                    break;
                case RecordProcessingScope.Deleted:
                    htmlOutput.AppendLine(" (Deleted records only)</em> ");
                    break;
                case RecordProcessingScope.Both:
                    htmlOutput.AppendLine(" (Both deleted and undeleted records)</em> ");
                    break;
            }

            htmlOutput.AppendLine(" Date:</em> ");
            htmlOutput.AppendLine("" + DateTime.Now.ToShortDateString() + " " + DateTime.Now.ToShortTimeString() + "</strong>");

            htmlOutput.AppendLine("</p>");

            return htmlOutput.ToString();
        }





        public XmlElement Serialize(XmlDocument doc)
        {
            System.Xml.XmlElement root = doc.CreateElement("dashboardHelper");

            string xmlString = string.Empty;

            if (IsUsingEpiProject)
            {
                xmlString =
                    "" + this.View.Project.FilePath + "</projectPath>" +
                    "" + this.View.Name + "</viewName>";
            }
            else
            {
                xmlString =
                    "" + Configuration.Encrypt(this.Database.ConnectionString) + "</connectionString>";
                if (!string.IsNullOrEmpty(this.TableName))
                {
                    xmlString += "" + this.TableName.Replace("&", "&amp;") + "</tableName>";
                }

                if (!string.IsNullOrEmpty(this.CustomQuery))
                {
                    xmlString = xmlString + "" + this.CustomQuery.Replace("&", "&amp;").Replace(">", "&gt;").Replace("<", "&lt;") + "</customSQLQuery>";
                }
            }

            xmlString +=
            "" + this.AdvancedUserDataFilter + "</advancedDataFilterCondition>" +
            "" + this.UseAdvancedUserDataFilter.ToString().Replace("&", "&amp;").Replace(">", "&gt;").Replace("<", "&lt;") + "</useAdvancedDataFilterCondition>";

            root.InnerXml = xmlString;
            root.AppendChild(SerializeRelatedDataConnections(doc));
            root.AppendChild(SerializeFilters(doc));
            root.AppendChild(SerializeRules(doc));

            return root;
        }





        public void CreateFromXml(XmlElement element)
        {
            string projectPath = string.Empty;
            string viewName = string.Empty;
            string connectionString = string.Empty;
            string table = string.Empty;

            TableColumnNames.Clear();

            this.DataFilters = new DataFilters(this);

            foreach (System.Xml.XmlElement child in element.ChildNodes)
            {
                string name = child.Name.ToLower();

                switch (name)
                {
                    case "projectpath":
                        projectPath = child.InnerText;
                        break;
                    case "viewname":
                        viewName = child.InnerText;
                        break;
                    case "connectionstring":
                        if (!string.IsNullOrEmpty(child.InnerText)) { connectionString = Configuration.Decrypt(child.InnerText); }
                        break;
                    case "tablename":
                        table = child.InnerText.Replace("&amp;", "&");
                        break;
                    case "datafilters":
                        this.DataFilters.CreateFromXml(child);
                        break;
                    case "dashboardrules":
                        this.Rules.CreateFromXml(child);
                        break;
                    case "advanceddatafiltercondition":
                        this.AdvancedUserDataFilter = child.InnerText.Replace("&amp;", "&").Replace("&gt;", ">").Replace("&lt;", "<");
                        break;
                    case "useadvanceddatafiltercondition":
                        this.UseAdvancedUserDataFilter = bool.Parse(child.InnerText);
                        break;
                    case "customsqlquery":
                        this.CustomQuery = child.InnerText.Trim().Replace("&amp;", "&").Replace("&gt;", ">").Replace("&lt;", "<");
                        break;
                    case "relateddataconnections":
                        foreach (System.Xml.XmlElement grandChild in child.ChildNodes)
                        {
                            if (grandChild.Name.ToLower().Equals("relateddataconnection"))
                            {
                                string rel_projectPath = string.Empty;
                                string rel_viewName = string.Empty;
                                string rel_connectionString = string.Empty;
                                string rel_tableName = string.Empty;
                                string rel_parentKey = string.Empty;
                                string rel_childKey = string.Empty;
                                bool rel_useUnmatched = true;
                                bool rel_sameDataSource = true;

                                foreach (XmlElement rChild in grandChild.ChildNodes)
                                {
                                    switch (rChild.Name.ToLower())
                                    {
                                        case "projectpath":
                                            rel_projectPath = rChild.InnerText;
                                            break;
                                        case "viewname":
                                            rel_viewName = rChild.InnerText;
                                            break;
                                        case "connectionstring":
                                            if (!string.IsNullOrEmpty(rChild.InnerText)) { rel_connectionString = Configuration.Decrypt(rChild.InnerText); }
                                            break;
                                        case "tablename":
                                            rel_tableName = rChild.InnerText;
                                            break;
                                        case "parentkeyfield":
                                            rel_parentKey = rChild.InnerText;
                                            break;
                                        case "childkeyfield":
                                            rel_childKey = rChild.InnerText;
                                            break;
                                        case "useunmatched":
                                            bool.TryParse(rChild.InnerText, out rel_useUnmatched);
                                            break;
                                        case "samedatasource":
                                            bool.TryParse(rChild.InnerText, out rel_sameDataSource);
                                            break;
                                    }
                                }

                                if (string.IsNullOrEmpty(rel_viewName))
                                {
                                    //Validate and Update Project Path

                                    if (!string.IsNullOrEmpty(projectPath))
                                    {
                                        if (rel_sameDataSource)
                                        {
                                            FileInfo fiMainProject = new FileInfo(projectPath);
                                            Project mainProject = new Project(projectPath);

                                            if (rel_connectionString.ToLower().StartsWith("provider=microsoft.ace") || rel_connectionString.ToLower().StartsWith("provider=microsoft.jet.oledb"))
                                            {
                                                string filePath = string.Empty;

                                                int indexOf = rel_connectionString.IndexOf("Data Source=");

                                                if (indexOf >= 0)
                                                {
                                                    indexOf += 12;
                                                    filePath = rel_connectionString.Substring(indexOf, rel_connectionString.Length - indexOf);

                                                    indexOf = filePath.IndexOf(';');

                                                    if (indexOf >= 0)
                                                    {
                                                        filePath = filePath.Substring(0, indexOf);
                                                        filePath = filePath.TrimStart('\"');
                                                        filePath = filePath.TrimEnd('\"');

                                                        FileInfo fiDataSource = new FileInfo(filePath);

                                                        string dsPath = filePath;

                                                        if (File.Exists(fiMainProject.Directory + "\\" + fiDataSource.Name))
                                                        {
                                                            dsPath = fiMainProject.Directory + "\\" + fiDataSource.Name;
                                                            rel_connectionString = rel_connectionString.Replace(filePath, dsPath);

                                                        }
                                                        else if (!System.IO.File.Exists(dsPath))
                                                        {
                                                            string message = string.Format("The data source for      canvas cannot be found: " + dsPath);
                                                            Epi.Windows.MsgBox.ShowError(message);
                                                            return;
                                                        }
                                                    }
                                                }
                                            }

                                        }
                                        else
                                        {

                                            continue;
                                        }
                                    }

                                    //

                                    IDbDriver database = DBReadExecute.GetDataDriver(rel_connectionString);
                                    if (database.CheckDatabaseTableExistance(rel_connectionString, rel_tableName, true))
                                    {
                                        RelatedConnection rConn = new RelatedConnection(rel_tableName, database, rel_parentKey, rel_childKey, rel_useUnmatched, rel_sameDataSource);
                                        AddRelatedDataSource(rConn);
                                    }
                                    else
                                    {

                                        continue;
                                    }
                                }
                                else
                                {
                                    //Validate and Update Project Path

                                    if (!File.Exists(rel_projectPath) && !string.IsNullOrEmpty(projectPath))
                                    {
                                        if (rel_sameDataSource)
                                        {
                                            FileInfo fiRelatedProject = new FileInfo(rel_projectPath);
                                            FileInfo fiMainProject = new FileInfo(projectPath);

                                            Project mainProject = new Project(projectPath);

                                            if (File.Exists(projectPath))
                                            {
                                                rel_projectPath = fiMainProject.Directory + "\\" + mainProject.Name + ".prj";
                                            }
                                        }
                                        else
                                        {

                                            continue;
                                        }
                                    }

                                    //

                                    Project newProject = new Project(rel_projectPath);
                                    if (newProject.Views.Contains(rel_viewName))
                                    {
                                        View newView = newProject.GetViewByName(rel_viewName);
                                        IDbDriver database = DBReadExecute.GetDataDriver(rel_projectPath);
                                        RelatedConnection rConn = new RelatedConnection(newView, database, rel_parentKey, rel_childKey, rel_useUnmatched, rel_sameDataSource);
                                        AddRelatedDataSource(rConn);
                                    }
                                    else
                                    {
                                        string exMsg = string.Format(DashboardSharedStrings.ERROR_FORM_NOT_FOUND_FOR_CANVAS, viewName);
                                        throw new ViewNotFoundException(exMsg);
                                    }
                                }
                            }
                        }
                        break;
                }
            }

            if (!string.IsNullOrEmpty(projectPath) && !string.IsNullOrEmpty(viewName))
            {
                if (System.IO.File.Exists(projectPath))
                {
                    Project newProject = new Project(projectPath);
                    if (newProject.Views.Contains(viewName))
                    {
                        View newView = newProject.GetViewByName(viewName);
                        IDbDriver database = DBReadExecute.GetDataDriver(projectPath);

                        this.View = newView;
                        this.db = database;
                    }
                    else
                    {
                        string exMsg = string.Format(DashboardSharedStrings.ERROR_FORM_NOT_FOUND_FOR_CANVAS, viewName);
                        throw new ViewNotFoundException(exMsg);
                    }
                }
                else if (System.IO.File.Exists(Config.Directories.Project + projectPath.Replace(".prj", "") + "\\" + projectPath))
                {
                    string newProjectPath = Config.Directories.Project + projectPath.Replace(".prj", "") + "\\" + projectPath;
                    Project newProject = new Project(newProjectPath);
                    if (newProject.Views.Contains(viewName))
                    {
                        View newView = newProject.GetViewByName(viewName);
                        IDbDriver database = DBReadExecute.GetDataDriver(newProjectPath);

                        this.View = newView;
                        this.db = database;
                    }
                    else
                    {
                        string exMsg = string.Format(DashboardSharedStrings.ERROR_FORM_NOT_FOUND_FOR_CANVAS, viewName);
                        throw new ViewNotFoundException(exMsg);
                    }
                }
                else
                {
                    string exMsg = string.Format(DashboardSharedStrings.ERROR_PROJECT_NOT_FOUND_FOR_CANVAS, projectPath);
                    throw new System.IO.FileNotFoundException(exMsg);
                }
            }
            else if (!string.IsNullOrEmpty(connectionString))
            {
                IDbDriver database = DBReadExecute.GetDataDriver(connectionString);

                this.db = database;
                if (!string.IsNullOrEmpty(table))
                {
                    this.TableName = table;
                }
            }
            else
            {
                throw new ApplicationException(DashboardSharedStrings.ERROR_CANVAS_XML_INVALID);
            }

        }








        public string GetFormattedOutput(string columnName, object data)
        {
            bool useSpecialFormatting = false;
            string formatString = string.Empty;
            string displayValue = data.ToString();

            if (IsColumnBoolean(columnName))
            {
                if (data.ToString().ToLower().Equals("true"))
                {
                    displayValue = this.Config.Settings.RepresentationOfYes;
                }
                else if (data.ToString().ToLower().Equals("false"))
                {
                    displayValue = this.Config.Settings.RepresentationOfNo;
                }
            }


            foreach (IDashboardRule rule in this.Rules)
            {
                if (rule is Rule_Format)
                {
                    Rule_Format formatRule = rule as Rule_Format;

                    if (formatRule.ExecutionLocation == RuleExecutionLocation.ExecuteAfter)
                    {
                        if (formatRule.SourceColumnName.Equals(columnName))
                        {
                            formatString = formatRule.GetFormatString();
                            useSpecialFormatting = true;
                        }
                    }
                }
            }

            if (useSpecialFormatting)
            {
                displayValue = string.Format(System.Globalization.CultureInfo.CurrentCulture, formatString, data);
            }

            return displayValue;
        }










        public bool AddDataFilterCondition(string friendlyOperand, string friendlyValue, string columnName, ConditionJoinType joinType)
        {
            //Input Validation
            if (string.IsNullOrEmpty(friendlyOperand.Trim()))
            {
                throw new ArgumentNullException("friendlyOperand");
            }
            else if (string.IsNullOrEmpty(columnName.Trim()))
            {
                throw new ArgumentNullException("columnName");
            }
            //

            bool added = false;
            string columnType = GetColumnType(columnName);
            string rawColumnName = columnName;

            columnName = AddBracketsToString(columnName);

            if (columnType.Equals("System.DateTime") && friendlyOperand.Equals(SharedStrings.FRIENDLY_OPERATOR_EQUAL_TO))
            {
                DateTime lowVal = DateTime.Parse(friendlyValue, System.Globalization.CultureInfo.CurrentCulture);
                string friendlyLowValue = lowVal.ToString("M/d/yyyy", System.Globalization.CultureInfo.InvariantCulture);

                DateTime highVal = DateTime.Parse(friendlyValue, System.Globalization.CultureInfo.CurrentCulture);
                string friendlyHighValue = highVal.ToString("M/d/yyyy", System.Globalization.CultureInfo.InvariantCulture);

                FilterCondition newCondition = DataFilters.GenerateFilterCondition(columnName, rawColumnName, columnType, friendlyOperand, friendlyLowValue, friendlyHighValue);
                DataFilters.AddFilterCondition(newCondition, joinType);
            }
            else if (columnType.Equals("System.DateTime") && friendlyOperand.Equals(SharedStrings.FRIENDLY_OPERATOR_LESS_THAN_OR_EQUAL))
            {
                DateTime dateVal = DateTime.Parse(friendlyValue, System.Globalization.CultureInfo.CurrentCulture);

                if (dateVal.Hour == 0)
                    dateVal = dateVal.AddHours(23);
                if (dateVal.Minute == 0)
                    dateVal = dateVal.AddMinutes(59);
                if (dateVal.Second == 0)
                    dateVal = dateVal.AddSeconds(59);
                if (dateVal.Millisecond == 0)
                    dateVal = dateVal.AddMilliseconds(999);

                friendlyValue = dateVal.ToString("M/d/yyyy HH:mm:ss", System.Globalization.CultureInfo.InvariantCulture);

                FilterCondition newCondition = DataFilters.GenerateFilterCondition(columnName, rawColumnName, columnType, friendlyOperand, friendlyValue);
                DataFilters.AddFilterCondition(newCondition, joinType);
            }
            else if (columnType.Equals("System.DateTime") && friendlyOperand.Equals(SharedStrings.FRIENDLY_OPERATOR_GREATER_THAN))
            {
                DateTime dateVal = DateTime.Parse(friendlyValue, System.Globalization.CultureInfo.CurrentCulture);

                if (dateVal.Hour == 0)
                    dateVal = dateVal.AddHours(23);
                if (dateVal.Minute == 0)
                    dateVal = dateVal.AddMinutes(59);
                if (dateVal.Second == 0)
                    dateVal = dateVal.AddSeconds(59);
                if (dateVal.Millisecond == 0)
                    dateVal = dateVal.AddMilliseconds(999);

                friendlyValue = dateVal.ToString("M/d/yyyy HH:mm:ss", System.Globalization.CultureInfo.InvariantCulture);

                FilterCondition newCondition = DataFilters.GenerateFilterCondition(columnName, rawColumnName, columnType, friendlyOperand, friendlyValue);
                DataFilters.AddFilterCondition(newCondition, joinType);
            }
            else if (columnType.Equals("System.DateTime"))
            {
                if (string.IsNullOrEmpty(friendlyValue))
                {
                    friendlyValue = Config.Settings.RepresentationOfMissing;
                }
                else
                {
                    DateTime dateVal = DateTime.Parse(friendlyValue, System.Globalization.CultureInfo.CurrentCulture);
                    friendlyValue = dateVal.ToString("M/d/yyyy", System.Globalization.CultureInfo.InvariantCulture);
                }

                FilterCondition newCondition = DataFilters.GenerateFilterCondition(columnName, rawColumnName, columnType, friendlyOperand, friendlyValue);
                DataFilters.AddFilterCondition(newCondition, joinType);
            }
            else
            {
                FilterCondition newCondition = DataFilters.GenerateFilterCondition(columnName, rawColumnName, columnType, friendlyOperand, friendlyValue);
                DataFilters.AddFilterCondition(newCondition, joinType);
            }

            return added;
        }







        public bool AddDataFilterCondition(string friendlyOperand, string friendlyLowValue, string friendlyHighValue, string columnName, ConditionJoinType joinType)
        {
            //Input Validation
            if (string.IsNullOrEmpty(friendlyOperand.Trim()))
            {
                throw new ArgumentNullException("friendlyOperand");
            }
            else if (string.IsNullOrEmpty(columnName.Trim()))
            {
                throw new ArgumentNullException("columnName");
            }
            else if (string.IsNullOrEmpty(friendlyLowValue.Trim()))
            {
                throw new ArgumentNullException("friendlyLowValue");
            }
            else if (string.IsNullOrEmpty(friendlyHighValue.Trim()))
            {
                throw new ArgumentNullException("friendlyHighValue");
            }
            //

            string columnType = GetColumnType(columnName);
            string rawColumnName = columnName;

            if (!IsUsingEpiProject)
            {
                columnName = AddBracketsToString(columnName);
            }

            if (columnType.Equals("System.DateTime"))
            {
                DateTime lowVal = DateTime.Parse(friendlyLowValue, System.Globalization.CultureInfo.CurrentCulture);
                friendlyLowValue = lowVal.ToString("M/d/yyyy", System.Globalization.CultureInfo.InvariantCulture);

                DateTime highVal = DateTime.Parse(friendlyHighValue, System.Globalization.CultureInfo.CurrentCulture);
                friendlyHighValue = highVal.ToString("M/d/yyyy", System.Globalization.CultureInfo.InvariantCulture);
            }

            bool added = false;
            FilterCondition newCondition = DataFilters.GenerateFilterCondition(columnName, rawColumnName, columnType, friendlyOperand, friendlyLowValue, friendlyHighValue);
            DataFilters.AddFilterCondition(newCondition, joinType);

            return added;
        }






        public Field GetAssociatedField(string columnName)
        {
            Field field = null;
            foreach (DataRow fieldRow in FieldTable.Rows)
            {
                if (fieldRow["columnname"].Equals(columnName))
                {
                    if (fieldRow["epifieldtype"] is Field)
                    {
                        field = fieldRow["epifieldtype"] as Field;
                    }
                    break;
                }
            }

            return field;
        }





        public StringBuilder GenerateStandardHTMLStyle()
        {
            StringBuilder sb = new StringBuilder();
            if (dashboardControl != null)
            {
                dashboardControl.GenerateStandardHTMLStyle(sb);
            }
            return sb;
        }






        public bool AddRule(IDashboardRule rule)
        {
            return Rules.AddRule(rule);
        }





        public void RemoveDataFilterCondition(string friendlyCondition)
        {
            DataFilters.RemoveFilterCondition(friendlyCondition);
        }






        public bool IsUserDefinedColumn(string columnName)
        {
            //Input Validation
            if (string.IsNullOrEmpty(columnName))
            {
                throw new ArgumentNullException("columnName");
            }
            //

            var assignRules = LINQ.where( Rules is DataAssignmentRule && ((DataAssignmentRule)Rules).DestinationColumnName.Equals(columnName) ).select( Rules);
            if (assignRules.Count() > 0) return true;
            else return false;
        }





        public List GetFieldsAsListOfEpiTableColumns(bool sortByTabOrder = false)
        {
            List tcList = new List();

            foreach (KeyValuePair kvp in TableColumnNames)
            {
                string columnName = kvp.Key;
                string columnDataType = kvp.Value;

                if (!string.IsNullOrEmpty(columnDataType))
                {
                    GenericDbColumnType genericDbColumnType = ConvertToGenericDbColumnType(columnDataType);
                    if (!genericDbColumnType.Equals(GenericDbColumnType.Object))
                    {
                        Epi.Data.TableColumn tc = new Epi.Data.TableColumn(columnName, genericDbColumnType, true);
                        if (genericDbColumnType == GenericDbColumnType.String)
                        {
                            tc.Length = 255; 
                        }
                        tcList.Add(tc);
                    }
                }
            }

            if (sortByTabOrder && IsUsingEpiProject)
            {
                Dictionary columnNames = new Dictionary();
                int runningTabIndex = 0;

                foreach (Page page in this.View.Pages)
                {
                    SortedDictionary fieldsOnPage = new SortedDictionary();

                    foreach (Field field in page.Fields)
                    {
                        if (field is RenderableField && field is IDataField)
                        {
                            RenderableField renderableField = field as RenderableField;
                            double tabIndex = renderableField.TabIndex;
                            while (fieldsOnPage.ContainsKey(tabIndex))
                            {
                                tabIndex = tabIndex + 0.1;
                            }

                            fieldsOnPage.Add(tabIndex, field.Name);
                        }
                    }

                    foreach (KeyValuePair kvp in fieldsOnPage)
                    {
                        columnNames.Add(kvp.Value, runningTabIndex);
                        runningTabIndex++;
                    }
                }

                if (columnNames.ContainsKey("UniqueKey"))
                {
                    columnNames["UniqueKey"] = runningTabIndex + 1;
                }
                else if (columnNames.ContainsKey("UNIQUEKEY"))
                {
                    columnNames["UNIQUEKEY"] = runningTabIndex + 1;
                }
                else
                {
                    columnNames.Add("UNIQUEKEY", runningTabIndex + 1);
                }

                List tcTabOrderedList = new List();
                foreach (KeyValuePair kvp in columnNames)
                {
                    foreach (Epi.Data.TableColumn tc in tcList)
                    {
                        if (tc.Name.Equals(kvp.Key))
                        {
                            tcTabOrderedList.Add(tc);
                            break;
                        }
                    }
                }

                foreach (Epi.Data.TableColumn tc in tcList)
                {
                    if (!tcTabOrderedList.Contains(tc))
                    {
                        tcTabOrderedList.Add(tc);
                    }
                }

                tcList = tcTabOrderedList;
            }

            return tcList;
        }






        public void UpdateRule(IDashboardRule originalRule, IDashboardRule updatedRule)
        {
            this.Rules.UpdateRule(originalRule, updatedRule);
        }





        public bool RemoveRule(string friendlyRule)
        {
            IDashboardRule rule = this.Rules.GetRule(friendlyRule);

            if (rule is DataAssignmentRule)
            {
                DataAssignmentRule assignRule = rule as DataAssignmentRule;
                string destinationField = assignRule.DestinationColumnName;

                foreach (FilterCondition fc in this.DataFilters)
                {
                    if (fc.RawColumnName.Equals(destinationField))
                    {
                        return false;
                    }
                }
            }

            return this.Rules.RemoveRule(friendlyRule);
        }




        public void ClearDataFilterConditions()
        {
            DataFilters.ClearFilterConditions();
        }




        public void ClearRules()
        {
            this.Rules.ClearRules();
        }






        internal void OrderColumns(DataTable table, bool sortByTabOrder = false)
        {
            if (!sortByTabOrder || !IsUsingEpiProject)
            {
                List columnNames = new List();

                foreach (DataColumn dc in table.Columns)
                {
                    columnNames.Add(dc.ColumnName);
                }



                if (columnNames.Contains("UniqueKey"))
                {
                    columnNames.Remove("UniqueKey");
                    columnNames.Add("UniqueKey");
                }
                else if (columnNames.Contains("UNIQUEKEY"))
                {
                    columnNames.Remove("UNIQUEKEY");
                    columnNames.Add("UNIQUEKEY");
                }

                for (int i = 0; i < columnNames.Count; i++)
                {
                    string columnName = columnNames[i];
                    table.Columns[columnName].SetOrdinal(i);
                }
            }
            else if (sortByTabOrder && IsUsingEpiProject)
            {
                Dictionary columnNames = new Dictionary();
                int runningTabIndex = 0;

                foreach (Page page in this.View.Pages)
                {
                    SortedDictionary fieldsOnPage = new SortedDictionary();

                    foreach (Field field in page.Fields)
                    {
                        if (field is RenderableField && field is IDataField)
                        {
                            RenderableField renderableField = field as RenderableField;
                            double tabIndex = renderableField.TabIndex;
                            while (fieldsOnPage.ContainsKey(tabIndex))
                            {
                                tabIndex = tabIndex + 0.1;
                            }

                            fieldsOnPage.Add(tabIndex, field.Name);
                        }
                    }

                    foreach (KeyValuePair kvp in fieldsOnPage)
                    {
                        columnNames.Add(kvp.Value, runningTabIndex);
                        runningTabIndex++;
                    }
                }

                if (columnNames.ContainsKey("UniqueKey"))
                {
                    columnNames["UniqueKey"] = runningTabIndex + 1;
                }
                else if (columnNames.ContainsKey("UNIQUEKEY"))
                {
                    columnNames["UNIQUEKEY"] = runningTabIndex + 1;
                }
                else
                {
                    columnNames.Add("UNIQUEKEY", runningTabIndex + 1);
                }

                int newRunningTabIndex = 0; 
                foreach (KeyValuePair kvp in columnNames)
                {
                    if (table.Columns.Contains(kvp.Key))
                    {
                        table.Columns[kvp.Key].SetOrdinal(newRunningTabIndex);
                        newRunningTabIndex++;
                    }
                }
            }
        }





        public void ResetView(View view, bool clearEverything = true)
        {
            if (IsUsingEpiProject && System.IO.File.Exists(view.Project.FilePath))
            {
                if (this.View.Name != view.Name || this.View.Project.FilePath != view.Project.FilePath)
                {
                    this.View = view;
                    db = view.Project.CollectedData.GetDbDriver(); 
                    this.DataSet.Tables.Clear();
                    this.ConstructTableColumnNames();
                    this.dashboardControl.ReCacheDataSource(clearEverything);
                }
            }
        }





        public void SetCustomQuery(string newQuery)
        {
            if (newQuery == string.Empty)
            {
                return;
            }

            string oldQuery = this.CustomQuery;

            if (!IsUsingEpiProject)
            {
                this.CustomQuery = newQuery;
                this.DataSet.Tables.Clear();

                try
                {
                    ConstructTableColumnNames();
                    this.dashboardControl.ReCacheDataSource(false);
                }
                catch
                {
                    this.CustomQuery = oldQuery;
                    this.DataSet.Tables.Clear();
                    ConstructTableColumnNames();
                    this.dashboardControl.ReCacheDataSource();
                }
            }
        }






        public string GetColumnType(string columnName)
        {
            //Input Validation
            if (string.IsNullOrEmpty(columnName.Trim()))
            {
                throw new ArgumentNullException("columnName");
            }
            //

            string columnType = string.Empty;


            foreach (KeyValuePair kvp in TableColumnNames)
            {
                string kvpColumnName = kvp.Key.ToLower();
                if (columnName.ToLower().Equals(kvpColumnName))
                {
                    columnType = kvp.Value;
                    break;
                }
            }

            if (!string.IsNullOrEmpty(columnType))
            {
                return columnType;
            }
            else
            {
                string exMsg = string.Format(DashboardSharedStrings.ERROR_COLUMN_DOESNT_EXIST, columnName);
                throw new ApplicationException(exMsg);
            }
        }






        public DbType GetColumnDbType(string columnName)
        {
            //Input Validation
            if (string.IsNullOrEmpty(columnName.Trim()))
            {
                throw new ArgumentNullException("columnName");
            }
            //

            string type = GetColumnType(columnName);

            switch (type)
            {
                case "System.Decimal":
                    return DbType.Decimal;
                case "System.Double":
                    return DbType.Double;
                case "System.Single":
                    return DbType.Single;
                case "System.Int64":
                    return DbType.Int64;
                case "System.DateTime":
                    return DbType.DateTime;
                case "System.Int16":
                    return DbType.Int16;
                case "System.Int32":
                    return DbType.Int32;
                case "System.Boolean":
                    return DbType.Boolean;
                case "System.Byte":
                    return DbType.Byte;
                case "System.SByte":
                    return DbType.SByte;
                case "System.String":
                    return DbType.String;
                case "System.Guid":
                    return DbType.Guid;
                default:
                    throw new ApplicationException("Unknown column type.");
            }
        }






        public bool IsColumnNumeric(string columnName)
        {
            //Input Validation
            if (string.IsNullOrEmpty(columnName.Trim()))
            {
                throw new ArgumentNullException("columnName");
            }
            //

            string columnType = string.Empty;
            TableColumnNames.TryGetValue(columnName, out columnType);

            switch (columnType)
            {
                case "System.Byte":
                case "System.Int16":
                case "System.Int32":
                case "System.Int64":
                case "System.Single":
                case "System.SByte":
                case "System.Double":
                case "System.Decimal":
                    return true;
                default:
                    return false;
            }
        }






        public bool DateColumnRequiresTime(DataTable dt, string columnName)
        {
            //Input Validation
            if (dt == null)
            {
                throw new ArgumentNullException("dt");
            }
            if (string.IsNullOrEmpty(columnName))
            {
                throw new ArgumentNullException("columnName");
            }
            //

            int rowCount = dt.Rows.Count;

            if (rowCount == 0)
            {
                return true;
            }

            try
            {
                List rowIndexList = new List();
                rowIndexList.Add(0);

                if (rowCount > 1)
                {
                    rowIndexList.Add(rowCount - 1);
                }

                if (rowCount > 10)
                {
                    rowIndexList.Add(1);
                    rowIndexList.Add(2);
                    rowIndexList.Add(3);
                    rowIndexList.Add(8);
                    rowIndexList.Add(9);
                }

                if (rowCount > 20)
                {
                    rowIndexList.Add(13);
                    rowIndexList.Add(15);
                    rowIndexList.Add(17);
                }

                bool useTime = false;
                DateTime dateTime = new DateTime(2011, 10, 31, 0, 0, 0);
                string dateTimeString = dateTime.ToLongTimeString();

                foreach (int i in rowIndexList)
                {
                    if (!dt.Rows[i][columnName].ToString().EndsWith(dateTimeString))
                    {
                        useTime = true;
                        break;
                    }
                }

                return useTime;
            }
            catch
            {
                return true;
            }
        }






        public bool DoesColumnExist(string columnName)
        {
            //Input Validation
            if (string.IsNullOrEmpty(columnName.Trim()))
            {
                throw new ArgumentNullException("columnName");
            }
            //

            ColumnDataType fieldFilterOptions = ColumnDataType.Boolean | ColumnDataType.DateTime | ColumnDataType.Numeric | ColumnDataType.Text;
            return (GetFieldsAsList(fieldFilterOptions).Contains(columnName, caseInsensitiveEqualityComparer));
        }






        public bool IsColumnBoolean(string columnName)
        {
            //Input Validation
            if (string.IsNullOrEmpty(columnName.Trim()))
            {
                throw new ArgumentNullException("columnName");
            }
            //

            string columnType = string.Empty;
            TableColumnNames.TryGetValue(columnName, out columnType);

            switch (columnType)
            {
                case "System.Boolean":
                    return true;
                default:
                    return false;
            }
        }






        public bool IsColumnRecoded(string columnName)
        {
            List rules = Rules.GetRules(columnName);
            foreach (IDashboardRule rule in rules)
            {
                if (rule is Rule_Recode)
                {
                    return true;
                }
            }
            return false;
        }

        public List GetRecodedValues(string recodedColumnName)
        {
            List rules = Rules.GetRules(recodedColumnName);
            foreach (IDashboardRule rule in rules)
            {
                if (rule is Rule_Recode)
                {
                    Rule_Recode recodeRule = rule as Rule_Recode;
                    return recodeRule.GetToValues();
                }
            }
            throw new ApplicationException();
        }






        public bool IsColumnYesNo(string columnName)
        {
            //Input Validation
            if (string.IsNullOrEmpty(columnName.Trim()))
            {
                throw new ArgumentNullException("columnName");
            }
            //

            foreach (DataRow fieldRow in FieldTable.Rows)
            {
                if (fieldRow["columnname"].Equals(columnName))
                {
                    if (fieldRow["epifieldtype"] is YesNoField)
                    {
                        return true;
                    }
                }
            }

            return false;
        }






        public bool IsColumnText(string columnName)
        {
            //Input Validation
            if (string.IsNullOrEmpty(columnName.Trim()))
            {
                throw new ArgumentNullException("columnName");
            }
            //

            string columnType = string.Empty;
            TableColumnNames.TryGetValue(columnName, out columnType);

            switch (columnType)
            {
                case "System.String":
                    return true;
                default:
                    return false;
            }
        }






        public bool IsColumnDateTime(string columnName)
        {
            //Input Validation
            if (string.IsNullOrEmpty(columnName.Trim()))
            {
                throw new ArgumentNullException("columnName");
            }
            //

            string columnType = string.Empty;
            TableColumnNames.TryGetValue(columnName, out columnType);

            switch (columnType)
            {
                case "System.DateTime":
                    return true;
                default:
                    return false;
            }
        }







        public string FormatValue(string value, string columnType)
        {
            //Input Validation
            if (string.IsNullOrEmpty(columnType.Trim()))
            {
                throw new ArgumentException("columnType");
            }
            //

            switch (columnType)
            {
                case "System.DateTime":
                    value = "#" + value + "#";
                    break;
                case "System.String":
                    value = "'" + value.Replace("'", "''") + "'";
                    break;
                case "System.Single":
                case "System.Double":
                case "System.Decimal":
                    if (System.Globalization.CultureInfo.CurrentCulture.NumberFormat.NumberDecimalSeparator == ",")
                    {
                        value = value.Replace(",", ".");
                    }
                    break;
            }
            return value;
        }





        public void AddRelatedDataSource(RelatedConnection rConn)
        {
            if (rConn != null)
            {
                ConnectionsForRelate.Add(rConn);

                ds.Tables.Clear();
            }
        }





        public void AddSystemVariablesToTable(DataTable dt)
        {
            if (!dt.Columns.Contains("SYSTEMDATE"))
            {
                DataColumn systemDateColumn = new DataColumn("SYSTEMDATE", typeof(DateTime));
                systemDateColumn.DefaultValue = DateTime.Now;
                dt.Columns.Add(systemDateColumn);

                if (!TableColumnNames.ContainsKey("SYSTEMDATE"))
                {
                    TableColumnNames.Add("SYSTEMDATE", "System.DateTime");
                }

                DataRow row = FieldTable.Rows.Find("SYSTEMDATE");
                if (row == null)
                {
                    FieldTable.Rows.Add("SYSTEMDATE", "System.DateTime", null, null, null);
                }
            }
        }





        public void AddPermanentVariablesToTable(DataTable dt)
        {
            foreach (Epi.DataSets.Config.PermanentVariableRow row in Config.PermanentVariables)
            {
                string dataType = row.DataType.ToString();
                string dataValue = row.DataValue.ToString();
                string variableName = row.Name.ToString();

                if (!dataValue.ToLower().Equals("null") && !dt.Columns.Contains(variableName))
                {
                    switch (dataType)
                    {
                        case "1": // numeric
                            DataColumn numericPermanentVariableColumn = new DataColumn(variableName, typeof(decimal));
                            if (!string.IsNullOrEmpty(dataValue))
                            {
                                numericPermanentVariableColumn.DefaultValue = Convert.ToDecimal(dataValue);
                            }
                            dt.Columns.Add(numericPermanentVariableColumn);
                            break;
                        case "2": // text
                            DataColumn textPermanentVariableColumn = new DataColumn(variableName, typeof(string));
                            textPermanentVariableColumn.DefaultValue = dataValue;
                            dt.Columns.Add(textPermanentVariableColumn);
                            break;
                        case "3": // date/time
                            DataColumn datePermanentVariableColumn = new DataColumn(variableName, typeof(DateTime));
                            if (!string.IsNullOrEmpty(dataValue))
                            {
                                datePermanentVariableColumn.DefaultValue = Convert.ToDateTime(dataValue);
                            }
                            dt.Columns.Add(datePermanentVariableColumn);
                            break;
                        case "6": // boolean
                            DataColumn boolPermanentVariableColumn = new DataColumn(variableName, typeof(bool));
                            if (string.IsNullOrEmpty(dataValue))
                            {
                                boolPermanentVariableColumn.DefaultValue = null;
                            }
                            else
                            {
                                boolPermanentVariableColumn.DefaultValue = bool.Parse(dataValue);
                            }
                            dt.Columns.Add(boolPermanentVariableColumn);
                            break;
                    }
                }
            }
        }





        public List GetFieldsAsList()
        {
            List columnNames = new List();

            foreach (KeyValuePair kvp in TableColumnNames)
            {
                if (!string.IsNullOrEmpty(kvp.Value) && !kvp.Value.ToLower().StartsWith("epi"))
                {
                    columnNames.Add(kvp.Key);
                }
            }

            columnNames.Sort();
            return columnNames;
        }






        public List GetFieldsAsList(ColumnDataType fieldFilterOptions)
        {
            List columnNames = new List();

            foreach (KeyValuePair kvp in TableColumnNames)
            {
                if (kvp.Value != null)
                {
                    switch (kvp.Value.ToLower())
                    {
                        case "system.string":
                            if ((fieldFilterOptions & ColumnDataType.Text) == ColumnDataType.Text) columnNames.Add(kvp.Key);
                            break;
                        case "system.byte":
                        case "system.sbyte":
                        case "system.int16":
                        case "system.int32":
                        case "system.int64":
                        case "system.single":
                        case "system.double":
                        case "system.decimal":
                            if ((fieldFilterOptions & ColumnDataType.Numeric) == ColumnDataType.Numeric) columnNames.Add(kvp.Key);
                            break;
                        case "system.datetime":
                            if ((fieldFilterOptions & ColumnDataType.DateTime) == ColumnDataType.DateTime) columnNames.Add(kvp.Key);
                            break;
                        case "system.boolean":
                            if ((fieldFilterOptions & ColumnDataType.Boolean) == ColumnDataType.Boolean) columnNames.Add(kvp.Key);
                            break;
                    }

                    if (IsUsingEpiProject && View.Fields.Contains(kvp.Key) && View.Fields[kvp.Key] is YesNoField && ((fieldFilterOptions & ColumnDataType.Boolean) == ColumnDataType.Boolean) && !columnNames.Contains(kvp.Key))
                    {
                        columnNames.Add(kvp.Key);
                    }
                }
            }


            if ((fieldFilterOptions & ColumnDataType.UserDefined) != ColumnDataType.UserDefined)
            {
                foreach (IDashboardRule rule in Rules)
                {
                    if (rule is DataAssignmentRule)
                    {
                        DataAssignmentRule assignRule = rule as DataAssignmentRule;
                        if (columnNames.Contains(assignRule.DestinationColumnName))
                        {
                            columnNames.Remove(assignRule.DestinationColumnName);
                        }
                    }
                }
            }


            columnNames.Sort();

            return columnNames;
        }





        public List GetDefinedFieldsAsList()
        {
            List dashboardFields = new List();

            foreach (KeyValuePair kvp in Rules.GetUserDefinedVariables())
            {
                dashboardFields.Add(kvp.Key);
            }

            dashboardFields.Sort();

            return dashboardFields;
        }





        public List GetGroupFieldsAsList()
        {
            List groupFields = new List();

            if (IsUsingEpiProject)
            {
                foreach (Field field in this.View.Fields)
                {
                    if (field is GroupField)
                    {
                        groupFields.Add(field.Name);
                    }
                }
                groupFields.Sort();
            }

            return groupFields;
        }





        public List GetGroupVariablesAsList()
        {
            List groupVariables = new List();

            foreach (IDashboardRule rule in this.Rules)
            {
                if (rule is Rule_VariableGroup)
                {
                    groupVariables.Add((rule as Rule_VariableGroup).GroupName);
                }
            }

            return groupVariables;
        }





        public List GetVariablesInGroup(string groupName)
        {
            if (GetGroupVariablesAsList().Contains(groupName))
            {
                return GetGroupVariable(groupName).Variables;
            }
            else if (GetGroupFieldsAsList().Contains(groupName))
            {
                GroupField groupField = (GetAssociatedField(groupName) as GroupField);
                List names = new List();

                foreach (string name in groupField.ChildFieldNameArray.ToList())
                {
                    Field field = GetAssociatedField(name);
                    if (field is RenderableField && field is IDataField) 
                    {
                        names.Add(name);
                    }
                }

                return names;
            }

            return new List();
        }





        public Rule_VariableGroup GetGroupVariable(string groupVariableName)
        {
            foreach (IDashboardRule rule in this.Rules)
            {
                if (rule is Rule_VariableGroup && (rule as Rule_VariableGroup).GroupName.Equals(groupVariableName))
                {
                    return (rule as Rule_VariableGroup);
                }
            }
            return null;
        }





        public List GetAllGroupsAsList()
        {
            List groupNames = GetGroupFieldsAsList();
            groupNames.AddRange(GetGroupVariablesAsList());

            return groupNames;
        }






        public List GetDistinctValuesAsList(string columnName)
        {
            //Input Validation
            if (columnName == null || columnName.Length == 0)
            {
                throw new ArgumentNullException("columnName");
            }
            //

            List distinctValues = new List();

            List columnNames = new List();
            columnNames.Add(columnName);

            DataTable distinctTable = GenerateTable(columnNames).DefaultView.ToTable("DistinctTable", true, columnName);

            foreach (DataRow row in distinctTable.Rows)
            {
                distinctValues.Add(row[0].ToString());
            }

            return distinctValues;
        }




        public int GetDistinctValueCount(DataTable table, string columnName, string value)
        {
            //Input Validation
            if (columnName == null || columnName.Length == 0)
            {
                throw new ArgumentNullException("columnName");
            }
            if (table == null)
            {
                throw new ArgumentNullException("table");
            }
            //

            int count = 0;

            foreach (DataRow row in table.Rows)
            {
                if (row[columnName].ToString().Equals(value))
                {
                    count++;
                }
            }

            return count;
        }




        public bool ValueOccursMoreThanOnce(DataTable table, string columnName, string value)
        {
            //Input Validation
            if (columnName == null || columnName.Length == 0)
            {
                throw new ArgumentNullException("columnName");
            }
            if (table == null)
            {
                throw new ArgumentNullException("table");
            }
            //

            List distinctValues = new List();

            foreach (DataRow row in table.Rows)
            {
                if (row[columnName].ToString().Equals(value))
                {
                    distinctValues.Add(row[columnName].ToString());
                    if (distinctValues.Count > 1)
                    {
                        return true;
                    }
                }
            }
            return false;
        }

                DataTable JoinPageTables(View vw, bool isRelatedView = false, IGadgetParameters inputs = null)
        {
            DataTable unfilteredTable = new DataTable();


            if (vw.Fields.DataFields.Count + vw.Pages.Count + 5 < 255 && vw.Pages.Count < 15)
            {
                unfilteredTable = db.Select(db.CreateQuery("SELECT * " + vw.FromViewSQL));

                if (unfilteredTable.Columns["RecStatus"] == null && unfilteredTable.Columns["t.RecStatus"] != null)
                {
                    unfilteredTable.Columns["t.RecStatus"].ColumnName = "RecStatus";
                }

                if (unfilteredTable.Columns.Contains("t.GlobalRecordId"))
                {
                    unfilteredTable.Columns["t.GlobalRecordId"].ColumnName = "GlobalRecordId";
                }

                foreach (Page page in vw.Pages)
                {
                    string pageGUIDName = page.TableName + "." + "GlobalRecordId";
                    if (unfilteredTable.Columns.Contains(pageGUIDName))
                    {
                        unfilteredTable.Columns.Remove(pageGUIDName);
                    }
                }
            }
            else
            {
                DataTable viewTable = new DataTable();
                if (isRelatedView)
                {
                    viewTable = Database.GetTableData(vw.TableName, "GlobalRecordId");
                }
                else
                {
                    viewTable = Database.GetTableData(vw.TableName, "GlobalRecordId, UniqueKey, RECSTATUS");
                }
                viewTable.TableName = vw.TableName;

                DataTable relatedTable = new DataTable("relatedTable");

                int total = 0;

                foreach (Page page in vw.Pages)
                {
                    string pageColumnsToSelect = string.Empty;
                    foreach (Field field in page.Fields)
                    {
                        if (field is RenderableField && field is IDataField)
                        {
                            total++;
                        }
                    }
                }

                total = total * RecordCount;

                int counter = 0;

                foreach (Page page in vw.Pages)
                {
                    List pageColumnsToSelect = new List();
                    foreach (Field field in page.Fields)
                    {
                        if (field is RenderableField && field is IDataField)
                        {
                            pageColumnsToSelect.Add(field.Name);
                        }
                    }
                    pageColumnsToSelect.Add("GlobalRecordId");

                    DataTable pageTable = Database.GetTableData(page.TableName, pageColumnsToSelect);
                    pageTable.TableName = page.TableName;

                    foreach (DataColumn dc in pageTable.Columns)
                    {
                        if (dc.ColumnName != "GlobalRecordId")
                        {
                            viewTable.Columns.Add(dc.ColumnName, dc.DataType);
                        }
                    }

                    try
                    {

                        DataColumn[] parentPrimaryKeyColumns = new DataColumn[1];
                        parentPrimaryKeyColumns[0] = viewTable.Columns["GlobalRecordId"];
                        viewTable.PrimaryKey = parentPrimaryKeyColumns;
                    }
                    catch
                    {
                    }

                    foreach (DataRow row in pageTable.Rows)
                    {
                        DataRow viewRow = viewTable.Rows.Find(row["GlobalRecordId"].ToString());
                        viewRow.BeginEdit();
                        if (viewRow["GlobalRecordId"].ToString().Equals(row["GlobalRecordId"].ToString()))
                        {
                            foreach (DataColumn dc in pageTable.Columns)
                            {
                                if (dc.ColumnName == "GlobalRecordId")
                                {
                                    continue;
                                }

                                if (row[dc.ColumnName] != DBNull.Value)
                                {
                                    viewRow[dc.ColumnName] = row[dc];
                                }
                                counter++;

                                if (counter % 200 == 0 && inputs != null)
                                {
                                    if (counter > total)
                                    {
                                        counter = total;
                                    }
                                    inputs.UpdateGadgetProgress(((double)counter / (double)total) * 100);
                                    if (total == 0)
                                    {
                                        inputs.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_RELATING_PAGES_NO_PROGRESS);
                                    }
                                    else
                                    {
                                        inputs.UpdateGadgetStatus(string.Format(SharedStrings.DASHBOARD_GADGET_STATUS_RELATING_PAGES, ((double)counter / (double)total).ToString("P0")));
                                    }
                                    if (inputs.IsRequestCancelled())
                                    {
                                        return null;
                                    }
                                }
                            }
                        }
                        viewRow.EndEdit();
                    }
                }
                unfilteredTable = viewTable;
            }
            return unfilteredTable;
        }





        internal void PopulateDataSet(IGadgetParameters inputs = null)
        {
            DataTable unfilteredTable = new DataTable("unfilteredTable");
            unfilteredTable.CaseSensitive = true;

            if (inputs != null)
            {
                inputs.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_CACHING_WAIT);
            }

            lock (syncLock)
            {
                Stopwatch stopwatch = new Stopwatch();

                if (ds == null || ds.Tables.Count == 0 || (ds.Tables[0].Rows.Count == 0 && ds.Tables[0].Columns.Count == 0))
                {
                    stopwatch.Start();

                    if (inputs != null)
                    {
                        inputs.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_CACHING);
                    }

                    if (IsUsingEpiProject)
                    {
                        unfilteredTable = JoinPageTables(this.View, false, inputs);

                        if (unfilteredTable == null)
                        {
                            return; 
                        }
                    } 
                    else
                    {
                        if (string.IsNullOrEmpty(this.CustomQuery))
                        {
                            unfilteredTable = Database.GetTableData(TableName);
                        }
                        else
                        {
                            Query selectQuery = Database.CreateQuery(this.CustomQuery);
                            unfilteredTable = Database.Select(selectQuery);
                        }
                    }

                    if (ConnectionsForRelate.Count > 0)
                    {
                        foreach (RelatedConnection conn in ConnectionsForRelate)
                        {
                            DataTable relatedTable = new DataTable();
                            relatedTable.CaseSensitive = true;

                            if (conn.IsEpiInfoProject)
                            {
                                relatedTable = JoinPageTables(conn.view, true, inputs);

                                if (relatedTable == null)
                                {
                                    break; 
                                }

                                relatedTable.TableName = conn.view.TableName;
                            }
                            else
                            {
                                relatedTable = conn.db.GetTableData(conn.TableName);
                                relatedTable.TableName = conn.TableName;
                            }

                            RelateInto(unfilteredTable, relatedTable, conn.ParentKeyField, conn.ChildKeyField, conn.UseUnmatched, inputs);
                        }
                    }

                    AddSystemVariablesToTable(unfilteredTable);
                    AddPermanentVariablesToTable(unfilteredTable);
                    ds = new DataSet();
                    ds.Tables.Add(unfilteredTable); 
                    ds.Tables[0].CaseSensitive = true;
                    mainTable = ds.Tables[0];
                    stopwatch.Stop();

                    ConstructTableColumnNames();

                    if (UserVarsNeedUpdating)
                    {
                        ApplyDashboardRules(inputs);
                    }

                    //Data Prep for values with spaces (Excel only)

                    if (Database.ConnectionDescription.Contains("Excel")) // only run if it's Excel
                    {
                        List strColumnNames = GetFieldsAsList(ColumnDataType.Text);

                        foreach (DataRow row in ds.Tables[0].Rows)
                        {
                            foreach (string strColumnName in strColumnNames)
                            {
                                row[strColumnName] = row[strColumnName].ToString().Trim();
                            }
                        }
                    }
                    //

                    TimeToCache = stopwatch.Elapsed.ToString();
                    DataView tempView = new DataView(ds.Tables[0], GenerateFilterCriteria(), string.Empty, DataViewRowState.CurrentRows);
                    RecordCount = tempView.Count;
                }
                else
                {
                    if (inputs != null)
                    {
                        inputs.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_PROCESSING);
                    }
                }

                if (UserVarsNeedUpdating)
                {
                    ApplyDashboardRules(inputs);
                }

                LastCacheTime = DateTime.Now;
            }

            if (inputs != null)
            {
                inputs.UpdateGadgetStatus(SharedStrings.DASHBOARD_INSTRUCTIONS_FINISHED_CACHING);
                inputs.UpdateGadgetProgress(0);
            }
        }





        public DataTable GenerateTopTwoTable()
        {
            DataTable dt = new DataTable("toptwo");

            if (IsUsingEpiProject)
            {

                dt = Database.Select(db.CreateQuery("SELECT TOP 2 * " + View.FromViewSQL));
            }
            else
            {
                dt = Database.GetTopTwoTable(TableName);
            }

            return dt;
        }




        public DataView GenerateView(IGadgetParameters inputs = null)
        {
            string sortOrder = string.Empty;
            string filterCriteria = GenerateFilterCriteria();

            if (inputs != null)
            {
                sortOrder = inputs.CustomSortColumnName;

                if (!string.IsNullOrEmpty(inputs.CustomFilter))
                {
                    if (!string.IsNullOrEmpty(filterCriteria))
                    {
                        filterCriteria = filterCriteria + " AND " + inputs.CustomFilter;
                    }
                    else
                    {
                        filterCriteria = inputs.CustomFilter;
                    }
                }
            }

            PopulateDataSet(inputs);

            lock (syncLockView)
            {
                if (ds == null || ds.Tables.Count == 0)
                {
                    return null;
                }

                if (!string.IsNullOrEmpty(sortOrder))
                {
                    sortOrder = AddBracketsToString(sortOrder);
                }

                ds.Tables[0].CaseSensitive = true;
                ds.Tables[0].DefaultView.RowFilter = GenerateFilterCriteria();
                ds.Tables[0].DefaultView.Sort = sortOrder;

                DataView dv = ds.Tables[0].DefaultView;

                RecordCount = dv.Count;

                if (inputs != null && inputs.CustomFilter != null && inputs.CustomFilter != string.Empty)
                {
                    dv = new DataView(mainTable, filterCriteria, ds.Tables[0].DefaultView.Sort, DataViewRowState.CurrentRows);
                }
                else
                {
                    dv = new DataView(mainTable, GenerateFilterCriteria(), sortOrder, DataViewRowState.CurrentRows);
                }

                return dv;
            }
        }




        public List GenerateViews(IGadgetParameters inputs = null)
        {
            List dataViews = new List();
            if (inputs.StrataVariableNames.Count == 0)
            {
                dataViews.Add(GenerateView(inputs));
            }
            else
            {
                List stratas = new List();
                DataTable distinctTable = new DataTable();
                DataTable sortedDistinctTable = new DataTable();
                stratas = GetStrataValuesAsDictionary(inputs.StrataVariableNames, false, false);
                foreach (Strata strata in stratas)
                {
                    IGadgetParameters parameters = new GadgetParameters(inputs);
                    if (string.IsNullOrEmpty(parameters.CustomFilter))
                    {
                        parameters.CustomFilter = strata.SafeFilter;
                    }
                    else
                    {
                        parameters.CustomFilter = parameters.CustomFilter + " AND " + strata.SafeFilter;
                    }
                    DataView dv = GenerateView(parameters);
                    dv.Table.TableName = strata.Filter;
                    dataViews.Add(dv);
                }
            }

            return dataViews;
        }






        public DataTable GenerateTable(IGadgetParameters inputs = null)
        {
            List columnNames = new List();

            if (inputs != null)
            {
                columnNames.AddRange(inputs.ColumnNames);

                if (inputs is GadgetParameters)
                {
                    GadgetParameters gadgetParameters = inputs as GadgetParameters;
                    if (!columnNames.Contains(gadgetParameters.MainVariableName, caseInsensitiveEqualityComparer) && !string.IsNullOrEmpty(gadgetParameters.MainVariableName.Trim()))
                    {
                        columnNames.Add(gadgetParameters.MainVariableName);
                    }
                    if (!columnNames.Contains(gadgetParameters.CrosstabVariableName, caseInsensitiveEqualityComparer) && !string.IsNullOrEmpty(gadgetParameters.CrosstabVariableName.Trim()))
                    {
                        columnNames.Add(gadgetParameters.CrosstabVariableName);
                    }
                    if (!columnNames.Contains(gadgetParameters.WeightVariableName, caseInsensitiveEqualityComparer) && !string.IsNullOrEmpty(gadgetParameters.WeightVariableName.Trim()))
                    {
                        columnNames.Add(gadgetParameters.WeightVariableName);
                    }
                }

                foreach (string strataVariableName in inputs.StrataVariableNames)
                {
                    if (!columnNames.Contains(strataVariableName, caseInsensitiveEqualityComparer) && !string.IsNullOrEmpty(strataVariableName.Trim()))
                    {
                        columnNames.Add(strataVariableName);
                    }
                }
            }

            AddSupplementaryColumnNames(columnNames);
            return GenerateView(inputs).ToTable("output", false, columnNames.ToArray());
        }







        public DataTable GenerateTable(List columnNames, string customFilter = "")
        {
            //Input Validation
            if (columnNames.Count == 0)
            {
                throw new ApplicationException(SharedStrings.NO_COLUMNS_FOR_SELECT_QUERY);
            }
            //

            GadgetParameters inputs = new GadgetParameters();
            inputs.MainVariableName = string.Empty;
            inputs.MainVariableNames = new List();
            inputs.ColumnNames = columnNames;
            inputs.CustomFilter = customFilter;
            inputs.CustomSortColumnName = string.Empty;
            inputs.StrataVariableNames = new List();
            inputs.InputVariableList = new Dictionary();

            string columnsToSelect = string.Empty;

            AddSupplementaryColumnNames(columnNames);

            return GenerateView(inputs).ToTable("output", false, columnNames.ToArray());
        }







        public DataTable GenerateCombinedFrequencyTable(CombinedFrequencyParameters inputs, ref bool booleanOutput, ref int fields)
        {
            //Input Validation
            if (inputs == null)
            {
                throw new ArgumentNullException("inputs");
            }
            if (inputs.ColumnNames.Count == 0)
            {
                throw new ArgumentNullException("inputs.ColumnNames");
            }
            //


            bool includeMissing = inputs.IncludeMissing;
            bool sortHighToLow = inputs.SortHighToLow;
            booleanOutput = false;
            string trueValue = string.Empty;


            List fieldNames = new List();

            foreach (string listFieldName in inputs.ColumnNames)
            {
                if (!fieldNames.Contains(listFieldName))
                {
                    if (IsUsingEpiProject && GetGroupFieldsAsList().Contains(listFieldName, caseInsensitiveEqualityComparer))
                    {

                        foreach (Field field in this.View.Fields)
                        {
                            if (field is GroupField && field.Name.Equals(listFieldName))
                            {
                                GroupField groupField = field as GroupField;
                                foreach (string s in groupField.ChildFieldNameArray)
                                {
                                    if (!fieldNames.Contains(listFieldName))
                                    {
                                        fieldNames.Add(s);
                                    }
                                }
                                break;
                            }
                        }
                    }
                    else if (GetGroupVariablesAsList().Contains(listFieldName, caseInsensitiveEqualityComparer))
                    {

                        foreach (string columnName in GetGroupVariable(listFieldName).Variables)
                        {
                            if (!fieldNames.Contains(listFieldName))
                            {
                                fieldNames.Add(columnName);
                            }
                        }
                    }
                    else if (IsUsingEpiProject && listFieldName.ToLower().StartsWith("page "))
                    {

                        int pageNumber = -1;

                        string strPageNumber = listFieldName.Remove(0, 5);

                        int.TryParse(strPageNumber, out pageNumber);

                        if (pageNumber < 0)
                        {
                            continue;
                        }

                        pageNumber--;
                        Page page = this.View.Pages[pageNumber];

                        foreach (Field field in page.Fields)
                        {
                            if (field is IDataField && field is RenderableField && !(field is GroupField) && !(field is GridField) && !(field is MirrorField))
                            {
                                if (!fieldNames.Contains(listFieldName))
                                {
                                    fieldNames.Add(field.Name);
                                }
                            }
                        }
                    }
                    else
                    {

                        if (!fieldNames.Contains(listFieldName))
                        {
                            fieldNames.Add(listFieldName);
                        }
                    }
                }
            }

            fields = fieldNames.Count;










            trueValue = inputs.TrueValue;
            CombineModeTypes combineMode = inputs.CombineMode;











            DataView dv = GenerateView();

            if (dv == null || dv.Count == 0 || mainTable == null || mainTable.Rows.Count == 0)
            {
                return null;
            }

            DataTable combinedFrequencyTable = new DataTable();

            DataColumn col1 = new DataColumn("value", typeof(string));
            DataColumn col2 = new DataColumn("count", typeof(int));

            combinedFrequencyTable.Columns.Add(col1);
            combinedFrequencyTable.Columns.Add(col2);

            List booleanFields = new List();
            List numericFields = new List();
            List otherFields = new List();

            foreach (string s in fieldNames)
            {
                if (IsColumnBoolean(s) || IsColumnYesNo(s))
                {
                    booleanFields.Add(s);
                }
                else if (IsColumnText(s))
                {
                    otherFields.Add(s);
                }
                else if (IsColumnNumeric(s))
                {
                    numericFields.Add(s);
                }
            }

            DataView cmbDv = new DataView(mainTable, "", "", DataViewRowState.CurrentRows);
            cmbDv.RowFilter = ds.Tables[0].DefaultView.RowFilter;
            if (!string.IsNullOrEmpty(inputs.CustomFilter))
            {
                cmbDv.RowFilter = CombineFilters(inputs.CustomFilter);
            }

            string originalFilter = cmbDv.RowFilter;

            if (booleanFields.Count == 0 && otherFields.Count > 0 && otherFields.Count > numericFields.Count)
            {
                if (combineMode == CombineModeTypes.Automatic || combineMode == CombineModeTypes.Categorical)
                {
                    List values = new List();

                    foreach (string otherField in otherFields)
                    {
                        List fieldValues = GetDistinctValuesAsList(otherField);
                        foreach (string s in fieldValues)
                        {
                            if (!values.Contains(s))
                            {
                                values.Add(s);
                            }
                        }
                    }

                    if (values.Contains(""))
                    {
                        values.Remove("");
                        if (includeMissing)
                        {
                            values.Add("");
                        }
                    }

                    if (values.Count == 0)
                    {
                        throw new ApplicationException(DashboardSharedStrings.ERROR_ZERO_VALUES_COMBINED_FREQ);
                    }
                    else if (values.Count > Combined_Frequency_Row_Limit)
                    {
                        string exMsg = string.Format(DashboardSharedStrings.ERROR_TOO_MANY_VALUES_COMBINED_FREQ_EXT, values.Count, Combined_Frequency_Row_Limit);
                        throw new ApplicationException(exMsg);
                    }

                    for (int i = 0; i < values.Count; i++)
                    {
                        combinedFrequencyTable.Rows.Add(values[i], 0);
                    }

                    foreach (string otherField in otherFields)
                    {
                        for (int i = 0; i < values.Count; i++)
                        {
                            cmbDv.RowFilter = originalFilter;
                            string value = values[i];
                            double sum = 0;
                            if (string.IsNullOrEmpty(value))
                            {
                                cmbDv.RowFilter = CombineFilters(AddBracketsToString(otherField) + " is null", cmbDv);
                                sum = cmbDv.Count;
                            }
                            else
                            {
                                cmbDv.RowFilter = CombineFilters(AddBracketsToString(otherField) + " = '" + value.Replace("'", "''") + "'", cmbDv);
                                sum = cmbDv.Count;
                            }
                            combinedFrequencyTable.Rows[i][1] = (int)combinedFrequencyTable.Rows[i][1] + (int)sum;
                        }
                    }
                }
                else if (combineMode == CombineModeTypes.Boolean)
                {
                    foreach (string otherField in otherFields)
                    {
                        cmbDv.RowFilter = originalFilter;

                        cmbDv.RowFilter = CombineFilters(AddBracketsToString(otherField) + " = '" + trueValue.Replace("'", "''") + "'" , cmbDv);
                        double sum = cmbDv.Count;

                        Field field = GetAssociatedField(otherField);
                        if (field != null && field is CheckBoxField)
                        {
                            combinedFrequencyTable.Rows.Add((field as CheckBoxField).PromptText, (int)sum);
                        }
                        else
                        {
                            combinedFrequencyTable.Rows.Add(otherField, (int)sum);
                        }
                    }
                    booleanOutput = true;
                }
            }
            else if(booleanFields.Count > 0)
            {
                foreach (string booleanField in booleanFields)
                {
                    cmbDv.RowFilter = originalFilter;

                    cmbDv.RowFilter = CombineFilters(AddBracketsToString(booleanField) + " = true", cmbDv);
                    double sum = cmbDv.Count;

                    Field field = GetAssociatedField(booleanField);
                    if (field != null && field is CheckBoxField)
                    {
                        combinedFrequencyTable.Rows.Add((field as CheckBoxField).PromptText, (int)sum);
                    }
                    else
                    {
                        combinedFrequencyTable.Rows.Add(booleanField, (int)sum);
                    }
                }
                booleanOutput = true;
            }
            else if (numericFields.Count > 0)
            {
                if (combineMode == CombineModeTypes.Boolean)
                {
                    foreach (string numberField in numericFields)
                    {
                        cmbDv.RowFilter = originalFilter;

                        cmbDv.RowFilter = CombineFilters(AddBracketsToString(numberField) + " = " + trueValue, cmbDv);
                        double sum = cmbDv.Count;

                        Field field = GetAssociatedField(numberField);
                        if (field != null && field is NumberField)
                        {
                            combinedFrequencyTable.Rows.Add((field as NumberField).PromptText, (int)sum);
                        }
                        else
                        {
                            combinedFrequencyTable.Rows.Add(numberField, (int)sum);
                        }
                    }
                    booleanOutput = true;
                }
                else
                {
                    List values = new List();
                    foreach (string numberField in numericFields)
                    {
                        List fieldValues = GetDistinctValuesAsList(numberField);
                        foreach (string s in fieldValues)
                        {
                            if (!values.Contains(s))
                            {
                                values.Add(s);
                            }
                        }
                    }

                    if (values.Contains(""))
                    {
                        values.Remove("");
                        if (includeMissing)
                        {
                            values.Add("");
                        }
                    }

                    if (values.Count == 0)
                    {
                        throw new ApplicationException(DashboardSharedStrings.ERROR_ZERO_VALUES_COMBINED_FREQ);
                    }
                    else if (values.Count > Combined_Frequency_Row_Limit)
                    {
                        string exMsg = string.Format(DashboardSharedStrings.ERROR_TOO_MANY_VALUES_COMBINED_FREQ_EXT, values.Count, Combined_Frequency_Row_Limit);
                        throw new ApplicationException(exMsg);
                    }

                    for (int i = 0; i < values.Count; i++)
                    {
                        combinedFrequencyTable.Rows.Add(values[i], 0);
                    }

                    foreach (string numberField in numericFields)
                    {
                        for (int i = 0; i < values.Count; i++)
                        {
                            cmbDv.RowFilter = originalFilter;

                            string value = values[i];
                            double sum = 0;
                            if (string.IsNullOrEmpty(value))
                            {
                                cmbDv.RowFilter = CombineFilters(AddBracketsToString(numberField) + " is null", cmbDv);
                                sum = cmbDv.Count;
                            }
                            else
                            {
                                cmbDv.RowFilter = CombineFilters(AddBracketsToString(numberField) + " = " + value + "", cmbDv);
                                sum = cmbDv.Count;
                            }
                            combinedFrequencyTable.Rows[i][1] = (int)combinedFrequencyTable.Rows[i][1] + (int)sum;
                        }
                    }
                }
            }

            if (combinedFrequencyTable == null || combinedFrequencyTable.Rows.Count == 0)
            {
                throw new ApplicationException(DashboardSharedStrings.ERROR_ZERO_VALUES_COMBINED_FREQ_EXT);
            }

            if (sortHighToLow)
            {
                combinedFrequencyTable = SortHighToLow(combinedFrequencyTable, combinedFrequencyTable.Columns["count"]);
            }

            foreach (DataRow row in combinedFrequencyTable.Rows)
            {
                if (string.IsNullOrEmpty(row[0].ToString()))
                {
                    row[0] = this.Config.Settings.RepresentationOfMissing;
                    break;
                }
            }

            return combinedFrequencyTable;
        }































































































        public List GenerateLineList(LineListParameters parameters)
        {
            parameters.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_CREATING_VARIABLES);

            List columnsToSelect = new List();
            List originalColumnsToSelect = new List();

            string sortOrder = string.Empty;

            if (!String.IsNullOrEmpty(parameters.PrimaryGroupField))
            {
                columnsToSelect.Add(parameters.PrimaryGroupField);
                originalColumnsToSelect.Add(parameters.PrimaryGroupField);
            }
            if (!String.IsNullOrEmpty(parameters.SecondaryGroupField))
            {
                columnsToSelect.Add(parameters.SecondaryGroupField);
                originalColumnsToSelect.Add(parameters.SecondaryGroupField);
            }

            foreach (string listFieldName in parameters.ColumnNames)
            {
                if (!columnsToSelect.Contains(listFieldName))
                {
                    if (IsUsingEpiProject && GetGroupFieldsAsList().Contains(listFieldName, caseInsensitiveEqualityComparer))
                    {

                        foreach (Field field in this.View.Fields)
                        {
                            if (field is GroupField && field.Name.Equals(listFieldName))
                            {
                                GroupField groupField = field as GroupField;
                                foreach (string s in groupField.ChildFieldNameArray)
                                {
                                    if (!columnsToSelect.Contains(listFieldName))
                                    {
                                        columnsToSelect.Add(s);
                                        originalColumnsToSelect.Add(s);
                                    }
                                }
                                break;
                            }
                        }
                    }
                    else if (GetGroupVariablesAsList().Contains(listFieldName, caseInsensitiveEqualityComparer))
                    {

                        foreach (string columnName in GetGroupVariable(listFieldName).Variables)
                        {
                            if (!columnsToSelect.Contains(listFieldName))
                            {
                                columnsToSelect.Add(columnName);
                                originalColumnsToSelect.Add(columnName);
                            }
                        }
                    }
                    else if (IsUsingEpiProject && listFieldName.ToLower().StartsWith("page "))
                    {

                        int pageNumber = -1;

                        string strPageNumber = listFieldName.Remove(0, 5);

                        int.TryParse(strPageNumber, out pageNumber);

                        if (pageNumber < 0)
                        {
                            continue;
                        }

                        pageNumber--;
                        Page page = this.View.Pages[pageNumber];

                        foreach (Field field in page.Fields)
                        {
                            if (field is IDataField && field is RenderableField && !(field is GroupField) && !(field is GridField) && !(field is MirrorField))
                            {
                                if (!columnsToSelect.Contains(listFieldName))
                                {
                                    columnsToSelect.Add(field.Name);
                                    originalColumnsToSelect.Add(field.Name);
                                }
                            }
                        }
                    }
                    else
                    {

                        if (!columnsToSelect.Contains(listFieldName))
                        {
                            columnsToSelect.Add(listFieldName);
                            originalColumnsToSelect.Add(listFieldName);
                        }
                    }
                }
            }














































































            foreach(KeyValuePair kvp in parameters.SortVariables)
            {
                string sortFieldName = kvp.Key;

                switch (kvp.Value)
                {
                    case SortOrder.Ascending:
                        sortOrder = sortOrder + sortFieldName + " ASC,";
                        break;
                    case SortOrder.Descending:
                        sortOrder = sortOrder + sortFieldName + " DESC,";
                        break;
                }

                if (!columnsToSelect.Contains(sortFieldName))
                {
                    columnsToSelect.Add(sortFieldName);
                }
            }

            foreach (FilterCondition condition in this.DataFilters)
            {
                if (!columnsToSelect.Contains(condition.RawColumnName))
                {
                    columnsToSelect.Add(condition.RawColumnName);
                }
            }

            sortOrder = sortOrder.TrimEnd(',');
            parameters.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_GENERATING_TABLE);

            PopulateDataSet(parameters);

            DataView dv = GenerateView(parameters);

            DataView dvAllRows = new DataView(mainTable);
            dvAllRows.RowFilter = mainTable.DefaultView.RowFilter;
            if (!string.IsNullOrEmpty(parameters.CustomFilter))
            {
                dvAllRows.RowFilter = CombineFilters(parameters.CustomFilter, dvAllRows);
            }
            dvAllRows.Sort = sortOrder;

            RecordCount = mainTable.DefaultView.Count;


            //if (false                                                                               )
























































































































            DataTable dt = dvAllRows.ToTable();

            List columnsToRemove = new List();

            foreach (DataColumn column in dt.Columns)
            {
                bool found = false;

                foreach (string s in originalColumnsToSelect)
                {
                    if (column.ColumnName.ToLower().Equals(s.ToLower()))
                    {
                        found = true;
                    }
                }

                if (!found)
                {
                    columnsToRemove.Add(column);
                }
            }

            foreach (DataColumn dc in columnsToRemove)
            {
                dt.Columns.Remove(dc);
            }

            OrderColumns(dt, parameters.SortColumnsByTabOrder);

            if (parameters.ShowCommentLegalLabels)
            {
                AddOptionLabelsToListTable(dt);
                AddCommentLegalLabelsToListTable(dt);
            }

            List tables = new List();
            ConvertLineListData(dt);
            tables.Add(dt);

            return tables;

        }





                void ConvertLineListData(DataTable dt)
        {
            Dictionary dictionary = new Dictionary();
            List columnsToAdd = new List();
            List columnsToRemove = new List();

            foreach (DataColumn dc in dt.Columns)
            {
                Field field = GetAssociatedField(dc.ColumnName);
                if (field != null && (field is YesNoField || field is CheckBoxField))
                {
                    DataColumn newDc = new DataColumn(dc.ColumnName + "___1234_ACD_PLX", typeof(string));
                    columnsToAdd.Add(newDc);
                    columnsToRemove.Add(dc);
                    dictionary.Add(newDc, dc);
                }
            }

            foreach (DataColumn dc in columnsToAdd)
            {
                dt.Columns.Add(dc);
            }

            foreach (DataRow row in dt.Rows)
            {
                foreach (KeyValuePair kvp in dictionary)
                {
                    DataColumn newDc = kvp.Key;
                    DataColumn oldDc = kvp.Value;

                    if (row[oldDc].ToString() == "1" || row[oldDc].ToString().ToLower() == "true")
                    {
                        row[newDc] = Config.Settings.RepresentationOfYes;
                    }
                    else if (row[oldDc].ToString() == "0" || row[oldDc].ToString().ToLower() == "false")
                    {
                        row[newDc] = Config.Settings.RepresentationOfNo;
                    }
                }
            }

            foreach (KeyValuePair kvp in dictionary)
            {
                dt.Columns.Remove(kvp.Value);
                kvp.Key.ColumnName = kvp.Key.ColumnName.Replace("___1234_ACD_PLX", String.Empty);
            }
        }






        public List GenerateDeduplicationList(DuplicatesListParameters parameters)
        {

            parameters.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_CREATING_VARIABLES);

            List columnsToSelect = new List();
            List originalColumnsToSelect = new List();

            string sortOrder = string.Empty;


            if (parameters.StrataVariableNames != null && parameters.StrataVariableNames.Count > 0)
            {
                if (!columnsToSelect.Contains(parameters.StrataVariableNames[0]))
                {
                    columnsToSelect.Add(parameters.StrataVariableNames[0]);
                }
            }


            foreach (string listFieldName in parameters.ColumnNames)
            {

                if (!columnsToSelect.Contains(listFieldName))
                {
                    if (IsUsingEpiProject && GetGroupFieldsAsList().Contains(listFieldName, caseInsensitiveEqualityComparer))
                    {

                        foreach (Field field in this.View.Fields)
                        {
                            if (field is GroupField && field.Name.Equals(listFieldName))
                            {
                                GroupField groupField = field as GroupField;
                                foreach (string s in groupField.ChildFieldNameArray)
                                {
                                    if (!columnsToSelect.Contains(listFieldName))
                                    {
                                        columnsToSelect.Add(s);
                                        originalColumnsToSelect.Add(s);
                                    }
                                }
                                break;
                            }
                        }
                    }
                    else if (GetGroupVariablesAsList().Contains(listFieldName, caseInsensitiveEqualityComparer))
                    {

                        foreach (string columnName in GetGroupVariable(listFieldName).Variables)
                        {
                            if (!columnsToSelect.Contains(listFieldName))
                            {
                                columnsToSelect.Add(columnName);
                                originalColumnsToSelect.Add(columnName);
                            }
                        }
                    }
                    else if (IsUsingEpiProject && listFieldName.ToLower().StartsWith("page "))
                    {

                        int pageNumber = -1;

                        string strPageNumber = listFieldName.Remove(0, 5);

                        int.TryParse(strPageNumber, out pageNumber);

                        if (pageNumber < 0)
                        {
                            continue;
                        }

                        pageNumber--;
                        Page page = this.View.Pages[pageNumber];

                        foreach (Field field in page.Fields)
                        {
                            if (field is IDataField && field is RenderableField && !(field is GroupField) && !(field is GridField) && !(field is MirrorField))
                            {
                                if (!columnsToSelect.Contains(listFieldName))
                                {
                                    columnsToSelect.Add(field.Name);
                                    originalColumnsToSelect.Add(field.Name);
                                }
                            }
                        }
                    }
                    else
                    {

                        if (!columnsToSelect.Contains(listFieldName))
                        {
                            columnsToSelect.Add(listFieldName);
                            originalColumnsToSelect.Add(listFieldName);
                        }
                    }
                }
            }



























            foreach (FilterCondition condition in this.DataFilters)
            {
                if (!columnsToSelect.Contains(condition.RawColumnName))
                {
                    columnsToSelect.Add(condition.RawColumnName);
                }
            }






            sortOrder = sortOrder.TrimEnd(',');
            parameters.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_GENERATING_TABLE);

            PopulateDataSet(parameters);

            DataView dv = GenerateView(parameters);

            DataView dvAllRows = new DataView(mainTable);
            dvAllRows.RowFilter = mainTable.DefaultView.RowFilter;
            if (!string.IsNullOrEmpty(parameters.CustomFilter))
            {
                dvAllRows.RowFilter = CombineFilters(parameters.CustomFilter, dvAllRows);
            }
            dvAllRows.Sort = sortOrder;

            RecordCount = mainTable.DefaultView.Count;


            if (parameters.StrataVariableNames != null && parameters.StrataVariableNames.Count > 0)
            {
                List tables = new List();
                List strataValues = new List();
                string strataVariableName = parameters.StrataVariableNames[0];

                parameters.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_FINDING_STRATA_VALUES);
                for (int i = 0; i < dvAllRows.Count; i++)
                {
                    DataRow dataRow = dvAllRows[i].Row;
                    string strataValue = dataRow[strataVariableName].ToString().Trim();
                    if (!strataValues.Contains(strataValue, caseInsensitiveEqualityComparer))
                    {
                        strataValues.Add(strataValue);
                    }
                }

                foreach (string strataValue in strataValues)
                {
                    DataView strataDv = new DataView(mainTable);
                    strataDv.Sort = dvAllRows.Sort;
                    strataDv.RowFilter = dvAllRows.RowFilter;

                    DataTable dt = new DataTable();

                    string strataFilter = string.Empty;
                    string fullFilter = string.Empty;

                    if (!string.IsNullOrEmpty(strataValue))
                    {
                        string columnType = GetColumnType(strataVariableName);
                        strataFilter = StringLiterals.LEFT_SQUARE_BRACKET + strataVariableName + StringLiterals.RIGHT_SQUARE_BRACKET + StringLiterals.SPACE + StringLiterals.EQUAL + StringLiterals.SPACE + FormatValue(strataValue, columnType);
                    }
                    else
                    {
                        strataFilter = StringLiterals.LEFT_SQUARE_BRACKET + strataVariableName + StringLiterals.RIGHT_SQUARE_BRACKET + StringLiterals.SPACE + " is null";
                    }

                    if (!string.IsNullOrEmpty(dvAllRows.RowFilter))
                    {
                        fullFilter = CombineFilters(strataFilter, dvAllRows);
                    }
                    else
                    {
                        fullFilter = strataFilter;
                    }

                    strataDv.RowFilter = fullFilter;

                    try
                    {
                        dt = strataDv.ToTable(mainTable.TableName);
                    }
                    catch (InvalidOperationException)
                    {
                        continue;
                    }

                    List columnsToRemove = new List();

                    foreach (DataColumn column in dt.Columns)
                    {
                        bool found = false;

                        foreach (string s in originalColumnsToSelect)
                        {
                            if (column.ColumnName.ToLower().Equals(s.ToLower()))
                            {
                                found = true;
                            }
                        }

                        if (!found)
                        {
                            columnsToRemove.Add(column);
                        }
                    }

                    foreach (DataColumn dc in columnsToRemove)
                    {
                        dt.Columns.Remove(dc);
                    }

                    if (IsColumnYesNo(strataVariableName))
                    {
                        if (strataFilter.EndsWith("1"))
                        {
                            strataFilter = strataFilter.Substring(0, strataFilter.Length - 1) + Config.Settings.RepresentationOfYes;
                        }
                        else if (strataFilter.EndsWith("0"))
                        {
                            strataFilter = strataFilter.Substring(0, strataFilter.Length - 1) + Config.Settings.RepresentationOfNo;
                        }
                    }
                    else if (IsColumnBoolean(strataVariableName))
                    {
                        if (strataFilter.EndsWith("True"))
                        {
                            strataFilter = strataFilter.Substring(0, strataFilter.Length - 4) + Config.Settings.RepresentationOfYes;
                        }
                        else if (strataFilter.EndsWith("False"))
                        {
                            strataFilter = strataFilter.Substring(0, strataFilter.Length - 5) + Config.Settings.RepresentationOfNo;
                        }
                    }

                    if (GetAssociatedField(strataVariableName) != null)
                    {
                        strataFilter = strataFilter.Replace("]", "").Replace("[", "");
                    }

                    dt.TableName = strataFilter;

                    tables.Add(dt);
                }

                return tables;
            }

            else
            {
                DataTable dt = dvAllRows.ToTable();

                List columnsToRemove = new List();

                foreach (DataColumn column in dt.Columns)
                {
                    bool found = false;

                    foreach (string s in originalColumnsToSelect)
                    {
                        if (column.ColumnName.ToLower().Equals(s.ToLower()))
                        {
                            found = true;
                        }
                    }

                    if (!found)
                    {
                        columnsToRemove.Add(column);
                    }
                }

                foreach (DataColumn dc in columnsToRemove)
                {
                    dt.Columns.Remove(dc);
                }

                bool sortByTabOrder = false;
                if (parameters.InputVariableList.ContainsKey("sortcolumnsbytaborder"))
                {
                    sortByTabOrder = bool.Parse(parameters.InputVariableList["sortcolumnsbytaborder"]);
                    OrderColumns(dt, sortByTabOrder);
                }

                if (parameters.ShowCommentLegalLabels)
                {
                    AddOptionLabelsToListTable(dt);
                    AddCommentLegalLabelsToListTable(dt);
                }

                List tables = new List();
                tables.Add(dt);

                return tables;
            }
        }







                string CombineFilters(string additionalFilter, DataView dv = null)
        {
            string rowFilter = ds.Tables[0].DefaultView.RowFilter;

            if (dv != null)
            {
                rowFilter = dv.RowFilter;
            }

            if (string.IsNullOrEmpty(rowFilter))
            {
                return additionalFilter;
            }
            else
            {
                return "(" + rowFilter + ")" + " and (" + additionalFilter + ")";
            }
        }






        public Dictionary GenerateFrequencyTable(IGadgetParameters parameters)
        {





            //Input Validation
            if (parameters == null)
            {
                throw new ArgumentNullException("inputs");
            }
            if (parameters.ColumnNames.Count == 0)
            {
                throw new ArgumentNullException("parameters.ColumnNames.Count");
            }
            if (string.IsNullOrEmpty(parameters.ColumnNames[0]))
            {
                throw new ArgumentNullException("parameters.ColumnNames[0]");
            }
            //

            FrequencyParametersBase inputs = parameters as FrequencyParametersBase;

            string freqVar = inputs.ColumnNames[0];
            string crosstabVar = inputs.CrosstabVariableName;
            string weightVar = inputs.WeightVariableName;
            bool includeMissing = inputs.IncludeMissing;
            bool sortHighToLow = inputs.SortHighToLow;
            bool useAllPossibleValues = inputs.ShowAllListValues;
            bool includeFullSummaryStatistics = inputs.IncludeFullSummaryStatistics;
            bool needsOutputTable = true;
            bool useFieldPrompts = false;
            bool isAberrationRoutine = false;
            int timePeriod = int.MaxValue;
            List strataVars = inputs.StrataVariableNames;

            if (inputs.InputVariableList.ContainsKey("aberration") && inputs.InputVariableList["aberration"].Equals("true"))
            {
                isAberrationRoutine = true;
            }

            if (inputs.InputVariableList.ContainsKey("usepromptforfield"))
            {
                if (inputs.InputVariableList["usepromptforfield"] == "true") useFieldPrompts = true;
            }

            if(inputs.InputVariableList.ContainsKey("NeedsOutputGrid"))
            {
                if (inputs.InputVariableList["NeedsOutputGrid"] == "false") needsOutputTable = false;
            }

            if (inputs.InputVariableList.ContainsKey("timeperiod"))
            {
                int.TryParse(inputs.InputVariableList["timeperiod"], out timePeriod);
            }

            inputs.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_CREATING_VARIABLES);

            bool doStratification = true;
            bool doCrossTab = true;
            bool doMeans = false;
            bool valuesAreBool = false;

            List columnNames = new List();
            if (IsUserDefinedColumn(freqVar) == false)
            {
                columnNames.Add(freqVar);
            }

            if (strataVars == null || strataVars.Count == 0)
            {
                doStratification = false;
            }
            else
            {
                foreach (string str in strataVars)
                {
                    if (IsUserDefinedColumn(str) == false)
                    {
                        columnNames.Add(str);
                    }
                }
            }

            if (string.IsNullOrEmpty(crosstabVar.Trim()))
            {
                doCrossTab = false;
            }
            else if (IsUserDefinedColumn(crosstabVar) == false)
            {
                columnNames.Add(crosstabVar);
            }

            if (!string.IsNullOrEmpty(weightVar) && IsUserDefinedColumn(weightVar) == false)
            {
                columnNames.Add(weightVar);
            }

            if (inputs.Worker != null && inputs.Worker.CancellationPending == true)
            {
                return null;
            }

            if (!string.IsNullOrEmpty(inputs.CustomFilter))
            {
                ColumnDataType columnDataType = ColumnDataType.Boolean | ColumnDataType.Numeric | ColumnDataType.Text | ColumnDataType.UserDefined;
                List dataColumnNames = GetFieldsAsList(columnDataType);
                foreach (string name in dataColumnNames)
                {
                    if (inputs.CustomFilter.ToLower().Contains(name.ToLower()) && !columnNames.Contains(name, caseInsensitiveEqualityComparer))
                    {
                        columnNames.Add(name);
                    }
                }
            }

            Dictionary stratifiedFrequencyTables = new Dictionary();

            inputs.CustomSortColumnName = freqVar;
            foreach (IDashboardRule rule in this.Rules)
            {
                if (rule is Rule_Format && (((Rule_Format)rule).FormatType.Equals(FormatTypes.RegularDate) || ((Rule_Format)rule).FormatType.Equals(FormatTypes.LongDate) || ((Rule_Format)rule).FormatType.Equals(FormatTypes.MonthAndFourDigitYear)) && ((Rule_Format)rule).DestinationColumnName.Equals(freqVar))
                {
                    inputs.CustomSortColumnName = ((Rule_Format)rule).SourceColumnName;
                    break;
                }
            }

            foreach (string columnName in columnNames)
            {
                if (!inputs.ColumnNames.Contains(columnName))
                {
                    inputs.ColumnNames.Add(columnName);
                }
            }

            inputs.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_GENERATING_TABLE);
            DataView dv = GenerateView(inputs);

            DateTime  minDate = null;

            if (isAberrationRoutine)
            {
                try
                {
                    DateTime  maxDate = null;
                    FindUpperLowerDateValues(freqVar, ref minDate, ref maxDate, dv);

                    DateTime dt1 = minDate.Value;
                    DateTime dt2 = maxDate.Value;

                    string dts1 = dt1.ToShortDateString();
                    string dts2 = dt2.ToShortDateString();

                    if (minDate.HasValue && maxDate.HasValue)
                    {
                        minDate = maxDate.Value.AddDays(-(timePeriod - 1));

                        dt1 = minDate.Value;
                        dts1 = dt1.ToShortDateString();
                    }
                }
                catch
                {
                    minDate = DateTime.MinValue;
                }

                dv.RowFilter = CombineFilters(AddBracketsToString(freqVar) + " >= " + FormatValue(minDate.Value.ToShortDateString(), "System.DateTime"), dv);
            }

            if (!minDate.HasValue)
            {
                isAberrationRoutine = false;
            }

            int overallRecordCount = 0;

            if (dv != null && dv.Count > 0)
            {
                overallRecordCount = dv.Count;
            }
            else
            {
                return stratifiedFrequencyTables;
            }

            string columnType = string.Empty;
            if (mainTable.Columns[freqVar] != null)
            {
                columnType = mainTable.Columns[freqVar].DataType.ToString();
            }
            else
            {
                return stratifiedFrequencyTables;
            }

            string crosstabColumnType = string.Empty;
            if (mainTable.Columns[crosstabVar] != null)
            {
                crosstabColumnType = mainTable.Columns[crosstabVar].DataType.ToString();
            }

            if (columnType.Equals("System.Boolean"))
            {
                valuesAreBool = true;
            }
            else if (columnType.Equals("System.Int16")
                || columnType.Equals("System.Int32")
                || columnType.Equals("System.Int64")
                || columnType.Equals("System.Double")
                || columnType.Equals("System.Single")
                || columnType.Equals("System.Decimal")
                || columnType.Equals("System.Byte")
                || columnType.Equals("System.SByte"))
            {
                doMeans = true;
            }



            List stratas = new List();

            DataTable distinctTable = new DataTable();
            DataTable sortedDistinctTable = new DataTable();


            List freqValues = new List();
            Field field = null;
            Dictionary crosstabValues = new Dictionary();

            Parallel.Invoke(
                 CxNull






















,
                 CxNull










,
                 CxNull













            );

            if (!inputs.IgnoreRowLimits && stratas.Count > Frequency_Strata_Limit)
            {
                string exMessage = string.Format(DashboardSharedStrings.ERROR_TOO_MANY_STRATA_VALUES, strataVars[0], stratas.Count, Frequency_Strata_Limit);
                throw new ApplicationException(exMessage);
            }




            if (inputs.Worker != null && inputs.Worker.CancellationPending == true)
            {
                return null;
            }





            int count = 0;
            int totalCount = sortedDistinctTable.Rows.Count;
            foreach (DataRow row in sortedDistinctTable.Rows)
            {



                if (!freqValues.Contains(row[0].ToString().TrimEnd()))
                {
                    if (inputs.Worker != null && inputs.Worker.CancellationPending == true)
                    {
                        return null;
                    }

                    freqValues.Add(row[0].ToString().TrimEnd());
                }

                count++;

                if (count % 500 == 0)
                {
                    string statusMessage = string.Format(SharedStrings.DASHBOARD_GADGET_STATUS_COMPARED_FREQ_VALUES, count.ToString("N0"), sortedDistinctTable.Rows.Count.ToString("N0"));
                    inputs.UpdateGadgetStatus(statusMessage);
                }
            }

            if (includeMissing)
            {
                if (freqValues.Contains(string.Empty))
                {
                    freqValues.Remove(string.Empty);
                    freqValues.Add(string.Empty);
                }
            }

            if (isAberrationRoutine && !inputs.IgnoreRowLimits && freqValues.Count > Aberration_Row_Limit)
            {
                string exMessage = string.Format(DashboardSharedStrings.ERROR_TOO_MANY_VALUES, freqVar, freqValues.Count, Aberration_Row_Limit);
                throw new ApplicationException(exMessage);
            }
            else if (!inputs.InputVariableList.ContainsKey("aberration") && !inputs.IgnoreRowLimits && freqValues.Count > Frequency_Row_Limit)
            {
                string exMessage = string.Format(DashboardSharedStrings.ERROR_TOO_MANY_VALUES, freqVar, freqValues.Count, Frequency_Row_Limit);
                throw new ApplicationException(exMessage);
            }

            if (!needsOutputTable)
            {
                string temp = freqValues[0];
                freqValues.Clear();
                freqValues.Add(temp);
            }

            if (!valuesAreBool && field != null && field is YesNoField)
            {

                valuesAreBool = true;
                doMeans = true;
            }

            if (useAllPossibleValues && field != null)
            {
                inputs.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_FINDING_LIST_VALUES);

                if (field is DDLFieldOfLegalValues)
                {
                    DataTable dataTable = ((TableBasedDropDownField)field).GetSourceData();
                    Dictionary fieldValues = new Dictionary(StringComparer.OrdinalIgnoreCase);

                    foreach (System.Data.DataRow row in dataTable.Rows)
                    {
                        if (inputs.IsRequestCancelled())
                        {
                            return null;
                        }

                        if (!string.IsNullOrEmpty(((TableBasedDropDownField)field).CodeColumnName.Trim()))
                        {
                            string key = row[((TableBasedDropDownField)field).CodeColumnName.Trim()].ToString();
                            if (!freqValues.Contains(key))
                            {
                                freqValues.Add(key);
                            }
                        }
                    }
                }
                else if (field is DDLFieldOfCommentLegal)
                {
                    DataTable dataTable = ((TableBasedDropDownField)field).GetSourceData();
                    Dictionary fieldValues = new Dictionary(StringComparer.OrdinalIgnoreCase);

                    foreach (System.Data.DataRow row in dataTable.Rows)
                    {
                        if (inputs.Worker != null && inputs.Worker.CancellationPending == true)
                        {
                            return null;
                        }

                        if (!string.IsNullOrEmpty(((TableBasedDropDownField)field).TextColumnName.Trim()))
                        {
                            string key = row[((TableBasedDropDownField)field).TextColumnName.Trim()].ToString();

                            int dash = key.IndexOf('-');
                            string newKey = key.Substring(0, dash);

                            if (!freqValues.Contains(newKey))
                            {
                                freqValues.Add(newKey);
                            }
                        }
                    }
                }
                else if (field is DDLFieldOfCodes)
                {
                    DataTable dataTable = ((TableBasedDropDownField)field).GetSourceData();
                    Dictionary fieldValues = new Dictionary(StringComparer.OrdinalIgnoreCase);

                    foreach (System.Data.DataRow row in dataTable.Rows)
                    {
                        if (inputs.Worker != null && inputs.Worker.CancellationPending == true)
                        {
                            return null;
                        }

                        if (!string.IsNullOrEmpty(((TableBasedDropDownField)field).TextColumnName.Trim()))
                        {
                            string key = row[((TableBasedDropDownField)field).TextColumnName.Trim()].ToString();

                            if (!freqValues.Contains(key))
                            {
                                freqValues.Add(key);
                            }
                        }
                    }
                }
            }
            else if (useAllPossibleValues && IsUserDefinedColumn(freqVar))
            {
                List rules = Rules.GetRules(freqVar);
                foreach (IDashboardRule rule in rules)
                {
                    if (rule is Rule_Recode)
                    {
                        Rule_Recode recodeRule = rule as Rule_Recode;
                        foreach (string s in recodeRule.GetToValues())
                        {
                            if (!freqValues.Contains(s))
                            {
                                freqValues.Add(s);
                            }
                        }
                    }
                    else if (rule is Rule_Format)
                    {
                        Rule_Format formatRule = rule as Rule_Format;

                        if (formatRule.FormatType == FormatTypes.FullMonthName || formatRule.FormatType == FormatTypes.ShortMonthName)
                        {
                            DateTime[] dts =  CxNull












;

                            foreach (DateTime dt in dts)
                            {
                                string formattedValue = string.Format(System.Globalization.CultureInfo.CurrentCulture, formatRule.GetFormatString(), dt) + formatRule.Suffix;
                                freqValues.Add(formattedValue);
                            }
                        }
                        else if (formatRule.FormatType == FormatTypes.FullDayName || formatRule.FormatType == FormatTypes.ShortDayName)
                        {
                            DateTime[] dts =  CxNull







;

                            foreach (DateTime dt in dts)
                            {
                                string formattedValue = string.Format(System.Globalization.CultureInfo.CurrentCulture, formatRule.GetFormatString(), dt) + formatRule.Suffix;
                                freqValues.Add(formattedValue);
                            }
                        }
                    }
                }
            }

            inputs.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_CALCULATING_TOTALS);
            foreach (Strata strataKvp in stratas)
            {
                if (inputs.Worker != null && inputs.Worker.CancellationPending == true)
                {
                    return null;
                }

                double sum = -1;
                double totalSum = 0;
                DataTable freqTable = new DataTable(strataKvp.Filter);

                if (valuesAreBool)
                {
                    freqTable.Columns.Add(freqVar, typeof(string));
                }
                else
                {
                    freqTable.Columns.Add(freqVar, mainTable.Columns[freqVar].DataType);
                }
                freqTable.Columns.Add("freq", typeof(double));

                string nullColumnName = string.Empty;

                foreach (string s in freqValues)
                {



                    if (inputs.Worker != null && inputs.Worker.CancellationPending == true)
                    {
                        return null;
                    }

                    string value = s;
                    string crosstabValue = string.Empty;

                    string filter = string.Empty;
                    string operand = " = ";

                    if (doStratification)
                    {
                        filter = strataKvp.SafeFilter;
                    }

                    value = FormatValue(value, columnType);

                    if (string.IsNullOrEmpty(s) && (includeMissing))
                    {
                        value = "is null";
                        operand = string.Empty;
                    }
                    else if (string.IsNullOrEmpty(s))
                    {
                        continue;
                    }

                    if (columnType.Equals("System.DateTime"))
                    {
                        if (!value.Equals("is null"))
                        {
                            DateTime dateValue = DateTime.Parse(value.Trim('#'), System.Globalization.CultureInfo.CurrentCulture);
                            value = "#" + dateValue.ToString("MM/dd/yyyy HH:mm:ss", System.Globalization.CultureInfo.InvariantCulture) + "#";
                        }
                    }

                    if (doStratification)
                    {
                        if (columnType.Equals("System.String") && value.ToLower().Equals("is null"))
                        {
                            filter = filter + " and " + "(" + AddBracketsToString(freqVar) + StringLiterals.SPACE + "= ''" + " or " + AddBracketsToString(freqVar) + StringLiterals.SPACE + operand + value + ")";
                        }
                        else
                        {
                            filter = filter + " and " + AddBracketsToString(freqVar) + StringLiterals.SPACE + operand + value;
                        }
                    }
                    else
                    {
                        if (columnType.Equals("System.String") && value.ToLower().Equals("is null"))
                        {
                            filter = "(" + AddBracketsToString(freqVar) + StringLiterals.SPACE + "= ''" + " or " + AddBracketsToString(freqVar) + StringLiterals.SPACE + operand + value + ")";
                        }
                        else
                        {
                            filter = AddBracketsToString(freqVar) + StringLiterals.SPACE + operand + value;
                        }
                    }

                    if (!doCrossTab)
                    {
                        if (string.IsNullOrEmpty(weightVar))
                        {
                            try
                            {




                                if (filter.EndsWith("is null"))
                                {

                                    string originalFilter = filter;
                                    string baseFilter = filter.Substring(0, filter.Length - 8);
                                    baseFilter = baseFilter + StringLiterals.SPACE + "is not null";

                                    string strataFilter = originalFilter;

                                    if (strataFilter.EndsWith("is null"))
                                    {

                                        DataView sumView = new DataView(mainTable, CombineFilters(filter, dv), string.Empty, DataViewRowState.CurrentRows);
                                        sum = sumView.Count;
                                    }
                                    else
                                    {
                                        string strataFilter2 = baseFilter + " AND " + strataFilter;

                                        double sumNotMissing = Convert.ToDouble(mainTable.Compute("count(" + AddBracketsToString(freqVar) + ")", CombineFilters(strataFilter2, dv)));
                                        double sumTotal = Convert.ToDouble(mainTable.Compute("count(" + AddBracketsToString(strataKvp.SafeFilter) + ")", CombineFilters(strataFilter, dv)));
                                        sum = sumTotal - sumNotMissing;
                                    }
                                }
























                                else
                                {
                                    string combinedFilter = CombineFilters(filter, dv);
                                    sum = mainTable.Select(combinedFilter, "", DataViewRowState.CurrentRows).Length;




                                }



                            }
                            catch (InvalidCastException)
                            {
                                sum = 0;
                            }
                            totalSum = totalSum + sum;
                        }
                        else
                        {
                            double trySum;
                            bool success = double.TryParse(mainTable.Compute("sum(" + AddBracketsToString(weightVar) + ")", CombineFilters(filter, dv)).ToString(), out trySum);
                            if (success)
                            {
                                sum = trySum;
                            }
                            else
                            {
                                sum = 0;
                            }
                            totalSum = totalSum + sum;
                        }

                        value = s;

                        if (valuesAreBool)
                        {
                            value = RecodeBooleanToYesNo(s);
                        }

                        if (string.IsNullOrEmpty(value))
                        {
                            freqTable.Rows.Add(DBNull.Value, sum);
                        }
                        else
                        {
                            freqTable.Rows.Add(value, sum);
                        }
                    }

                    else
                    {
                        if (freqTable.Rows.Count == 0)
                        {
                            freqTable = new DataTable(strataKvp.Filter);

                            if (valuesAreBool)
                            {
                                freqTable.Columns.Add(freqVar, typeof(string));
                            }
                            else
                            {
                                freqTable.Columns.Add(freqVar, mainTable.Columns[freqVar].DataType);
                            }


                            foreach (KeyValuePair csKvp in crosstabValues)
                            {
                                if (inputs.Worker != null && inputs.Worker.CancellationPending == true)
                                {
                                    return null;
                                }

                                freqTable.Columns.Add(csKvp.Value, typeof(double));
                                if (string.IsNullOrEmpty(csKvp.Value))
                                {
                                    nullColumnName = freqTable.Columns[freqTable.Columns.Count - 1].ColumnName;
                                }
                            }
                        }

                        value = s;

                        if (valuesAreBool)
                        {
                            value = RecodeBooleanToYesNo(s);
                        }

                        if (string.IsNullOrEmpty(value))
                        {
                            freqTable.Rows.Add(DBNull.Value);
                        }
                        else
                        {
                            freqTable.Rows.Add(value);
                        }

                        string originalFilter = filter;

                        freqTable.Rows[freqTable.Rows.Count - 1].BeginEdit();

                        foreach (KeyValuePair csKvp in crosstabValues)
                        {
                            if (inputs.Worker != null && inputs.Worker.CancellationPending == true)
                            {
                                return null;
                            }

                            crosstabValue = csKvp.Key;
                            crosstabValue = FormatValue(crosstabValue, crosstabColumnType);

                            if (string.IsNullOrEmpty(crosstabValue) || crosstabValue.Equals("''"))
                            {
                                if (crosstabColumnType.Equals("System.String"))
                                {
                                    filter = originalFilter + " and (" + AddBracketsToString(crosstabVar) + " = '' or " + AddBracketsToString(crosstabVar) + " is null)";
                                }
                                else
                                {
                                    filter = originalFilter + " and " + AddBracketsToString(crosstabVar) + " is null";
                                }
                            }
                            else
                            {
                                filter = originalFilter + " and " + AddBracketsToString(crosstabVar) + " = " + crosstabValue;
                            }

                            if (filter.StartsWith(" and "))
                            {
                                filter = filter.Remove(0, 4);
                            }

                            if (string.IsNullOrEmpty(weightVar))
                            {
                                try
                                {
                                    sum = mainTable.Select(CombineFilters(filter, dv), "", DataViewRowState.CurrentRows).Length;


                                }
                                catch (InvalidCastException)
                                {
                                    sum = 0;
                                }
                                totalSum = totalSum + sum;
                            }
                            else
                            {
                                double trySum;
                                bool success = double.TryParse(mainTable.Compute("sum(" + AddBracketsToString(weightVar) + ")", CombineFilters(filter, dv)).ToString(), out trySum);
                                if (success)
                                {
                                    sum = trySum;
                                }
                                else
                                {
                                    sum = 0;
                                }
                                totalSum = totalSum + sum;
                            }

                            int lastRowAdded = freqTable.Rows.Count - 1;
                            if (!string.IsNullOrEmpty(csKvp.Value))
                            {
                                freqTable.Rows[lastRowAdded][csKvp.Value] = sum;
                            }
                            else
                            {
                                freqTable.Rows[lastRowAdded][nullColumnName] = sum;
                            }
                        }
                        freqTable.Rows[freqTable.Rows.Count - 1].EndEdit();
                    }



                }

                if (!string.IsNullOrEmpty(nullColumnName))
                {
                    freqTable.Columns[nullColumnName].ColumnName = Config.Settings.RepresentationOfMissing;
                }

                DataTable sortedFreqTable = new DataTable();

                if (sortHighToLow && string.IsNullOrEmpty(crosstabVar))
                {
                    sortedFreqTable = SortHighToLow(freqTable, freqTable.Columns["freq"]);
                }
                else
                {
                    sortedFreqTable = SortBySingleColumn(freqTable, freqTable.Columns[freqVar]);
                }

                if (inputs.Worker != null && inputs.Worker.CancellationPending == true)
                {
                    return null;
                }

                List descriptiveStatistics = new List();


                if (doMeans && includeFullSummaryStatistics)
                {
                    string outerFilter = string.Empty;
                    if (doStratification)
                    {
                        outerFilter = strataKvp.SafeFilter;
                    }
                    if (doCrossTab)
                    {
                        foreach (KeyValuePair csKvp in crosstabValues)
                        {
                            if (inputs.Worker != null && inputs.Worker.CancellationPending == true)
                            {
                                return null;
                            }

                            string crosstabValue = csKvp.Key;
                            crosstabValue = FormatValue(crosstabValue, crosstabColumnType);

                            string filter = outerFilter + " and " + AddBracketsToString(crosstabVar) + " = " + crosstabValue;
                            if (filter.StartsWith(" and "))
                            {
                                filter = filter.Remove(0, 4);
                            }
                            inputs.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_CALCULATING_DESCRIPTIVE_STATISTICS);
                            DataTable filteredTable = GenerateTable(inputs);
                            DescriptiveStatistics means = DoMeans(inputs, filteredTable, freqTable, filter, outerFilter);


                            descriptiveStatistics.Add(means);

                        }

                        bool showAnova = false;

                        if (inputs is MeansParameters)
                        {
                            MeansParameters meansParameters = inputs as MeansParameters;
                            showAnova = meansParameters.ShowANOVA;
                        }





                        foreach (DescriptiveStatistics stats in descriptiveStatistics)
                            if (stats.observations == 0.0)
                                showAnova = false;

                        if (crosstabValues.Count >= 2 && crosstabValues.Count <= 127 && showAnova)
                        {

                            inputs.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_CALCULATING_DESCRIPTIVE_STATISTICS_ADVANCED);

                            List observations = new List();
                            List unweightedObservations = new List();
                            List avgs = new List();
                            List vars = new List();
                            double grandMean = 0;
                            double grandTotal = 0;
                            double unweightedTotal = 0;
                            int crosstabs = 0;
                            foreach (DescriptiveStatistics stats in descriptiveStatistics)
                            {
                                if (stats.mean > -1)
                                {
                                    observations.Add(stats.observations);
                                    unweightedObservations.Add(stats.unweightedObservations);
                                    grandTotal += stats.observations;
                                    unweightedTotal += stats.unweightedObservations;
                                    avgs.Add(stats.mean.Value);
                                    vars.Add(stats.variance.Value);
                                    grandMean = stats.grandMean.Value;

                                    crosstabs++;
                                }
                            }
                            DescriptiveStatistics ds = descriptiveStatistics[0];
                            ds.ssBetween = CalculateSSBetween(grandMean, observations, avgs);
                            ds.dfBetween = crosstabs - 1;
                            ds.msBetween = ds.ssBetween / ds.dfBetween;
                            ds.ssWithin = CalculateSSWithin(observations, vars);
                            ds.dfWithin = grandTotal - crosstabs;
                            ds.dfError = unweightedTotal - crosstabs;
                            ds.msWithin = ds.ssWithin / ds.dfWithin;
                            ds.fStatistic = ds.msBetween / ds.msWithin;
                            ds.anovaPValue = new StatisticsRepository.statlib().PfromF(ds.fStatistic.Value, ds.dfBetween.Value, ds.dfError.Value);
                            ds.chiSquare = CalculateChiSquare(ds.dfWithin.Value, ds.msWithin.Value, observations, vars);
                            ds.bartlettPValue = new StatisticsRepository.statlib().PfromX2(ds.chiSquare.Value, ds.dfBetween.Value);
                            ds.crosstabs = crosstabs;

                            if (crosstabs == 2 && ds.dfBetween.HasValue && ds.anovaPValue.HasValue)
                            {

                                ds.SatterthwaiteDF = Math.Pow(vars[0] / observations[0] + vars[1] / observations[1], 2.0) / (1.0 / (unweightedObservations[0] - 1.0) * Math.Pow(vars[0] / observations[0], 2.0) + 1.0 / (unweightedObservations[1] - 1.0) * Math.Pow(vars[1] / observations[1], 2.0));
                                double SEu = Math.Sqrt(vars[0] / observations[0] + vars[1] / observations[1]);
                                ds.SatterthwaiteDF = Math.Pow(SEu, 4.0) / (1.0 / (unweightedObservations[0] - 1.0) * Math.Pow(vars[0] / observations[0], 2.0) + 1.0 / (unweightedObservations[1] - 1.0) * Math.Pow(vars[1] / observations[1], 2.0));
                                ds.meansDiff = avgs[0] - avgs[1];
                                ds.stdDevDiff = Math.Sqrt(((unweightedObservations[0] - 1) * vars[0] + (unweightedObservations[1] - 1) * vars[1]) / (unweightedObservations[0] + unweightedObservations[1] - 2));
                                ds.df = (int)unweightedObservations[0] + (int)unweightedObservations[1] - 2;
                                short shortDF = (short)ds.df;
                                double tProbability = 0.05;
                                double  intervalLength = new StatisticsRepository.statlib().TfromP(ref tProbability, ref shortDF) * ds.stdDevDiff * Math.Sqrt(1 / observations[0] + 1 / observations[1]);
                                ds.tStatistic = ds.meansDiff / (ds.stdDevDiff * Math.Sqrt(1.0 / observations[0] + 1.0 / observations[1]));
                                ds.pEqual = 2.0 * Epi.Statistics.SharedResources.PFromT(ds.tStatistic, (int)ds.df);
                                ds.tStatisticUnequal = ds.meansDiff / SEu;
                                double pUnequalLower = 2.0 * Epi.Statistics.SharedResources.PFromT(ds.tStatisticUnequal, (int)Math.Ceiling(ds.SatterthwaiteDF));
                                double pUnequalUpper = 2.0 * Epi.Statistics.SharedResources.PFromT(ds.tStatisticUnequal, (int)Math.Floor(ds.SatterthwaiteDF));
                                ds.pUneqal = pUnequalLower + (ds.SatterthwaiteDF - Math.Floor(ds.SatterthwaiteDF)) * (pUnequalUpper - pUnequalLower);
                                short shortDFCeiling = (short)(int)Math.Ceiling(ds.SatterthwaiteDF);
                                short shortDFFloor = (short)(int)Math.Floor(ds.SatterthwaiteDF);
                                double  unEqualIntervalTLower = new StatisticsRepository.statlib().TfromP(ref tProbability, ref shortDFCeiling);
                                double  unEqualIntervalTUpper = new StatisticsRepository.statlib().TfromP(ref tProbability, ref shortDFFloor);
                                double unEqualIntervalT = (double)unEqualIntervalTLower + (ds.SatterthwaiteDF - Math.Floor(ds.SatterthwaiteDF)) * (double)(unEqualIntervalTUpper - unEqualIntervalTLower);

                                ds.equalLCLMean = ds.meansDiff - (double)intervalLength;
                                ds.equalUCLMean = ds.meansDiff + (double)intervalLength;
                                ds.unequalLCLMean = ds.meansDiff - SEu * unEqualIntervalT;
                                ds.unequalUCLMean = ds.meansDiff + SEu * unEqualIntervalT;
                            }

                            string nullFilter = AddBracketsToString(freqVar) + " is not null";
                            string weightFilter = AddBracketsToString(weightVar) + " is not null";
                            string crosstabFilter = AddBracketsToString(crosstabVar) + " is not null";
                            string crosstabVarType = GetColumnType(crosstabVar);
                            if (GetColumnType(crosstabVar).Equals("System.String"))
                            {
                                crosstabFilter = crosstabFilter + " and not " + AddBracketsToString(crosstabVar) + " = ''";
                            }
                            string fullFilter = string.Empty;
                            if (string.IsNullOrEmpty(outerFilter))
                            {
                                fullFilter = nullFilter;
                            }
                            else
                            {
                                fullFilter = outerFilter + " and " + nullFilter;
                            }

                            if (!string.IsNullOrEmpty(weightVar))
                            {
                                if (string.IsNullOrEmpty(fullFilter))
                                {
                                    fullFilter = weightFilter;
                                }
                                else
                                {
                                    fullFilter = fullFilter + " and " + weightFilter;
                                }
                            }

                            if (!string.IsNullOrEmpty(crosstabVar))
                            {
                                if (string.IsNullOrEmpty(fullFilter))
                                {
                                    fullFilter = crosstabVar;
                                }
                                else
                                {
                                    fullFilter = fullFilter + " and " + crosstabFilter;
                                }
                            }

                            FrequencyParameters newInputs = new FrequencyParameters();
                            newInputs.IncludeFullSummaryStatistics = false;
                            newInputs.IncludeMissing = false;
                            newInputs.IgnoreRowLimits = true;
                            newInputs.ColumnNames.Add(freqVar);
                            if (!string.IsNullOrEmpty(inputs.CustomFilter.Trim()))
                            {
                                newInputs.CustomFilter = inputs.CustomFilter.Trim() + " and " + fullFilter;
                            }
                            else
                            {
                                newInputs.CustomFilter = fullFilter;
                            }
                            if (!string.IsNullOrEmpty(weightVar))
                            {
                                newInputs.WeightVariableName = weightVar;
                            }

                            DataTable freqHorizontal = ExtractFirstFrequencyTable(this.GenerateFrequencyTable(newInputs));

                            newInputs = new FrequencyParameters();
                            newInputs.IncludeFullSummaryStatistics = false;
                            newInputs.IncludeMissing = false;
                            newInputs.IgnoreRowLimits = true;
                            newInputs.ColumnNames.Add(crosstabVar);
                            if (!string.IsNullOrEmpty(inputs.CustomFilter.Trim()))
                            {
                                newInputs.CustomFilter = inputs.CustomFilter.Trim() + " and " + fullFilter;
                            }
                            else
                            {
                                newInputs.CustomFilter = fullFilter;
                            }
                            if (!string.IsNullOrEmpty(weightVar))
                            {
                                newInputs.WeightVariableName = weightVar;
                            }












                            DataTable freqVertical = ExtractFirstFrequencyTable(this.GenerateFrequencyTable(newInputs));














                            List allLocalFreqs = ConvertTableToListOfLists(freqTable);

                            if (freqHorizontal != null && freqVertical != null)
                            {
                                ds.kruskalWallisH = CalculateKruskalWallisH(freqHorizontal, freqVertical, allLocalFreqs, grandTotal);
                                ds.kruskalPValue = new StatisticsRepository.statlib().PfromX2(ds.kruskalWallisH.Value, ds.dfBetween.Value);
                            }
                            descriptiveStatistics[0] = ds;

                        }
                    }
                    else
                    {
                        inputs.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_CALCULATING_DESCRIPTIVE_STATISTICS);
                        DataTable filteredTable = GenerateTable(inputs);
                        DescriptiveStatistics means = DoMeans(inputs, filteredTable, freqTable, outerFilter, string.Empty);
                        if (means.observations == -1)
                        {
                            return null;
                        }
                        descriptiveStatistics.Add(means);
                    }
                } 
                else
                {
                    DescriptiveStatistics means = new DescriptiveStatistics();
                    means.observations = totalSum;
                    descriptiveStatistics.Add(means);
                }

                //Debug











                //

                if (inputs != null && inputs.ShowCommentLegalLabels && field != null && field is DDLFieldOfCommentLegal)
                {
                    AddCommentLegalLabelsToFreqTable(sortedFreqTable, freqVar, crosstabVar);
                }
                else if (inputs != null && inputs.ShowCommentLegalLabels && field != null && field is OptionField)
                {
                    AddOptionLabelsToFreqTable(sortedFreqTable);
                }

                if (sortedFreqTable != null)
                {
                    stratifiedFrequencyTables.Add(sortedFreqTable, descriptiveStatistics);
                }
                string processedStatusMessage = string.Format(SharedStrings.DASHBOARD_GADGET_STATUS_PROCESSED_TABLES, stratifiedFrequencyTables.Count.ToString());
                inputs.UpdateGadgetStatus(processedStatusMessage);
            } 




            return stratifiedFrequencyTables;
        }






        public DataTable ExtractFirstFrequencyTable(Dictionary frequencyTables)
        {
            if (frequencyTables.Count >= 1)
            {
                foreach (KeyValuePair tableKvp in frequencyTables)
                {
                    if (tableKvp.Key != null)
                    {
                        return (DataTable)tableKvp.Key;
                    }
                }
                return null;
            }
            else
            {
                return null;
            }
        }

        public DataTable GenerateDataDictionaryTable()
        {
            DataTable dictionaryTable = this.FieldTable.Copy();

            foreach (KeyValuePair kvp in this.TableColumnNames)
            {
                DataRow row = dictionaryTable.Rows.Find(kvp.Key);
                if (row == null)
                {
                    dictionaryTable.Rows.Add(kvp.Key, kvp.Value);
                }
            }

            if (this.IsUsingEpiProject)
            {
                dictionaryTable.Columns.Add("Page", typeof(int));
                dictionaryTable.Columns.Add("Tab", typeof(int));
                dictionaryTable.Columns.Add("Prompt", typeof(string));
                dictionaryTable.Columns.Add("Definition", typeof(string));
                dictionaryTable.Columns.Add("Items", typeof(string));

                foreach (DataRow fieldRow in dictionaryTable.Rows)
                {
                    if (fieldRow["epifieldtype"] is RenderableField)
                    {
                        RenderableField renderableField = fieldRow["epifieldtype"] as RenderableField;
                        fieldRow["Page"] = renderableField.Page.Position + 1;
                        fieldRow["Tab"] = renderableField.TabIndex;
                        fieldRow["Prompt"] = renderableField.PromptText;
                        if (renderableField is GroupField)
                        {
                            GroupField groupField = renderableField as GroupField;
                            fieldRow["Items"] = groupField.ChildFieldNames;
                        }
                        else if (renderableField is OptionField)
                        {
                            OptionField optionField = renderableField as OptionField;
                            fieldRow["Items"] = optionField.GetOptionsString();
                        }
                    }
                    else if (IsUserDefinedColumn(fieldRow["columnname"].ToString()))
                    {
                        List rules = this.Rules.GetRules(fieldRow["columnname"].ToString());
                        if (rules.Count > 0)
                        {
                            fieldRow["Definition"] = rules[0].FriendlyRule;
                        }
                    }

                    fieldRow["datatype"] = fieldRow["datatype"].ToString().Replace("System.", String.Empty);
                }

                dictionaryTable.Columns["columnname"].SetOrdinal(0);
                dictionaryTable.Columns["Prompt"].SetOrdinal(1);
                dictionaryTable.Columns["formname"].SetOrdinal(2);
                dictionaryTable.Columns["Page"].SetOrdinal(3);
                dictionaryTable.Columns["Tab"].SetOrdinal(4);
                dictionaryTable.Columns["datatype"].SetOrdinal(5);
                dictionaryTable.Columns["epifieldtype"].SetOrdinal(6);
                dictionaryTable.Columns["tablename"].SetOrdinal(7);
                dictionaryTable.Columns["Definition"].SetOrdinal(8);
                dictionaryTable.Columns["Items"].SetOrdinal(9);




            }
            if (dictionaryTable == null || dictionaryTable.Rows.Count == 0)
            {
                throw new ApplicationException("There are no fields to display.");
            }




            return dictionaryTable;
        }







        [Obsolete]
        public DataTable Generate2x2Table(string exposure, string outcome, bool includeMissing = false)
        {
            //Input Validation
            if (string.IsNullOrEmpty(exposure) || string.IsNullOrEmpty(outcome))
            {
                throw new ApplicationException("No columns specified for SELECT.");
            }
            //

            List columnNames = new List();

            if (exposure.Equals(outcome))
            {
                return null;
            }

            columnNames.Add(exposure);
            columnNames.Add(outcome);

            DataTable filteredTable = GenerateTable(columnNames);


            if (filteredTable == null || filteredTable.Rows.Count <= 0)
            {
                return null;
            }


            List exposureValues = new List();
            List outcomeValues = new List();

            Field exposureField = null;
            Field outcomeField = null;

            foreach (DataRow fieldRow in FieldTable.Rows)
            {
                if (fieldRow["columnname"].Equals(exposure))
                {
                    if (fieldRow["epifieldtype"] is Field)
                    {
                        exposureField = fieldRow["epifieldtype"] as Field;
                    }
                    break;
                }
            }

            foreach (DataRow fieldRow in FieldTable.Rows)
            {
                if (fieldRow["columnname"].Equals(outcome))
                {
                    if (fieldRow["epifieldtype"] is Field)
                    {
                        outcomeField = fieldRow["epifieldtype"] as Field;
                    }
                    break;
                }
            }

            foreach (DataRow row in filteredTable.Rows)
            {
                string key = string.Empty;

                key = row[exposure].ToString();
                if (!exposureValues.Contains(key))
                {
                    if (string.IsNullOrEmpty(key) && (includeMissing == false))
                    {

                    }
                    else
                    {
                        exposureValues.Add(key);
                    }
                }

                key = row[outcome].ToString();
                if (!outcomeValues.Contains(key))
                {
                    if (string.IsNullOrEmpty(key) && (includeMissing == false))
                    {

                    }
                    else
                    {
                        outcomeValues.Add(key);
                    }
                }




                if ((outcomeValues.Count > 2 && exposureValues.Count >= 2) || (exposureValues.Count > 2 && outcomeValues.Count >= 2))
                {
                    break;
                }
            }

            DataTable twoByTwoTable = new DataTable("2x2");


            string exposureValue1 = string.Empty;
            string exposureValue2 = string.Empty;

            if (exposureValues.Count < 2)
            {
                exposureValue1 = exposureValues[0];
            }
            else
            {
                exposureValue1 = exposureValues[0];
                exposureValue2 = exposureValues[1];
            }

            string outcomeValue1 = string.Empty;
            string outcomeValue2 = string.Empty;

            if (outcomeValues.Count < 2)
            {
                outcomeValue1 = outcomeValues[0];
            }
            else
            {
                outcomeValue1 = outcomeValues[0];
                outcomeValue2 = outcomeValues[1];
            }

            string columnType = string.Empty;


            columnType = filteredTable.Columns[exposure].DataType.ToString();
            if (columnType.Equals("System.Boolean") || (exposureField != null && exposureField is YesNoField))
            {
                if (exposureValue1.Equals("0") || exposureValue1.ToLower().Equals("false"))
                {
                    exposureValue1 = Config.Settings.RepresentationOfNo;
                    exposureValue2 = Config.Settings.RepresentationOfYes;
                }
                else
                {
                    exposureValue1 = Config.Settings.RepresentationOfYes;
                    exposureValue2 = Config.Settings.RepresentationOfNo;
                }


                if ((exposureValues[0].Equals("0") || exposureValues[0].ToLower().Equals("false")) && exposureValues.Count >= 2)
                {
                    string temp = exposureValues[0];
                    exposureValues[0] = exposureValues[1];
                    exposureValues[1] = temp;

                    exposureValue1 = Config.Settings.RepresentationOfYes;
                    exposureValue2 = Config.Settings.RepresentationOfNo;
                }
            }
            else
            {
                exposureValues.Sort();
                exposureValue1 = exposureValues[0];
                exposureValue2 = exposureValues[1];
            }


            columnType = filteredTable.Columns[outcome].DataType.ToString();
            if (columnType.Equals("System.Boolean") || (outcomeField != null && outcomeField is YesNoField))
            {
                if (outcomeValue1.Equals("0") || outcomeValue1.ToLower().Equals("false"))
                {
                    outcomeValue1 = Config.Settings.RepresentationOfNo;
                    outcomeValue2 = Config.Settings.RepresentationOfYes;
                }
                else
                {
                    outcomeValue1 = Config.Settings.RepresentationOfYes;
                    outcomeValue2 = Config.Settings.RepresentationOfNo;
                }


                if ((outcomeValues[0].Equals("0") || outcomeValues[0].ToLower().Equals("false")) && outcomeValues.Count >= 2)
                {
                    string temp = outcomeValues[0];
                    outcomeValues[0] = outcomeValues[1];
                    outcomeValues[1] = temp;

                    outcomeValue1 = Config.Settings.RepresentationOfYes;
                    outcomeValue2 = Config.Settings.RepresentationOfNo;
                }
            }
            else
            {

                outcomeValues.Sort();
                outcomeValue1 = outcomeValues[0];
                outcomeValue2 = outcomeValues[1];
            }


            twoByTwoTable.Columns.Add("exposure", typeof(string));


            twoByTwoTable.Columns.Add(outcomeValue1, typeof(int));
            twoByTwoTable.Columns.Add(outcomeValue2, typeof(int));


            twoByTwoTable.Rows.Add(exposureValue1, 0, 0);
            twoByTwoTable.Rows.Add(exposureValue2, 0, 0);

            try
            {

                foreach (DataRow row in filteredTable.Rows)
                {
                    if (row[exposure].ToString() == exposureValues[0])
                    {
                        if (row[outcome].ToString() == outcomeValues[0])
                        {
                            twoByTwoTable.Rows[0][1] = Convert.ToInt32(twoByTwoTable.Rows[0][1]) + 1;
                        }
                        else if (row[outcome].ToString() == outcomeValues[1])
                        {
                            twoByTwoTable.Rows[0][2] = Convert.ToInt32(twoByTwoTable.Rows[0][2]) + 1;
                        }
                    }
                    else if (row[exposure].ToString() == exposureValues[1])
                    {
                        if (row[outcome].ToString() == outcomeValues[0])
                        {
                            twoByTwoTable.Rows[1][1] = Convert.ToInt32(twoByTwoTable.Rows[1][1]) + 1;
                        }
                        else if (row[outcome].ToString() == outcomeValues[1])
                        {
                            twoByTwoTable.Rows[1][2] = Convert.ToInt32(twoByTwoTable.Rows[1][2]) + 1;
                        }
                    }
                }
            }
            catch (ArgumentOutOfRangeException)
            {
                twoByTwoTable.Rows.Add(SharedStrings.TWO_BY_TWO_VALUES_TOO_FEW, -1, -1);
                return twoByTwoTable;
            }


            if (exposureValues.Count > 2)
            {
                twoByTwoTable.Rows.Add(SharedStrings.EXPOSURE_VALUES_TOO_MANY, -1, -1);
                return twoByTwoTable;
            }
            else if (outcomeValues.Count > 2)
            {
                twoByTwoTable.Rows.Add(SharedStrings.OUTCOME_VALUES_TOO_MANY, -1, -1);
                return twoByTwoTable;
            }


            return twoByTwoTable;
        }

        [Obsolete]
        public DataTable GenerateEpiCurveTable(GadgetParameters inputs, decimal minWeek, decimal maxWeek, bool includeMissing = false)
        {
            //Input Validation
            if (string.IsNullOrEmpty(inputs.MainVariableName))
            {
                throw new ArgumentNullException("inputs.MainVariableName");
            }
            //

            inputs.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_CREATING_VARIABLES);

            string epiWeekColumn = inputs.MainVariableName;
            string caseStatusColumn = inputs.CrosstabVariableName;

            inputs.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_GENERATING_TABLE);

            DataView filteredView = GenerateView(inputs);

            if (inputs.IsRequestCancelled())
            {
                return null;
            }


            if (filteredView == null || filteredView.Count <= 0)
            {
                inputs.UpdateGadgetStatus(DashboardSharedStrings.ERROR_NO_DATA);
                return null;
            }

            List dateColumnValues = new List();
            List statusColumnValues = new List();

            inputs.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_FINDING_DATE_VALUES);

            foreach (DataRowView rowView in filteredView)
            {
                DataRow row = rowView.Row;

                if (inputs.IsRequestCancelled())
                {
                    return null;
                }

                decimal  dateKey = null;

                if (!string.IsNullOrEmpty(row[epiWeekColumn].ToString()))
                {
                    decimal result;
                    Decimal.TryParse(row[epiWeekColumn].ToString(), out result);

                    dateKey = (decimal )result;

                    if (dateKey.HasValue && !dateColumnValues.Contains(dateKey.Value))
                    {
                        if (!(dateKey.HasValue) && includeMissing == false)
                        {

                        }
                        else
                        {
                            if (dateKey.Value >= minWeek && dateKey.Value <= maxWeek)
                            {
                                if (!dateColumnValues.Contains(Math.Truncate(dateKey.Value)))
                                {
                                    dateColumnValues.Add(Math.Truncate(dateKey.Value));
                                }
                            }
                        }
                    }
                }

                string key = null;
                if (caseStatusColumn.Equals("_default_"))
                {
                    if (!statusColumnValues.Contains("true"))
                    {
                        statusColumnValues.Add("true");
                    }
                }
                else
                {
                    if (!string.IsNullOrEmpty(row[caseStatusColumn].ToString()))
                    {
                        key = row[caseStatusColumn].ToString();
                        if (!string.IsNullOrEmpty(key) && !statusColumnValues.Contains(key))
                        {
                            statusColumnValues.Add(key);
                        }
                    }
                }
            }

            inputs.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_GENERATING_EPI_CURVE_TABLE);

            DataTable epiCurveTable = new DataTable("EpiCurveTable");
            epiCurveTable.Columns.Add("totals", typeof(int));
            epiCurveTable.Columns.Add(epiWeekColumn, typeof(decimal));
            epiCurveTable.Columns.Add(caseStatusColumn, typeof(string));


            foreach (decimal  dt in dateColumnValues)
            {
                if (inputs.IsRequestCancelled())
                {
                    return null;
                }

                if (dt.HasValue)
                {
                    foreach (string s in statusColumnValues)
                    {
                        epiCurveTable.Rows.Add(0, (decimal)dt, s);
                    }
                }
            }

            inputs.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_TOTALS_EPI_CURVE_TABLE);

            foreach (DataRowView rowView in filteredView)
            {
                if (inputs.IsRequestCancelled())
                {
                    return null;
                }

                DataRow row = rowView.Row;


                foreach (decimal  dt in dateColumnValues)
                {
                    if (inputs.IsRequestCancelled())
                    {
                        return null;
                    }

                    decimal result;
                    Decimal.TryParse(row[epiWeekColumn].ToString(), out result);

                    if (dt.HasValue && row[epiWeekColumn] != DBNull.Value && Math.Truncate(result) == dt)
                    {
                        foreach (string s in statusColumnValues)
                        {
                            if (inputs.IsRequestCancelled())
                            {
                                return null;
                            }

                            if (!caseStatusColumn.Equals("_default_") && row[caseStatusColumn].ToString().Equals(s))
                            {
                                foreach (DataRow iRow in epiCurveTable.Rows)
                                {
                                    if (inputs.IsRequestCancelled())
                                    {
                                        return null;
                                    }

                                    if (iRow[epiWeekColumn].ToString().Equals(dt.ToString()) && iRow[caseStatusColumn].Equals(s))
                                    {
                                        iRow["totals"] = Int32.Parse(iRow["totals"].ToString()) + 1;
                                        break;
                                    }
                                }
                            }
                            else if (caseStatusColumn.Equals("_default_"))
                            {
                                foreach (DataRow iRow in epiCurveTable.Rows)
                                {
                                    if (inputs.IsRequestCancelled())
                                    {
                                        return null;
                                    }

                                    if (iRow[epiWeekColumn].ToString().Equals(dt.ToString()))
                                    {
                                        iRow["totals"] = Int32.Parse(iRow["totals"].ToString()) + 1;
                                        break;
                                    }
                                }
                            }
                        }
                    }
                }
            }

            return epiCurveTable;
        }








        [Obsolete]
        public DataTable GenerateEpiCurveTable(GadgetParameters inputs, DateTime minDate, DateTime maxDate, bool includeMissing = false)
        {
            //Input Validation
            if (string.IsNullOrEmpty(inputs.MainVariableName))
            {
                throw new ArgumentNullException("inputs.MainVariableName");
            }
            //

            inputs.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_CREATING_VARIABLES);

            string dateColumn = inputs.MainVariableName;
            string caseStatusColumn = inputs.CrosstabVariableName;

            inputs.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_GENERATING_TABLE);

            DataView filteredView = GenerateView(inputs);

            if (inputs.IsRequestCancelled())
            {
                return null;
            }


            if (filteredView == null || filteredView.Count <= 0)
            {
                inputs.UpdateGadgetStatus(DashboardSharedStrings.ERROR_NO_DATA);
                return null;
            }
            string dateInterval = inputs.InputVariableList["dateinterval"];
            List dateColumnValues = new List();
            List dateTimeColumnValues = new List();
            List statusColumnValues = new List();

            inputs.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_FINDING_DATE_VALUES);

            foreach (DataRowView rowView in filteredView)
            {
                if (inputs.IsRequestCancelled())
                {
                    return null;
                }

                DataRow row = rowView.Row;
                DateTime  dateKey = null;

                if (!string.IsNullOrEmpty(row[dateColumn].ToString()))
                {
                    dateKey = (DateTime )row[dateColumn];
                    if (dateKey.HasValue)
                    {
                        int year = 0;
                        int month = 0;
                        int day = 0;
                        int hour = 0;
                        DateTime newDate = DateTime.Now;

                        switch (dateInterval.ToLower())
                        {
                            case "years":
                                year = ((DateTime)dateKey).Year;

                                newDate = new DateTime(year, 1, 1, 0, 0, 0);

                                if (!dateColumnValues.Contains(newDate) && (dateKey >= minDate && dateKey <= maxDate))
                                {
                                    dateColumnValues.Add(newDate);
                                }
                                break;
                            case "months":
                                year = ((DateTime)dateKey).Year;
                                month = ((DateTime)dateKey).Month;

                                newDate = new DateTime(year, month, 1, 0, 0, 0);

                                if (!dateColumnValues.Contains(newDate) && (dateKey >= minDate && dateKey <= maxDate))
                                {
                                    dateColumnValues.Add(newDate);
                                }
                                break;
                            case "hours":
                                year = ((DateTime)dateKey).Year;
                                month = ((DateTime)dateKey).Month;
                                day = ((DateTime)dateKey).Day;
                                hour = ((DateTime)dateKey).Hour;

                                newDate = new DateTime(year, month, day, hour, 0, 0);

                                if (!dateColumnValues.Contains(newDate) && (dateKey >= minDate && dateKey <= maxDate))
                                {
                                    dateColumnValues.Add(newDate);
                                }
                                break;
                            case "days":
                                year = ((DateTime)dateKey).Year;
                                month = ((DateTime)dateKey).Month;
                                day = ((DateTime)dateKey).Day;

                                newDate = new DateTime(year, month, day, 0, 0, 0);

                                if (!dateColumnValues.Contains(newDate) && (dateKey >= minDate && dateKey <= maxDate))
                                {
                                    dateColumnValues.Add(newDate);
                                }
                                break;
                            default:
                                if (!(dateKey.HasValue) && includeMissing == false) 
                                {

                                }
                                else
                                {
                                    if (dateKey.Value >= minDate && dateKey.Value <= maxDate)
                                    {
                                        dateColumnValues.Add(dateKey.Value.Date);
                                    }
                                }
                                break;
                        }
                    }
                }

                string key = null;
                if (caseStatusColumn.Equals("_default_"))
                {
                    if (!statusColumnValues.Contains("true"))
                    {
                        statusColumnValues.Add("true");
                    }
                }
                else
                {
                    if (!string.IsNullOrEmpty(row[caseStatusColumn].ToString()))
                    {
                        key = row[caseStatusColumn].ToString();
                        if (!string.IsNullOrEmpty(key) && !statusColumnValues.Contains(key))
                        {
                            statusColumnValues.Add(key);
                        }
                    }
                }
            }

            inputs.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_GENERATING_EPI_CURVE_TABLE);

            DataTable epiCurveTable = new DataTable("EpiCurveTable");
            epiCurveTable.Columns.Add("totals", typeof(int));
            epiCurveTable.Columns.Add(dateColumn, typeof(DateTime));
            epiCurveTable.Columns.Add(caseStatusColumn, typeof(string));


            foreach (DateTime? dt in dateColumnValues)
            {
                if (inputs.IsRequestCancelled())
                {
                    return null;
                }

                if (dt.HasValue)
                {
                    foreach (string s in statusColumnValues)
                    {
                        epiCurveTable.Rows.Add(0, dt.Value, s);
                    }
                }
            }

            inputs.UpdateGadgetStatus(SharedStrings.DASHBOARD_GADGET_STATUS_TOTALS_EPI_CURVE_TABLE);

            foreach (DataRowView rowView in filteredView)
            {
                if (inputs.IsRequestCancelled())
                {
                    return null;
                }

                DataRow row = rowView.Row;


                foreach (DateTime? dt in dateColumnValues)
                {
                    if (inputs.IsRequestCancelled())
                    {
                        return null;
                    }

                    DateTime  rowDateTime = null;
                    DateTime  rowOriginalDateTime = null;

                    if (row[dateColumn] != DBNull.Value)
                    {
                        rowDateTime = ((DateTime)row[dateColumn]);
                        rowOriginalDateTime = rowDateTime;
                    }
                    else
                    {
                        continue;
                    }

                    if (dt.HasValue && rowDateTime.HasValue)
                    {
                        int year = rowDateTime.Value.Year;
                        int month = rowDateTime.Value.Month;
                        int day = rowDateTime.Value.Day;
                        int hour = rowDateTime.Value.Hour;

                        switch (dateInterval.ToLower())
                        {
                            case "hours":
                                year = rowDateTime.Value.Year;
                                month = rowDateTime.Value.Month;
                                day = rowDateTime.Value.Day;
                                hour = rowDateTime.Value.Hour;
                                rowDateTime = new DateTime(year, month, day, hour, 0, 0);
                                break;
                            case "days":
                                year = rowDateTime.Value.Year;
                                month = rowDateTime.Value.Month;
                                day = rowDateTime.Value.Day;
                                rowDateTime = new DateTime(year, month, day, 0, 0, 0);
                                break;
                            case "months":
                                year = rowDateTime.Value.Year;
                                month = rowDateTime.Value.Month;
                                rowDateTime = new DateTime(year, month, 1, 0, 0, 0);
                                break;
                            case "years":
                                year = rowDateTime.Value.Year;
                                rowDateTime = new DateTime(year, 1, 1, 0, 0, 0);
                                break;
                        }
                    }

                    if (rowDateTime.HasValue && (rowOriginalDateTime.Value < minDate || rowOriginalDateTime.Value > maxDate))
                    {
                        continue;
                    }

                    if (rowDateTime.HasValue && ((DateTime)dt).Equals(((DateTime)rowDateTime)))
                    {
                        foreach (string s in statusColumnValues)
                        {
                            if (inputs.IsRequestCancelled())
                            {
                                return null;
                            }

                            if (!caseStatusColumn.Equals("_default_") && row[caseStatusColumn].ToString().Equals(s))
                            {
                                foreach (DataRow iRow in epiCurveTable.Rows)
                                {
                                    if (inputs.IsRequestCancelled())
                                    {
                                        return null;

                                    }
                                    if (iRow[dateColumn].ToString().Equals(dt.ToString()) && iRow[caseStatusColumn].Equals(s))
                                    {
                                        iRow["totals"] = Int32.Parse(iRow["totals"].ToString()) + 1;
                                        break;
                                    }
                                }
                            }
                            else if (caseStatusColumn.Equals("_default_"))
                            {
                                foreach (DataRow iRow in epiCurveTable.Rows)
                                {
                                    if (inputs.IsRequestCancelled())
                                    {
                                        return null;
                                    }

                                    if (iRow[dateColumn].ToString().Equals(dt.ToString()))
                                    {
                                        iRow["totals"] = Int32.Parse(iRow["totals"].ToString()) + 1;
                                        break;
                                    }
                                }
                            }
                        }
                    }
                }
            }

            return epiCurveTable;
        }







        [Obsolete]
        public DataTable GenerateStackedBarTable(string xAxisColumn, string yAxisColumn)
        {
            //Input Validation
            if (string.IsNullOrEmpty(xAxisColumn) || string.IsNullOrEmpty(yAxisColumn))
            {
                throw new ApplicationException("No columns specified for SELECT.");
            }
            //


            DataView dv = GenerateView(null);


            if (dv == null || dv.Count <= 0)
            {
                Epi.Windows.MsgBox.ShowInformation(DashboardSharedStrings.ERROR_NO_DATA);
                return null;
            }

            List xAxisValues = new List();
            List yAxisValues = new List();


            foreach (DataRowView rowView in dv)
            {
                DataRow row = rowView.Row;

                string key = null;

                if (!string.IsNullOrEmpty(row[xAxisColumn].ToString()))
                {
                    key = row[xAxisColumn].ToString();
                    if (!string.IsNullOrEmpty(key) && !xAxisValues.Contains(key))
                    {
                        xAxisValues.Add(key);
                    }
                }

                key = null;

                if (!string.IsNullOrEmpty(row[yAxisColumn].ToString()))
                {
                    key = row[yAxisColumn].ToString();

                    if (!string.IsNullOrEmpty(key) && !yAxisValues.Contains(key))
                    {
                        yAxisValues.Add(key);
                    }
                }
            }

            if (IsUsingEpiProject)
            {
                if (yAxisValues.Count == 2)
                {
                    if (
                        (yAxisValues[0] == "False" && yAxisValues[1] == "True")
                        ||
                        (IsColumnYesNo(yAxisColumn) && yAxisValues[0] == "0" && yAxisValues[1] == "1")
                        )
                    {
                        string temp = yAxisValues[0];
                        yAxisValues[0] = yAxisValues[1];
                        yAxisValues[1] = temp;
                    }
                }
                if (xAxisValues.Count == 2)
                {
                    if (
                        (xAxisValues[0] == "False" && xAxisValues[1] == "True")
                        ||
                        (IsColumnYesNo(xAxisColumn) && xAxisValues[0] == "0" && xAxisValues[1] == "1")
                        )
                    {
                        string temp = xAxisValues[0];
                        xAxisValues[0] = xAxisValues[1];
                        xAxisValues[1] = temp;
                    }
                }
            }


            DataTable stackedBarTable = new DataTable("StackedBarTable");
            stackedBarTable.Columns.Add("totals", typeof(int));

            if (IsColumnNumeric(xAxisColumn) && !IsColumnYesNo(xAxisColumn))
            {
                stackedBarTable.Columns.Add(xAxisColumn, typeof(decimal));
            }
            else
            {
                stackedBarTable.Columns.Add(xAxisColumn, typeof(string));
            }

            stackedBarTable.Columns.Add(yAxisColumn, typeof(string));


            foreach (string xs in xAxisValues)
            {
                foreach (string ys in yAxisValues)
                {
                    stackedBarTable.Rows.Add(0, xs, ys);
                }
            }


            foreach (DataRowView rowView in dv)
            {
                DataRow row = rowView.Row;

                foreach (string xs in xAxisValues)
                {
                    if (row[xAxisColumn].ToString() == xs.ToString())
                    {
                        foreach (string ys in yAxisValues)
                        {
                            if (row[yAxisColumn].ToString().Equals(ys))
                            {
                                foreach (DataRow iRow in stackedBarTable.Rows)
                                {
                                    if (iRow[xAxisColumn].ToString().Equals(xs.ToString()) && iRow[yAxisColumn].Equals(ys))
                                    {
                                        iRow["totals"] = Int32.Parse(iRow["totals"].ToString()) + 1;
                                    }
                                }
                            }
                        }
                    }
                }
            }

            if (IsUsingEpiProject)
            {
                foreach (DataRow row in stackedBarTable.Rows)
                {
                    if (row[2].ToString().ToLower().Equals("true") || (IsColumnYesNo(yAxisColumn) && row[2].ToString().Equals("1")))
                    {
                        row[2] = Config.Settings.RepresentationOfYes;
                    }
                    else if (row[2].ToString().ToLower().Equals("false") || (IsColumnYesNo(yAxisColumn) && row[2].ToString().Equals("0")))
                    {
                        row[2] = Config.Settings.RepresentationOfNo;
                    }

                    if (row[1].ToString().ToLower().Equals("true") || (IsColumnYesNo(xAxisColumn) && row[1].ToString().Equals("1")))
                    {
                        row[1] = Config.Settings.RepresentationOfYes;
                    }
                    else if (row[1].ToString().ToLower().Equals("false") || (IsColumnYesNo(xAxisColumn) && row[1].ToString().Equals("0")))
                    {
                        row[1] = Config.Settings.RepresentationOfNo;
                    }
                }
            }

            DataTable sortedStackedBarTable = SortBySingleColumn(stackedBarTable, stackedBarTable.Columns[xAxisColumn]);

            return sortedStackedBarTable;
        }





        public void GenerateRecordCount(bool useFilters)
        {
            lock (syncLock)
            {
                if (ds != null && ds.Tables.Count >= 1 && ds.Tables[0].DefaultView != null)
                {
                    PopulateDataSet();
                    ds.Tables[0].DefaultView.RowFilter = GenerateFilterCriteria();



                    System.Threading.Thread.Sleep(50);

                    RecordCount = ds.Tables[0].DefaultView.Count;
                }
                else
                {
                    if (!string.IsNullOrEmpty(this.CustomQuery))
                    {
                        GenerateView();
                        return;
                    }

                    if (useFilters)
                    {


                        ColumnDataType columnDataType = ColumnDataType.Boolean | ColumnDataType.Numeric | ColumnDataType.Text | ColumnDataType.DateTime;
                        List allFieldNames = GetFieldsAsList(columnDataType);
                        List columnNames = new List();

                        string filterCriteria = GenerateFilterCriteria();

                        if (allFieldNames.Count > 0 && DataFilters.Count == 0 && !UseAdvancedUserDataFilter)
                        {
                            columnNames.Add(allFieldNames[0]);
                        }
                        else
                        {
                            foreach (string columnName in allFieldNames)
                            {
                                if (filterCriteria.ToLower().Contains(columnName.ToLower()))
                                {
                                    columnNames.Add(columnName);
                                }
                            }
                        }


                        DataTable unfilteredTable = GenerateRecordCountTable(columnNames);
                        RecordCount = unfilteredTable.Select(filterCriteria).Length;
                    }
                    else
                    {
                        if (IsUsingEpiProject)
                        {
                            switch (RecordProcessScope)
                            {
                                case RecordProcessingScope.Both:
                                    RecordCount = ((int)Database.ExecuteScalar(Database.CreateQuery("SELECT Count(*) " + View.FromViewSQL + "")));
                                    break;
                                case RecordProcessingScope.Deleted:
                                    RecordCount = ((int)Database.ExecuteScalar(Database.CreateQuery("SELECT Count(*) " + View.FromViewSQL + " WHERE RECSTATUS = 0")));
                                    break;
                                case RecordProcessingScope.Undeleted:
                                default:
                                    RecordCount = ((int)Database.ExecuteScalar(Database.CreateQuery("SELECT Count(*) FROM " + AddBracketsToString(View.TableName) + " WHERE RECSTATUS > 0")));
                                    break;
                            }

                        }
                        else
                        {
                            if (Database.ConnectionDescription.ToLower().StartsWith("mysql"))
                            {
                                try
                                {
                                    RecordCount = Int32.Parse(Database.Select(Database.CreateQuery("Select Count(*) from " + FormatTableName(TableName) + "")).Rows[0][0].ToString());
                                }
                                catch (Exception)
                                {
                                    RecordCount = 0;
                                }
                            }
                            else
                            {
                                RecordCount = ((int)Database.ExecuteScalar(Database.CreateQuery("Select Count(*) from " + FormatTableName(TableName) + "")));
                            }
                        }
                    }
                }
            }
        }







        [Obsolete]
        public void FindUpperLowerNumericValues(string numberColumn, ref decimal  minNum, ref decimal  maxNum)
        {
            //Input Validation
            if (string.IsNullOrEmpty(numberColumn))
            {
                Epi.Windows.MsgBox.ShowError("No column selected.");
                return;
            }
            //

            List columnNames = new List();
            columnNames.Add(numberColumn);

            DataTable filteredTable = GenerateTable(columnNames);
            if (filteredTable == null)
            {
                return;
            }

            string filterCriteria = GenerateFilterCriteria();
            string columnType = GetColumnType(numberColumn);
            try
            {
                if (columnType.Equals("System.Int32") || columnType.Equals("System.Int16") || columnType.Equals("System.Int64"))
                {
                    minNum = (int)filteredTable.Compute("min(" + AddBracketsToString(numberColumn) + ")", filterCriteria);
                    maxNum = (int)filteredTable.Compute("max(" + AddBracketsToString(numberColumn) + ")", filterCriteria);
                }
                else if (columnType.Equals("System.Decimal"))
                {
                    minNum = (decimal)filteredTable.Compute("min(" + AddBracketsToString(numberColumn) + ")", filterCriteria);
                    maxNum = (decimal)filteredTable.Compute("max(" + AddBracketsToString(numberColumn) + ")", filterCriteria);
                }
                else
                {
                    minNum = Convert.ToDecimal(filteredTable.Compute("min(" + AddBracketsToString(numberColumn) + ")", filterCriteria));
                    maxNum = Convert.ToDecimal(filteredTable.Compute("max(" + AddBracketsToString(numberColumn) + ")", filterCriteria));
                }
            }
            catch (InvalidCastException)
            {
                minNum = null;
                maxNum = null;
            }
        }








        public void FindUpperLowerDateValues(string dateColumn, ref DateTime  minDate, ref DateTime  maxDate, DataView dataView = null)
        {
            //Input Validation
            if (string.IsNullOrEmpty(dateColumn))
            {
                Epi.Windows.MsgBox.ShowError("No column selected.");
                return;
            }
            //

            List columnNames = new List();
            columnNames.Add(dateColumn);

            DataView dv = null;

            if (dataView == null)
            {
                dv = GenerateView(null);
            }
            else
            {
                dv = dataView;
            }

            try
            {
                dv.RowFilter = CombineFilters(AddBracketsToString(dateColumn) + " is not null", dv);
                dv.Sort = AddBracketsToString(dateColumn);
                minDate = Convert.ToDateTime(dv[0].Row[dateColumn]);

                dv.Sort = AddBracketsToString(dateColumn) + " DESC";
                maxDate = Convert.ToDateTime(dv[0].Row[dateColumn]);

                if (minDate.HasValue)
                {
                    int year = minDate.Value.Year;
                    int month = minDate.Value.Month;
                    int day = minDate.Value.Day;
                    int hour = minDate.Value.Hour;
                    minDate = new DateTime(year, month, day, hour, 0, 0);
                }

                if (maxDate.HasValue)
                {
                    int year = maxDate.Value.Year;
                    int month = maxDate.Value.Month;
                    int day = maxDate.Value.Day;
                    int hour = maxDate.Value.Hour;
                    int minute = 0;

                    if (maxDate.Value.Minute > 0 || maxDate.Value.Second > 0 || maxDate.Value.Millisecond > 0)
                    {
                        minute = 59;
                    }

                    maxDate = new DateTime(year, month, day, hour, minute, 0);
                }
            }
            catch (InvalidCastException)
            {
                minDate = null;
                maxDate = null;
            }
        }






        public bool ValidateColumnName(string columnName)
        {
            bool isValid = true;

            for (int i = 0; i < columnName.Length; i++)
            {
                string columnNameChar = columnName.Substring(i, 1);
                System.Text.RegularExpressions.Match m = System.Text.RegularExpressions.Regex.Match(columnNameChar, "[A-Za-z0-9_]");
                if (!m.Success)
                {
                    return false;
                }
            }

            return isValid;
        }
        //

        //Private Methods






                XmlElement SerializeRelatedDataConnections(XmlDocument doc)
        {
            System.Xml.XmlElement relatedDataConnections = doc.CreateElement("relatedDataConnections");

            foreach (RelatedConnection rConn in this.ConnectionsForRelate)
            {
                System.Xml.XmlElement relatedDataConnection = doc.CreateElement("relatedDataConnection");
                string xmlString = string.Empty;
                if (rConn.IsEpiInfoProject)
                {
                    xmlString =
                        "" + rConn.view.Project.FilePath + "</projectPath>" +
                        "" + rConn.view.Name + "</viewName>" +
                        "" + string.Empty + "</connectionString>" +
                        "" + string.Empty + "</tableName>";
                }
                else
                {
                    xmlString =
                        "" + string.Empty + "</projectPath>" +
                        "" + string.Empty + "</viewName>" +
                        "" + Configuration.Encrypt(rConn.db.ConnectionString) + "</connectionString>" +
                        "" + rConn.TableName + "</tableName>";
                }
                xmlString = xmlString + "" + rConn.ParentKeyField + "</parentKeyField>";
                xmlString = xmlString + "" + rConn.ChildKeyField + "</childKeyField>";
                xmlString = xmlString + "" + rConn.UseUnmatched + "</useUnmatched>";
                xmlString = xmlString + "" + rConn.SameDataSource + "</sameDataSource>";
                relatedDataConnection.InnerXml = xmlString;
                relatedDataConnections.AppendChild(relatedDataConnection);
            }

            return relatedDataConnections;
        }






                XmlElement SerializeFilters(XmlDocument doc)
        {
            return DataFilters.Serialize(doc);
        }






                XmlElement SerializeRules(XmlDocument doc)
        {
            return Rules.Serialize(doc);
        }




                void Construct()
        {
            this.DataFilters = new DataFilters(this);
            this.Rules = new DashboardRules(this);
            this.RecordCount = 0;
            this.RecordProcessScope = RecordProcessingScope.Undeleted;
            this.ConnectionsForRelate = new List();
            this.UserVarsNeedUpdating = true;
            this.LastCacheTime = DateTime.Now;

            this.Config = Configuration.GetNewInstance();

            Frequency_Row_Limit = Config.Settings.DashboardFrequencyRowLimit;
            LineList_Row_Limit = Config.Settings.DashboardLineListRowLimit;
            Aberration_Row_Limit = Config.Settings.DashboardAberrationRowLimit;
            Frequency_Strata_Limit = Config.Settings.DashboardFrequencyStrataLimit;
            Frequency_Crosstab_Limit = Config.Settings.DashboardFrequencyCrosstabLimit;
            Combined_Frequency_Row_Limit = Config.Settings.DashboardCombinedFrequencyRowLimit;

            this.ds = new DataSet();

            FieldTable = new DataTable("fieldTable");
            FieldTable.Columns.Add(new DataColumn("columnname", typeof(string)));
            FieldTable.Columns.Add(new DataColumn("datatype", typeof(string)));
            FieldTable.Columns.Add(new DataColumn("tablename", typeof(string)));
            FieldTable.Columns.Add(new DataColumn("formname", typeof(string)));
            FieldTable.Columns.Add(new DataColumn("epifieldtype", typeof(Field)));
            DataColumn[] keyColumns = new DataColumn[1];
            keyColumns[0] = FieldTable.Columns[0];
            FieldTable.PrimaryKey = keyColumns;

            this.TableColumnNames = new Dictionary(); 
        }




                void ConstructTableColumnNames()
        {
            if (IsUsingEpiProject)
            {
                TableColumnNames = new Dictionary();
                FieldTable.Rows.Clear();

                TableColumnNames.Add("UniqueKey", "System.Int32");
                FieldTable.Rows.Add("UniqueKey", "System.Int32", View.TableName, View.Name, null);
                TableColumnNames.Add("RecStatus", "System.Int32");
                FieldTable.Rows.Add("RecStatus", "System.Int32", View.TableName, View.Name, null);
                TableColumnNames.Add("FKEY", "System.String");
                FieldTable.Rows.Add("FKEY", "System.String", View.TableName, View.Name, null);

                foreach (Page page in View.Pages)
                {
                    foreach (DataColumn dc in mainTable.Columns)
                    {
                        if (!TableColumnNames.ContainsKey(dc.ColumnName) && !dc.ColumnName.Equals("RECSTATUS"))
                        {
                            TableColumnNames.Add(dc.ColumnName, dc.DataType.ToString());
                            if (View.Fields.Contains(dc.ColumnName))
                            {
                                FieldTable.Rows.Add(dc.ColumnName, dc.DataType.ToString(), page.TableName, View.Name, View.Fields[dc.ColumnName]);
                            }
                        }
                    }
                }


                foreach (Field field in View.Fields)
                {
                    if (field is GroupField && !TableColumnNames.ContainsKey(field.Name))
                    {
                        FieldTable.Rows.Add(field.Name, string.Empty, string.Empty, View.Name, field as GroupField);
                        TableColumnNames.Add(field.Name, field.GetType().ToString());
                    }
                }
            }
            else
            {
                foreach (DataColumn dc in mainTable.Columns)
                {
                    if (!TableColumnNames.ContainsKey(dc.ColumnName))
                    {
                        if (dc.ColumnName.ToLower().Equals("recstatus") && !TableColumnNames.ContainsKey(dc.ColumnName.ToUpper()))
                        {
                            TableColumnNames.Add("RecStatus", dc.DataType.ToString());
                            FieldTable.Rows.Add("RecStatus", dc.DataType.ToString(), TableName, string.Empty, null);
                        }
                        else if (dc.ColumnName.ToLower().Equals("uniquekey"))
                        {
                            TableColumnNames.Add("UniqueKey", dc.DataType.ToString());
                            FieldTable.Rows.Add("UniqueKey", dc.DataType.ToString(), TableName, string.Empty, null);
                        }
                        else
                        {
                            TableColumnNames.Add(dc.ColumnName, dc.DataType.ToString());
                            FieldTable.Rows.Add(dc.ColumnName, dc.DataType.ToString(), TableName, string.Empty, null);
                        }
                    }
                }
            }

            foreach (IDashboardRule rule in this.Rules)
            {
                if (rule is DataAssignmentRule)
                {
                    DataAssignmentRule assignRule = rule as DataAssignmentRule;

                    if (!TableColumnNames.ContainsKey(assignRule.DestinationColumnName))
                    {
                        FieldTable.Rows.Add(assignRule.DestinationColumnName, assignRule.DestinationColumnType);
                        TableColumnNames.Add(assignRule.DestinationColumnName, assignRule.DestinationColumnType);
                    }
                }
            }
        }





        internal void ApplyDashboardRules(IGadgetParameters inputs = null)
        {
            bool onlyGroups = true;

            if (Rules.Count > 0)
            {
                foreach (IDashboardRule rule in Rules)
                {
                    try
                    {
                        rule.SetupRule(mainTable);
                        if (!(rule is Rule_VariableGroup))
                        {
                            onlyGroups = false;
                        }
                    }
                    catch (DefectiveRuleException ex)
                    {
                        FireNotificationEvent(rule, ex.Message);
                    }
                }

                bool doProgressCallbacks = true;

                int count = 0;
                DataView dv = new DataView(mainTable, "", "", DataViewRowState.CurrentRows);

                if ((mainTable.Columns.Count < 250 && dv.Count < 1000) || onlyGroups)
                {
                    doProgressCallbacks = false;
                }

                foreach (DataRowView rowView in dv                         )
                {
                    DataRow row = rowView.Row;
                    row.BeginEdit();
                    foreach (IDashboardRule rule in Rules)
                    {
                        rule.ApplyRule(row);
                    }
                    row.EndEdit();

                    if (inputs != null && doProgressCallbacks)
                    {
                        count++;
                        if (Rules.Count > 0 && count % 100 == 0)
                        {
                            double percent = (double)count / (double)rowView.DataView.Count;
                            inputs.UpdateGadgetStatus(string.Format(SharedStrings.DASHBOARD_GADGET_STATUS_ASSIGNED_VALUES_TO, percent.ToString("P0")));
                            inputs.UpdateGadgetProgress(((double)count / (double)rowView.DataView.Count) * 100);
                        }
                    }
                }
            }

            UserVarsNeedUpdating = false;
        }





                string GenerateRecstatusConditionForSelect()
        {
            if (this.IsUsingEpiProject)
            {
                if (this.RecordProcessScope == RecordProcessingScope.Undeleted)
                {
                    return " where recstatus > 0";
                }
                else if (this.RecordProcessScope == RecordProcessingScope.Deleted)
                {
                    return " where recstatus = 0";
                }
                else if (this.RecordProcessScope == RecordProcessingScope.Both)
                {
                    return " where recstatus >= 0";
                }
            }

            return string.Empty;
        }





                string GenerateFilterCriteria()
        {
            if (UseAdvancedUserDataFilter)
            {
                return AdvancedUserDataFilter;
            }
            else
            {


                return DataFilters.GenerateDataFilterString();

            }

        }

        //ANOVA





                List ConvertTableToListOfLists(DataTable table)
        {
            List columns = new List();



            DataTable dt = table.Clone();

            foreach (DataRow row in table.Rows)
            {
                dt.Rows.Add(row.ItemArray);
            }

            dt.Columns.Remove(dt.Columns[0]);

            int i = 0;





            foreach (DataRow row in dt.Rows)
            {
                bool success = false;
                string line = string.Empty;
                double value = 0;
                foreach (object dstr in row.ItemArray)
                {
                    success = double.TryParse(dstr.ToString(), out value);

                    if (!success)
                    {
                        break;
                    }
                    line = line + dstr.ToString() + "";
                }


                bool zeroSuccess = double.TryParse(line, out value);

                if (zeroSuccess && value == 0)
                {
                    success = false;
                }

                if (success)
                {
                    columns.Add(row.ItemArray.ToList());
                }
                else
                {
                }

                i++;
            }

            return columns;
        }








                double CalculateSSBetween(double grandMean, List observations, List avgs)
        {
            double retval = 0;
            for (int x = 0; x < observations.Count; x++)
            {
                retval += observations[x] * (Math.Pow(avgs[x] - grandMean, 2));
            }
            return retval;
        }







                double CalculateSSWithin(List observations, List vars)
        {
            double retval = 0;
            for (int x = 0; x < observations.Count; x++)
            {
                retval += (observations[x] - 1) * vars[x];
            }
            return retval;
        }









                double CalculateChiSquare(double dfWithin, double pooledVariance, List observations, List vars)
        {
            double denominator = 0;
            double result = 0;

            for (int j = 0; j < observations.Count; j++)
            {
                if ((observations[j] - 1 != 0) && (vars[j] != 0))
                {
                    denominator += 1.0 / (observations[j] - 1);
                    result += (observations[j] - 1) * Math.Log(vars[j]);
                }
                else
                {
                    denominator = 0;
                    result = 0;
                }
            }

            denominator = 1.0 + (1.0 / (3.0 * (observations.Count - 1))) * (denominator - 1.0 / dfWithin);

            if ((denominator != 0) && (pooledVariance != 0))
            {
                result = (1.0 / denominator) * (dfWithin * Math.Log(pooledVariance) - result);
            }

            return result;
        }









                double CalculateKruskalWallisH(DataTable freqHorizontal, DataTable freqVertical, List allLocalFreqs, double recordCount)
        {
            double cf = 0;
            double avgr = 0;
            int greaterSize;
            if (freqHorizontal.Rows.Count > freqVertical.Rows.Count)
                greaterSize = freqHorizontal.Rows.Count;
            else
                greaterSize = freqVertical.Rows.Count;
            double[] sr = new double[greaterSize];
            double adj = 0;
            double H = 0;

            for (int i = 0; i < allLocalFreqs.Count; i++)
            {
                double totalHFreq = (double)freqHorizontal.Rows[i]["freq"];
                cf += totalHFreq;
                avgr = cf - (totalHFreq - 1) / 2.0;
                for (int l = 0; l < allLocalFreqs[0].Count; l++)
                {
                    sr[l] += (double)allLocalFreqs[i][l] * avgr;
                }
                adj += totalHFreq * (Math.Pow(totalHFreq, 2) - 1);
            }

            for (int i = 0; i < freqVertical.Rows.Count; i++)
            {
                double totalVFreq = (double)freqVertical.Rows[i]["freq"];
                if (totalVFreq != 0)
                {
                    H += sr[i] * sr[i] / totalVFreq;
                }
            }

            H = H * 12 / (recordCount * (recordCount + 1)) - 3 * (recordCount + 1);
            H = H / (1 - adj / (Math.Pow(recordCount, 3) - recordCount));

            return H;
        }

        //







                DataTable SortHighToLow(DataTable table, DataColumn column)
        {
            DataView sortedView = new DataView(table, "", AddBracketsToString(column.ColumnName) + " DESC", DataViewRowState.CurrentRows);

            if (sortedView == null || sortedView.Count <= 0)
            {
                return null;
            }

            return sortedView.ToTable();
        }






                DataTable SortBySingleColumn(DataTable table, DataColumn column, SortOrder sort = SortOrder.Ascending)
        {
            //Input Validation
            if (table.Rows.Count == 0)
            {
                return table;
            }
            //

            if (table.Rows.Count == 1)
            {
                return table; 
            }

            string[] abbrMonthNames = CultureInfo.CurrentCulture.DateTimeFormat.AbbreviatedMonthNames;
            string[] abbrDayNames = CultureInfo.CurrentCulture.DateTimeFormat.AbbreviatedDayNames;
            string[] monthNames = CultureInfo.CurrentCulture.DateTimeFormat.MonthNames;
            string[] dayNames = CultureInfo.CurrentCulture.DateTimeFormat.DayNames;
            string[] yesNoValues = new string[3];
            yesNoValues[0] = Config.Settings.RepresentationOfYes;
            yesNoValues[1] = Config.Settings.RepresentationOfNo;
            yesNoValues[2] = Config.Settings.RepresentationOfMissing;
            string[] values = null;

            DataRow[] rowArray = null;
            DataTable sortedTable = new DataTable(table.TableName);
            DataTable unsortedTable = new DataTable(table.TableName);
            unsortedTable = table.Copy();

            string sortColumnName = column.ColumnName;

            string compareValue = table.Rows[0][column.ColumnName].ToString().Trim();
            if (string.IsNullOrEmpty(compareValue))
            {
                compareValue = table.Rows[1][column.ColumnName].ToString().Trim();
            }

            if (values == null)
            {
                foreach (string s in abbrMonthNames)
                {
                    if (s.Equals(compareValue))
                    {
                        values = abbrMonthNames;
                        break;
                    }
                }
            }

            if (values == null)
            {
                foreach (string s in monthNames)
                {
                    if (s.Equals(compareValue))
                    {
                        values = monthNames;
                        break;
                    }
                }
            }

            if (values == null)
            {
                foreach (string s in abbrDayNames)
                {
                    if (s.Equals(compareValue))
                    {
                        values = abbrDayNames;
                        break;
                    }
                }
            }

            if (values == null)
            {
                foreach (string s in dayNames)
                {
                    if (s.Equals(compareValue))
                    {
                        values = dayNames;
                        break;
                    }
                }
            }

            if (values == null)
            {
                if (Config.Settings.RepresentationOfYes.Equals(compareValue) || Config.Settings.RepresentationOfNo.Equals(compareValue) || Config.Settings.RepresentationOfMissing.Equals(compareValue))
                {
                    values = yesNoValues;
                }
            }

            if (values == null && IsUserDefinedColumn(column.ColumnName))
            {
                foreach (IDashboardRule rule in Rules)
                {
                    if (rule is Rule_Recode)
                    {
                        Rule_Recode recodeRule = rule as Rule_Recode;

                        if (recodeRule.DestinationColumnName.ToLower().Equals(column.ColumnName.ToLower()) && !recodeRule.DestinationColumnName.Equals("Yes/No") && recodeRule.ShouldMaintainSortOrder)
                        {
                            if (string.IsNullOrEmpty(recodeRule.ElseValue))
                            {
                                values = new string[recodeRule.RecodeInputTable.Rows.Count];
                            }
                            else
                            {
                                values = new string[recodeRule.RecodeInputTable.Rows.Count + 1];
                            }

                            for (int i = 0; i < recodeRule.RecodeInputTable.Rows.Count; i++)
                            {
                                DataRow row = recodeRule.RecodeInputTable.Rows[i];
                                values[i] = row[recodeRule.RecodeInputTable.Columns.Count - 1].ToString();
                            }

                            if (!string.IsNullOrEmpty(recodeRule.ElseValue))
                            {
                                values[recodeRule.RecodeInputTable.Rows.Count] = recodeRule.ElseValue;
                            }

                            break;
                        }
                    }
                    else if (rule is Rule_Format && (((Rule_Format)rule).FormatType.Equals(FormatTypes.RegularDate) || ((Rule_Format)rule).FormatType.Equals(FormatTypes.LongDate) || ((Rule_Format)rule).FormatType.Equals(FormatTypes.MonthAndFourDigitYear)))
                    {
                        return unsortedTable;
                    }
                }
            }

            string sortClause = " ASC";
            if (sort.Equals(SortOrder.Descending))
            {
                sortClause = " DESC";
            }

            if (values != null)
            {
                DataColumn dc = new DataColumn("___sortvalue___", typeof(int));
                unsortedTable.Columns.Add(dc);

                foreach (DataRow row in unsortedTable.Rows)
                {
                    for (int i = 0; i < values.Length; i++)
                    {
                        string s = values[i];

                        if (s.Equals(row[column.ColumnName].ToString().Trim()))
                        {
                            row["___sortvalue___"] = i;
                        }
                    }
                }
                rowArray = unsortedTable.Select(AddBracketsToString(column.ColumnName) + " is not null", "___sortvalue___" + sortClause + ", " + AddBracketsToString(sortColumnName) + sortClause);
            }
            else
            {
                rowArray = unsortedTable.Select(AddBracketsToString(column.ColumnName) + " is not null", AddBracketsToString(sortColumnName) + sortClause);
            }

            if (sortedTable.Columns.Contains("___sortvalue___"))
            {
                sortedTable.Columns.Remove("___sortvalue___");
            }

            if (unsortedTable.Columns.Contains("___sortvalue___"))
            {
                unsortedTable.Columns.Remove("___sortvalue___");
            }

            DataRow[] missingRowArray = new DataRow[1];
            missingRowArray = unsortedTable.Select(AddBracketsToString(column.ColumnName) + " is null", string.Empty);

            sortedTable = rowArray.CopyToDataTable().DefaultView.ToTable(table.TableName);

            if (missingRowArray.Length == 1)
            {
                sortedTable.Rows.Add(missingRowArray[0].ItemArray);
            }

            return sortedTable;
        }






                List ValidateAndBracketColumnNames(List columnNames)
        {
            //Input Validation
            if (columnNames == null)
            {
                throw new ApplicationException("List of column names cannot be null.");
            }
            //

            List validNames = new List();

            foreach (string columnName in columnNames)
            {
                if (ValidateColumnName(columnName) == false)
                {
                    validNames.Add(AddBracketsToString(columnName));
                }
                else
                {
                    validNames.Add(columnName);
                }
            }

            return validNames;
        }






                string AddBracketsToString(string s)
        {
            //Method Description
            /* Used to standardize the adding of brackets to a string. Necessary to work with non-Epi 7 data
             * sources like Excel documents where column names may have spaces or non-standard characters.
             */
            //

            return StringLiterals.LEFT_SQUARE_BRACKET + s + StringLiterals.RIGHT_SQUARE_BRACKET;
        }







                void ConvertColumnToType(DataTable dt, DataColumn dc, GenericDbColumnType genericColumnType)
        {
            DataColumn convertedColumn = new DataColumn("_____" + dc.ColumnName + "_____5334");

            switch (genericColumnType)
            {
                case GenericDbColumnType.String:
                    convertedColumn.DataType = typeof(string);
                    break;
                case GenericDbColumnType.Int16:
                    convertedColumn.DataType = typeof(Int16);
                    break;
                case GenericDbColumnType.Int32:
                    convertedColumn.DataType = typeof(int);
                    break;
                case GenericDbColumnType.Double:
                    convertedColumn.DataType = typeof(double);
                    break;
                case GenericDbColumnType.Single:
                    convertedColumn.DataType = typeof(Single);
                    break;
                case GenericDbColumnType.Decimal:
                    convertedColumn.DataType = typeof(decimal);
                    break;
                case GenericDbColumnType.DateTime:
                case GenericDbColumnType.Date:
                case GenericDbColumnType.Time:
                    convertedColumn.DataType = typeof(DateTime);
                    break;
                default:
                    throw new ApplicationException("Cannot convert column type.");
            }

            dt.Columns.Add(convertedColumn);

            foreach (DataRow row in dt.Rows)
            {
                row[convertedColumn.ColumnName] = row[dc.ColumnName];
            }

            convertedColumn.SetOrdinal(dc.Ordinal);
            dt.Columns.Remove(dc);
            convertedColumn.ColumnName = dc.ColumnName;
        }





                void AddOptionLabelsToFreqTable(DataTable dt)
        {
            //Input Validation
            if (dt == null)
            {
                throw new ArgumentNullException("dt");
            }
            //

            if (dt.Rows.Count == 0)
            {
                return;
            }




            Field field = GetAssociatedField(dt.Columns[0].ColumnName);

            if (field == null)
            {
                return;
            }

            int numberOfRowsProcessed = 0;
            int totalRows = dt.Rows.Count;

            if (field is OptionField && (field as OptionField).Options.Count > 0)
            {
                OptionField optionField = field as OptionField;
                List options = new List();

                options.AddRange(optionField.Options);
                Dictionary fieldValues = new Dictionary(StringComparer.OrdinalIgnoreCase);

                if (dt.Columns[0].DataType.ToString().Equals("System.Int16"))
                {
                    ConvertColumnToType(dt, dt.Columns[0], GenericDbColumnType.String);
                }

                for (int i = 0; i < options.Count; i++)
                {
                    string option = options[i];
                    foreach (DataRow fRow in dt.Rows)
                    {
                        string fValue = fRow[0].ToString();
                        if (fValue.Equals(i.ToString()))
                        {
                            fRow[0] = option;
                            numberOfRowsProcessed++;
                        }

                        if (numberOfRowsProcessed >= totalRows)
                        {
                            break;
                        }
                    }

                    if (numberOfRowsProcessed >= totalRows)
                    {
                        break;
                    }
                }
            }
        }





                void AddOptionLabelsToListTable(DataTable dt)
        {
            //Input Validation
            if (dt == null)
            {
                throw new ArgumentNullException("dt");
            }
            //

            if (dt.Rows.Count == 0)
            {
                return;
            }




            Dictionary optionFields = new Dictionary();
            List columnsToConvert = new List();

            foreach (DataColumn dc in dt.Columns)
            {
                Field field = GetAssociatedField(dc.ColumnName);
                if (field is OptionField)
                {
                    optionFields.Add(field as OptionField, dc.Ordinal);

                    if (dc.DataType.ToString().Equals("System.Int16"))
                    {
                        columnsToConvert.Add(dc);
                    }
                }
            }

            foreach (DataColumn dc in columnsToConvert)
            {
                ConvertColumnToType(dt, dc, GenericDbColumnType.String);
            }

            if (optionFields.Count > 0)
            {
                foreach (DataRow fRow in dt.Rows)
                {
                    foreach (KeyValuePair kvp in optionFields)
                    {
                        string fValue = fRow[kvp.Value].ToString();
                        OptionField optionField = kvp.Key;
                        List options = new List();

                        options.AddRange(optionField.Options);

                        for (int i = 0; i < options.Count; i++)
                        {
                            string option = options[i];

                            if (fValue.Equals(i.ToString()))
                            {
                                fRow[kvp.Value] = option;
                            }
                        }
                    }
                }
            }
        }












                void FireNotificationEvent(object sender, string message)
        {
            if (NotificationEvent != null)
            {
                NotificationEvent(sender, message);
            }
        }





                void AddCommentLegalLabelsToFreqTable(DataTable dt, string freqVar, string crosstabVar)
        {
            //Input Validation
            if (dt == null)
            {
                throw new ArgumentNullException("dt");
            }
            //

            if (dt.Rows.Count == 0)
            {
                return;
            }

            Field field = GetAssociatedField(dt.Columns[0].ColumnName);

            if (field == null)
            {
                return;
            }

            Field crosstabField = GetAssociatedField(crosstabVar);

            int numberOfRowsProcessed = 0;
            int totalRows = dt.Rows.Count;

            if (field is DDLFieldOfCommentLegal && !string.IsNullOrEmpty(((TableBasedDropDownField)field).TextColumnName.Trim()))
            {
                DataTable codeDataTable = ((TableBasedDropDownField)field).GetSourceData();
                Dictionary fieldValues = new Dictionary(StringComparer.OrdinalIgnoreCase);

                foreach (System.Data.DataRow row in codeDataTable.Rows)
                {
                    string key = row[((TableBasedDropDownField)field).TextColumnName.Trim()].ToString();
                    int dash = key.IndexOf('-');
                    string newKey = key.Substring(0, dash);

                    foreach (DataRow fRow in dt.Rows)
                    {
                        string fValue = fRow[0].ToString();
                        if (fValue.Equals(newKey))
                        {
                            fRow[0] = key;
                            numberOfRowsProcessed++;
                        }

                        if (numberOfRowsProcessed >= totalRows)
                        {
                            break;
                        }
                    }

                    if (numberOfRowsProcessed >= totalRows)
                    {
                        break;
                    }
                }
            }

            if (crosstabField != null && crosstabField is DDLFieldOfCommentLegal && !string.IsNullOrEmpty(((TableBasedDropDownField)crosstabField).TextColumnName.Trim()))
            {
                DataTable codeDataTable = ((TableBasedDropDownField)crosstabField).GetSourceData();
                Dictionary fieldValues = new Dictionary(StringComparer.OrdinalIgnoreCase);

                foreach (System.Data.DataRow row in codeDataTable.Rows)
                {
                    string key = row[((TableBasedDropDownField)crosstabField).TextColumnName.Trim()].ToString();
                    int dash = key.IndexOf('-');
                    string newKey = key.Substring(0, dash);

                    for (int i = 1; i < dt.Columns.Count; i++)
                    {
                        DataColumn dc = dt.Columns[i];
                        string fValue = dc.ColumnName;
                        if (fValue.Equals(newKey))
                        {
                            dc.ColumnName = key;
                        }
                    }
                }
            }
        }





                void AddCommentLegalLabelsToListTable(DataTable dt)
        {
            //Input Validation
            if (dt == null)
            {
                throw new ArgumentNullException("dt");
            }
            //

            if (dt.Rows.Count == 0)
            {
                return;
            }

            Dictionary optionFields = new Dictionary();
            Dictionary optionFieldData = new Dictionary();

            foreach (DataColumn dc in dt.Columns)
            {
                Field field = GetAssociatedField(dc.ColumnName);
                if (field is DDLFieldOfCommentLegal)
                {
                    optionFields.Add(field as DDLFieldOfCommentLegal, dc.Ordinal);
                }
            }

            if (optionFields.Count > 0)
            {
                foreach (KeyValuePair kvp in optionFields)
                {
                    DataTable codeDataTable = kvp.Key.GetSourceData();
                    optionFieldData.Add(kvp.Key, codeDataTable);
                }

                foreach (DataRow fRow in dt.Rows)
                {
                    foreach (KeyValuePair kvp in optionFields)
                    {
                        string fValue = fRow[kvp.Value].ToString();

                        DataTable codeDataTable = optionFieldData[kvp.Key];
                        Dictionary fieldValues = new Dictionary(StringComparer.OrdinalIgnoreCase);

                        foreach (System.Data.DataRow row in codeDataTable.Rows)
                        {
                            string key = row[kvp.Key.TextColumnName.Trim()].ToString();
                            int dash = key.IndexOf('-');
                            string newKey = key.Substring(0, dash);

                            if (fValue.Equals(newKey))
                            {
                                fRow[kvp.Value] = key;
                            }
                        }
                    }
                }
            }
        }





                void AddSupplementaryColumnNames(List columnNames)
        {
            if (UseAdvancedUserDataFilter)
            {
                if (!string.IsNullOrEmpty(AdvancedUserDataFilter))
                {
                    foreach (KeyValuePair kvp in TableColumnNames)
                    {
                        if (AdvancedUserDataFilter.ToLower().Contains(kvp.Key.ToLower()) && !columnNames.Contains(kvp.Key, caseInsensitiveEqualityComparer))
                        {
                            columnNames.Add(kvp.Key);
                        }
                    }
                }
            }
            else
            {
                foreach (FilterCondition condition in DataFilters)
                {
                    if (!columnNames.Contains(condition.RawColumnName, caseInsensitiveEqualityComparer))
                    {
                        columnNames.Add(condition.RawColumnName);
                    }
                }
            }

            if (IsUsingEpiProject)
            {
                columnNames.Add("RecStatus");
            }

            foreach (IDashboardRule rule in Rules)
            {
                if (rule is Rule_Recode)
                {
                    Rule_Recode recodeRule = rule as Rule_Recode;
                    if (columnNames.Contains(recodeRule.DestinationColumnName, caseInsensitiveEqualityComparer) && !columnNames.Contains(recodeRule.SourceColumnName, caseInsensitiveEqualityComparer))
                    {
                        columnNames.Add(recodeRule.SourceColumnName);
                    }
                }
                else if (rule is Rule_Format)
                {
                    Rule_Format formatRule = rule as Rule_Format;
                    if (columnNames.Contains(formatRule.DestinationColumnName, caseInsensitiveEqualityComparer) && !columnNames.Contains(formatRule.SourceColumnName, caseInsensitiveEqualityComparer))
                    {
                        columnNames.Add(formatRule.SourceColumnName);
                    }
                }
                else if (rule is Rule_SimpleAssign)
                {
                    Rule_SimpleAssign simpleAssignRule = rule as Rule_SimpleAssign;
                    ColumnDataType columnDataType = ColumnDataType.Boolean | ColumnDataType.DateTime | ColumnDataType.Numeric | ColumnDataType.Text;
                    List fieldNames = this.GetFieldsAsList(columnDataType);
                    foreach (string parameter in simpleAssignRule.AssignmentParameters)
                    {
                        if (!columnNames.Contains(parameter, caseInsensitiveEqualityComparer) && fieldNames.Contains(parameter, caseInsensitiveEqualityComparer))
                        {
                            columnNames.Add(parameter);
                        }
                    }
                }
                else if (rule is Rule_ExpressionAssign)
                {
                    Rule_ExpressionAssign expressionAssignRule = rule as Rule_ExpressionAssign;
                    ColumnDataType columnDataType = ColumnDataType.Boolean | ColumnDataType.Numeric | ColumnDataType.Text;
                    List fieldNames = this.GetFieldsAsList(columnDataType);
                    foreach (string fieldName in fieldNames)
                    {
                        if (expressionAssignRule.Expression.ToLower().Contains(fieldName.ToLower()) && !columnNames.Contains(fieldName, caseInsensitiveEqualityComparer))
                        {
                            columnNames.Add(fieldName);
                        }
                    }
                }
            }
        }






        public DataTable GenerateDuplicatesTable(DuplicatesListParameters parameters)
        {
            //Input Validation




            //

            List allColumnNames = new List();
            foreach (string s in parameters.ColumnNames)
            {
                allColumnNames.Add(s);
            }
            foreach (string s in parameters.KeyColumnNames)
            {
                allColumnNames.Add(s);
            }

            string[] keyColumnNames = parameters.KeyColumnNames.ToArray();
            object[] lastValues;
            DataTable duplicatesTable;

            lastValues = new object[keyColumnNames.Length];
            duplicatesTable = new DataTable();

            foreach (string columnName in keyColumnNames)
            {
                if (!duplicatesTable.Columns.Contains(columnName))
                {
                    Type type = mainTable.Columns[columnName].DataType;
                    duplicatesTable.Columns.Add(columnName, type);

                    if (type.ToString().Equals("System.Single") || type.ToString().Equals("System.Double"))
                    {
                        duplicatesTable.Columns[columnName].DataType = typeof(decimal);
                    }
                }
            }

            foreach (string columnName in parameters.ColumnNames)
            {
                if (!duplicatesTable.Columns.Contains(columnName))
                {
                    Type type = mainTable.Columns[columnName].DataType;
                    duplicatesTable.Columns.Add(columnName, type);
                }
            }

            List safeColumnNames = new List();

            foreach (string s in keyColumnNames)
            {
                safeColumnNames.Add(s);
            }

            foreach (string s in parameters.ColumnNames)
            {
                safeColumnNames.Add(s);
            }













            DataView sourceView = ds.Tables[0].DefaultView;
            DataView sortedSourceView = new DataView(ds.Tables[0], sourceView.RowFilter, string.Join(", ", safeColumnNames.ToArray()), DataViewRowState.CurrentRows);
            bool isFirstDuplicate = true;
            DataRow lastRow = null;

            foreach (DataRowView rowView in sortedSourceView)
            {
                DataRow row = rowView.Row;
                if (ColumnValuesAreEqual(lastValues, row, keyColumnNames))
                {
                    if (isFirstDuplicate)
                    {
                        duplicatesTable.Rows.Add(lastRow);
                        isFirstDuplicate = false;
                    }
                    duplicatesTable.Rows.Add(CreateRowClone(row, duplicatesTable.NewRow(), allColumnNames.ToArray()));
                }
                else
                {
                    isFirstDuplicate = true;
                }
                lastRow = CreateRowClone(row, duplicatesTable.NewRow(), allColumnNames.ToArray());
                SetLastValues(lastValues, row, keyColumnNames);
            }

            OrderColumns(duplicatesTable, parameters.SortColumnsByTabOrder);

            return duplicatesTable;
        }







                DataTable SelectDistinct(DataTable sourceTable, params string[] columnNames)
        {
            //Input Validation
            if (columnNames == null || columnNames.Length == 0)
            {
                throw new ArgumentNullException("columnNames");
            }
            //

            object[] lastValues;
            DataTable distinctTable;

            lastValues = new object[columnNames.Length];
            distinctTable = new DataTable();

            foreach (string columnName in columnNames)
            {
                Type type = sourceTable.Columns[columnName].DataType;
                distinctTable.Columns.Add(columnName, type);
                if (type.ToString().Equals("System.Single") || type.ToString().Equals("System.Double"))
                {
                    distinctTable.Columns[columnName].DataType = typeof(decimal);
                }
            }

            DataTable dt = new DataTable();

            if (columnNames.Length != 0 && columnNames.Length == 1 && sourceTable.Columns.Count == 1 && columnNames[0].Equals(sourceTable.Columns[0].ColumnName))
            {
                dt = sourceTable;

                foreach (DataRow row in dt.Rows)
                {
                    if (!ColumnValuesAreEqual(lastValues, row, columnNames))
                    {
                        distinctTable.Rows.Add(CreateRowClone(row, distinctTable.NewRow(), columnNames));
                        SetLastValues(lastValues, row, columnNames);
                    }
                }
            }
            else
            {
                List columnsToRemove = new List();
                foreach (DataColumn column in sourceTable.Columns)
                {
                    bool found = false;
                    foreach (string s in columnNames)
                    {
                        if (column.ColumnName.ToLower().Equals(s.ToLower()))
                        {
                            found = true;
                        }
                    }

                    if (!found)
                    {
                        columnsToRemove.Add(column);
                    }
                }

                dt = sourceTable.DefaultView.ToTable(false, columnNames);

                foreach (DataColumn dc in columnsToRemove)
                {
                    try
                    {
                        bool canRemove = dt.Columns.CanRemove(dc);

                        if (canRemove)
                        {
                            dt.Columns.Remove(dc.ColumnName);
                        }
                        else
                        {
                            dt.PrimaryKey = null;
                            DataColumn dc1 = dt.Columns[dc.ColumnName];
                            dt.Columns.Remove(dc1);
                        }
                    }
                    catch (ArgumentException)
                    {

                    }
                }

                string[] safeColumnNames = new string[columnNames.Length];

                for (int i = 0; i < columnNames.Length; i++)
                {
                    safeColumnNames[i] = AddBracketsToString(columnNames[i]);
                }


                DataView orderedView = new DataView(dt, "", string.Join(", ", safeColumnNames), DataViewRowState.CurrentRows);

                foreach (DataRowView rowView in orderedView)
                {
                    DataRow row = rowView.Row;

                    if (!ColumnValuesAreEqual(lastValues, row, columnNames))
                    {
                        distinctTable.Rows.Add(CreateRowClone(row, distinctTable.NewRow(), columnNames));
                        SetLastValues(lastValues, row, columnNames);
                    }
                }
            }

            return distinctTable;
        }






                DataTable SelectDistinct(DataView sourceView, params string[] columnNames)
        {
            //Input Validation
            if (columnNames == null || columnNames.Length == 0)
            {
                throw new ArgumentNullException("columnNames");
            }
            //

            object[] lastValues;
            DataTable distinctTable;

            lastValues = new object[columnNames.Length];
            distinctTable = new DataTable();

            foreach (string columnName in columnNames)
            {
                Type type = mainTable.Columns[columnName].DataType;
                distinctTable.Columns.Add(columnName, type);

                if (type.ToString().Equals("System.Single") || type.ToString().Equals("System.Double"))
                {
                    distinctTable.Columns[columnName].DataType = typeof(decimal);
                }
            }

            string[] safeColumnNames = new string[columnNames.Length];

            for (int i = 0; i < columnNames.Length; i++)
            {
                safeColumnNames[i] = AddBracketsToString(columnNames[i]);
            }

            DataView sortedSourceView = new DataView(ds.Tables[0], sourceView.RowFilter, string.Join(", ", safeColumnNames), DataViewRowState.CurrentRows);
            foreach (DataRowView rowView in sortedSourceView)
            {
                DataRow row = rowView.Row;
                if (!ColumnValuesAreEqual(lastValues, row, columnNames))
                {
                    distinctTable.Rows.Add(CreateRowClone(row, distinctTable.NewRow(), columnNames));
                    SetLastValues(lastValues, row, columnNames);
                }
            }

            return distinctTable;
        }














                DataTable SelectDistinct(string sortColumn, DataView sourceView, params string[] columnNames)
        {
            //Input Validation
            if (columnNames == null || columnNames.Length == 0)
            {
                throw new ArgumentNullException("columnNames");
            }
            //

            object[] lastValues;
            DataTable distinctTable;


            lastValues = new object[columnNames.Length];
            distinctTable = new DataTable();

            foreach (string columnName in columnNames)
            {
                distinctTable.Columns.Add(columnName, mainTable.Columns[columnName].DataType);
            }

            string names = sortColumn + "," + string.Join(",", columnNames);

            DataView sortedView = new DataView(mainTable, sourceView.RowFilter, names, DataViewRowState.CurrentRows);



            foreach (DataRowView rowView in sortedView)
            {
                DataRow row = rowView.Row;


                if (!ColumnValuesAreEqual(lastValues, row, columnNames))
                {
                    distinctTable.Rows.Add(CreateRowClone(row, distinctTable.NewRow(), columnNames));
                    SetLastValues(lastValues, row, columnNames);
                }
            }
            return distinctTable;
        }








                bool ColumnValuesAreEqual(object[] lastValues, DataRow currentRow, string[] columnNames)
        {
            bool equal = true;

            for (int i = 0; i < columnNames.Length; i++)
            {
                if (lastValues[i] == null || !lastValues[i].Equals(currentRow[columnNames[i]]))
                {
                    equal = false;
                    break;
                }
            }
            return equal;
        }








                DataRow CreateRowClone(DataRow sourceRow, DataRow newRow, string[] columnNames)
        {
            foreach (string field in columnNames)
            {
                newRow[field] = sourceRow[field];
            }
            return newRow;
        }







                void SetLastValues(object[] lastValues, DataRow sourceRow, string[] columnNames)
        {
            for (int i = 0; i < columnNames.Length; i++)
            {
                lastValues[i] = sourceRow[columnNames[i]];
            }
        }










                DescriptiveStatistics DoMeans(FrequencyParametersBase inputs, DataTable table, DataTable freqTable, string filter, string outerFilter)
        {
            DescriptiveStatistics means = new DescriptiveStatistics();

            string freqVar = inputs.ColumnNames[0];
            string weightVar = inputs.WeightVariableName;
            string crosstabVar = inputs.CrosstabVariableName;
            bool includeFullSummaryStatistics = inputs.IncludeFullSummaryStatistics;

            string safeFreqVar = AddBracketsToString(freqVar);
            string safeWeightVar = AddBracketsToString(weightVar);
            string safeCrosstabVar = AddBracketsToString(crosstabVar);

            if (string.IsNullOrEmpty(filter))
            {
                filter = safeFreqVar + " is not null";
            }
            else
            {
                filter = filter + " and " + safeFreqVar + " is not null";
            }

            if (!string.IsNullOrEmpty(outerFilter))
            {
                outerFilter = outerFilter + " and " + safeFreqVar + " is not null";
            }
            else
            {
                outerFilter = safeFreqVar + " is not null";
            }

            if (!string.IsNullOrEmpty(weightVar))
            {
                DataTable sortedFilteredTable = SortBySingleColumn(table, table.Columns[weightVar]);

                if (inputs.Worker != null && inputs.Worker.CancellationPending == true)
                {
                    means.observations = -1;
                    return means;
                }

                try
                {
                    means.observations = Convert.ToDouble(sortedFilteredTable.Compute("sum(" + safeWeightVar + ")", filter));
                }
                catch (InvalidCastException)
                {
                    means.observations = 0;
                    return means;
                }

                if (includeFullSummaryStatistics)
                {
                    DataColumn squaresColumn = new DataColumn();
                    squaresColumn.DataType = typeof(double);
                    squaresColumn.ColumnName = "___squares___";
                    squaresColumn.Expression = safeWeightVar + "*" + safeFreqVar;
                    sortedFilteredTable.Columns.Add(squaresColumn);

                    means.sum = Convert.ToDouble(sortedFilteredTable.Compute("sum(" + AddBracketsToString(squaresColumn.ColumnName) + ")", filter));
                    means.min = Convert.ToDouble(sortedFilteredTable.Compute("min(" + safeFreqVar + ")", filter));
                    means.max = Convert.ToDouble(sortedFilteredTable.Compute("max(" + safeFreqVar + ")", filter));
                    means.mean = means.sum / means.observations;

                    double grandObservations = Convert.ToDouble(sortedFilteredTable.Compute("sum(" + safeWeightVar + ")", outerFilter));
                    double grandSum = Convert.ToDouble(sortedFilteredTable.Compute("sum(" + AddBracketsToString(squaresColumn.ColumnName) + ")", outerFilter));



                    means.grandMean = grandSum / grandObservations; //Convert.ToDouble(sortedFilteredTable.Select(outerFilter, string.Empty).CopyToDataTable().DefaultView.ToTable(sortedFilteredTable.TableName).Compute("avg(" + AddBracketsToString(freqVar) + ")", string.Empty));

                    DataColumn varCalcColumn = new DataColumn();
                    varCalcColumn.DataType = typeof(double);
                    varCalcColumn.ColumnName = "___varcalc___";
                    varCalcColumn.Expression = "((" + safeFreqVar + "*" + safeFreqVar + ") * " + safeWeightVar + ")";
                    sortedFilteredTable.Columns.Add(varCalcColumn);


                    double sumOfSquares = 0.0;
                    double mean = means.mean.Value;
                    int k = 0;
                    foreach (System.Data.DataRow row in sortedFilteredTable.Select(filter, safeFreqVar + " ASC"  /*,  freqVar + " ASC"*/))
                    {
                        double temp;
                        double.TryParse(row[freqVar].ToString(), out temp);
                        double currentCount;

                        double.TryParse(row[weightVar].ToString(), out currentCount);

                        sumOfSquares += Math.Pow(temp - mean, 2) * currentCount;
                        k++;
                    }



                    means.variance = sumOfSquares / (k - 1); 
                    means.unweightedObservations = (double)k;


                    if (means.variance != null)
                    {
                        means.stdDev = Math.Sqrt((double)means.variance);
                    }



                    DataRow[] rows = sortedFilteredTable.Select(filter, safeFreqVar + " ASC"  /*,  freqVar + " ASC"*/);

                    DataTable weightTable = new DataTable();
                    DataColumn countColumn = new DataColumn();
                    countColumn.DataType = typeof(double);
                    countColumn.ColumnName = "___count___";
                    weightTable.Columns.Add(countColumn);

                    int rowCounter = 0;
                    foreach (System.Data.DataRow row in rows)
                    {
                        if (!string.IsNullOrEmpty(row[weightVar].ToString()))
                        {
                            double frequencyValue;

                            bool successValue = double.TryParse(row[freqVar].ToString(), out frequencyValue);

                            double weightValue = 1;
                            bool successWeight = double.TryParse(row[weightVar].ToString(), out weightValue);

                            if (successWeight && successValue)
                            {
                                rowCounter++;
                                for (double i = 0; i < weightValue; i++)
                                {
                                    weightTable.Rows.Add(frequencyValue);
                                }
                            }
                        }
                    }

                    rows = weightTable.Select(string.Empty, countColumn.ColumnName + " ASC");

                    double quartileResult = 0;


                    if (((double)rows.Length / 2.0) % 1 > 0)
                    {
                        int medianPosition = (rows.Length / 2);
                        means.median = Convert.ToDouble(rows[medianPosition][countColumn.ColumnName]);

                        quartileResult = (double)rows.Length / 4.0;
                    }
                    else if (rows.Length > 1)
                    {
                        int lowerMedianPosition = (rows.Length / 2) - 1;
                        int upperMedianPosition = (rows.Length / 2);
                        means.median = (Convert.ToDouble(rows[lowerMedianPosition][countColumn.ColumnName]) + Convert.ToDouble(rows[upperMedianPosition][countColumn.ColumnName])) / 2.0;

                        quartileResult = (double)rows.Length / 4.0;
                    }


                    if ((quartileResult / 2.0) % 1 > 0)
                    {
                        int q1Position = (int)quartileResult;
                        means.q1 = Convert.ToDouble(rows[q1Position][countColumn.ColumnName]);
                        means.q3 = Convert.ToDouble(rows[rows.Length - 1 - q1Position][countColumn.ColumnName]);
                    }
                    else
                    {
                        int lowerQ1Position = ((int)quartileResult) - 1;
                        int upperQ1Position = ((int)quartileResult);
                        means.q1 = (Convert.ToDouble(rows[lowerQ1Position][countColumn.ColumnName]) + Convert.ToDouble(rows[upperQ1Position][countColumn.ColumnName])) / 2.0;
                        means.q3 = (Convert.ToDouble(rows[rows.Length - 1 - lowerQ1Position][countColumn.ColumnName]) + Convert.ToDouble(rows[rows.Length - 1 - upperQ1Position][countColumn.ColumnName])) / 2.0;
                    }

                    DataTable modeTable = weightTable.Clone();

                    foreach (DataRow row in weightTable.Rows)
                    {
                        modeTable.Rows.Add(row.ItemArray);
                    }

                    means.mode = GetMode(new DataView(modeTable), countColumn.ColumnName);

                    sortedFilteredTable.Columns.Remove(squaresColumn.ColumnName);
                    sortedFilteredTable.Columns.Remove(varCalcColumn.ColumnName);
                }
            }
            else
            {





                DataView dv = new DataView(table, filter, string.Empty, DataViewRowState.CurrentRows);

                if (dv.Count == 0)
                {
                    return means;
                }

                if (inputs.Worker != null && inputs.Worker.CancellationPending == true)
                {
                    means.observations = -1;
                    return means;
                }










                DataView sortedDv = new DataView(table, filter, table.Columns[freqVar].ToString(), DataViewRowState.CurrentRows);

                if (inputs.Worker != null && inputs.Worker.CancellationPending == true)
                {
                    means.observations = -1;
                    return means;
                }

                means.observations = Convert.ToDouble(                       table.Compute("count(" + safeFreqVar + ")", filter));
                means.unweightedObservations = means.observations;
                means.mode = 0;

                if (includeFullSummaryStatistics)
                {
                    try
                    {
                        means.sum = Convert.ToDouble(                       table.Compute("sum(" + safeFreqVar + ")", filter));
                        means.min = Convert.ToDouble(                       table.Compute("min(" + safeFreqVar + ")", filter));
                        means.max = Convert.ToDouble(                       table.Compute("max(" + safeFreqVar + ")", filter));
                        means.mean = means.sum / means.observations;

                        string grandMeanFilter = outerFilter;

                        if (!string.IsNullOrEmpty(crosstabVar))
                        {
                            grandMeanFilter = grandMeanFilter + " and " + safeCrosstabVar + " is not null";

                            if (GetColumnType(freqVar).Equals("System.Byte") || GetColumnType(freqVar).Equals("System.Int16") || GetColumnType(freqVar).Equals("System.Int32"))
                            {
                                DataTable copyOfTable = table.Clone();
                                DataColumn dc = copyOfTable.Columns[freqVar];

                                if (dc.DataType.ToString().Equals("System.Byte") || dc.DataType.ToString().Equals("System.Int16") || GetColumnType(freqVar).Equals("System.Int32"))
                                {
                                    dc.DataType = typeof(decimal);
                                }

                                foreach (DataRow row in table.Rows)
                                {
                                    copyOfTable.ImportRow(row);
                                }

                                DataTable tempTable = copyOfTable.Select(grandMeanFilter, string.Empty).CopyToDataTable().DefaultView.ToTable(copyOfTable.TableName);
                                means.grandMean = Convert.ToDouble(tempTable.Compute("avg(" + safeFreqVar + ")", string.Empty));
                            }
                            else
                            {





                                double total = 0;
                                DataView avgDataView = new DataView(table, grandMeanFilter, string.Empty, DataViewRowState.CurrentRows);
                                foreach (DataRowView dataRowView in avgDataView)
                                {
                                    DataRow row = dataRowView.Row;
                                    double value;
                                    bool success = double.TryParse(row[freqVar].ToString(), out value);
                                    if (success)
                                    {
                                        total = total + value;
                                    }
                                }

                                means.grandMean = total / (double)avgDataView.Count;
                            }
                        }
                        else
                        {
                            means.grandMean = means.mean;
                        }
                    }
                    catch (InvalidCastException)
                    {

                    }
                    try
                    {
                        DataColumn varCalcColumn = new DataColumn();
                        varCalcColumn.DataType = typeof(double);
                        varCalcColumn.ColumnName = "___varcalc___";

                        varCalcColumn.Expression = "(" + safeFreqVar + "*" + safeFreqVar + ")";
                        table.Columns.Add(varCalcColumn);

                        double sumOfSquares = Convert.ToDouble(table.Compute("sum(" + varCalcColumn.ColumnName + ")", filter));
                        means.variance = (sumOfSquares - means.sum * means.mean) / (means.observations - 1);


                        table.Columns.Remove(varCalcColumn.ColumnName);

                        if (means.variance != null)
                        {
                            means.stdDev = Math.Sqrt((double)means.variance);
                            means.stdError = means.stdDev / Math.Sqrt((double)means.observations);
                            means.tZero = means.mean / means.stdError;
                            means.tZeroP = 2.0 * Epi.Statistics.SharedResources.PFromT((double)means.tZero, (int)means.observations - 1);
                        }

                    }
                    catch (InvalidCastException)
                    {

                    }

                    if (sortedDv.Count >= 1)
                    {
                        double quartileResult = 0;


                        if (((double)sortedDv.Count / 2.0) % 1 > 0)
                        {
                            int medianPosition = (sortedDv.Count / 2);

                            means.median = Convert.ToDouble(sortedDv[medianPosition].Row[freqVar]);

                            quartileResult = (double)sortedDv.Count / 4.0;
                        }
                        else if (sortedDv.Count > 1)
                        {
                            int lowerMedianPosition = (sortedDv.Count / 2) - 1;
                            int upperMedianPosition = (sortedDv.Count / 2);
                            means.median = (Convert.ToDouble(sortedDv[lowerMedianPosition].Row[freqVar])
                                +
                                Convert.ToDouble(sortedDv[upperMedianPosition].Row[freqVar])) / 2.0;

                            quartileResult = (double)sortedDv.Count / 4.0;
                        }

                        if (((double)sortedDv.Count / 4.0) % 1 > 0)
                        {
                            int q1Position = (int)quartileResult;
                            means.q1 = Convert.ToDouble(sortedDv[q1Position].Row[freqVar]                                                 );
                            means.q3 = Convert.ToDouble(sortedDv[sortedDv.Count - 1 - q1Position].Row[freqVar]
                                                                                                                      );
                        }
                        else
                        {
                            int lowerQ1Position = ((int)quartileResult) - 1;
                            int upperQ1Position = ((int)quartileResult);
                            means.q1 = (Convert.ToDouble(sortedDv[lowerQ1Position].Row[freqVar]) + Convert.ToDouble(sortedDv[upperQ1Position].Row[freqVar])) / 2.0;
                            means.q3 = (Convert.ToDouble(sortedDv[sortedDv.Count - 1 - lowerQ1Position].Row[freqVar]) + Convert.ToDouble(sortedDv[sortedDv.Count - 1 - upperQ1Position].Row[freqVar])) / 2.0;
                        }

                        means.mode = GetMode(                                              sortedDv, freqVar);
                    }







                }



            }
            return means;
        }







                double GetMode(                                                     DataView modeView, string columnName)
        {


            List frequencyValues = new List();

            foreach (DataRowView rowView in modeView)
            {
                DataRow row = rowView.Row;

                double rowValue = 0;
                bool success = Double.TryParse(row[columnName].ToString(), out rowValue);

                if (success)
                {
                    frequencyValues.Add(rowValue);
                }
            }
            var mode = LINQ.GroupBy(     frequencyValues).OrderByDescending(     frequencyValues.Count()).Select(     frequencyValues.Key).FirstOrDefault();
            return mode;
        }






                DataTable GenerateRecordCountTable(List columnNames = null)
        {
            DataTable unfilteredTable = new DataTable("unfilteredTable");
            List columnsToSelect = new List();

            if (columnNames != null)
            {
                foreach (KeyValuePair kvp in TableColumnNames)
                {
                    string columnName = kvp.Key;
                    foreach (IDashboardRule rule in Rules)
                    {
                        if (rule is Rule_ExpressionAssign)
                        {
                            Rule_ExpressionAssign expressionAssignRule = rule as Rule_ExpressionAssign;
                            if (expressionAssignRule.Expression.ToLower().Contains(columnName.ToLower()) && !columnNames.Contains(columnName, caseInsensitiveEqualityComparer))
                            {
                                columnNames.Add(columnName);
                            }
                            if (expressionAssignRule.DestinationColumnName.ToLower().Equals(columnName.ToLower()) && !columnNames.Contains(columnName, caseInsensitiveEqualityComparer))
                            {
                                columnNames.Add(columnName);
                            }
                        }
                        else if (rule is Rule_Format)
                        {
                            Rule_Format formatAssignRule = rule as Rule_Format;
                            if (formatAssignRule.SourceColumnName.ToLower().Equals(columnName.ToLower()) && !columnNames.Contains(columnName, caseInsensitiveEqualityComparer))
                            {
                                columnNames.Add(columnName);
                            }
                        }
                        else if (rule is Rule_SimpleAssign)
                        {
                            Rule_SimpleAssign simpleAssignRule = rule as Rule_SimpleAssign;
                            ColumnDataType columnDataType = ColumnDataType.Boolean | ColumnDataType.DateTime | ColumnDataType.Numeric | ColumnDataType.Text | ColumnDataType.UserDefined;
                            List fieldNames = this.GetFieldsAsList(columnDataType);
                            foreach (string parameter in simpleAssignRule.AssignmentParameters)
                            {
                                if (!columnNames.Contains(parameter, caseInsensitiveEqualityComparer) && fieldNames.Contains(parameter, caseInsensitiveEqualityComparer))
                                {
                                    columnNames.Add(parameter);
                                }
                            }
                        }
                        else if (rule is Rule_Recode)
                        {
                            Rule_Recode recodeRule = rule as Rule_Recode;
                            if (recodeRule.SourceColumnName.ToLower().Equals(columnName.ToLower()) && !columnNames.Contains(columnName, caseInsensitiveEqualityComparer))
                            {
                                columnNames.Add(columnName);
                            }
                        }
                    }
                }

                List columnNamesToRemove = new List();

                foreach (string s in columnNames)
                {
                    if (!DoesColumnExist(s))
                    {
                        columnNamesToRemove.Add(s);
                    }
                }

                foreach (string s in columnNamesToRemove)
                {
                    columnNames.Remove(s);
                }

                foreach (string s in columnNames)
                {
                    string columnName = s;
                    columnsToSelect.Add(columnName);
                }

                foreach (RelatedConnection rConn in this.ConnectionsForRelate)
                {
                    if (!columnsToSelect.Contains(rConn.ParentKeyField, caseInsensitiveEqualityComparer))
                    {
                        columnsToSelect.Add(rConn.ParentKeyField);
                        columnNames.Add(rConn.ParentKeyField);
                    }
                }
            }

            if (IsUsingEpiProject)
            {
                string recstatus = GenerateRecstatusConditionForSelect();

                DataTable viewTable = Database.GetTableData(View.TableName, "GlobalRecordId, UniqueKey, RECSTATUS");
                viewTable.TableName = View.TableName;

                DataTable relatedTable = new DataTable("relatedTable");

                foreach (Page page in View.Pages)
                {
                    List pageColumnsToSelect = new List();
                    foreach (Field field in page.Fields)
                    {
                        if (columnNames.Contains(field.Name, caseInsensitiveEqualityComparer))
                        {
                            pageColumnsToSelect.Add(field.Name);
                        }
                    }
                    pageColumnsToSelect.Add("GlobalRecordId");

                    DataTable pageTable = Database.GetTableData(page.TableName, pageColumnsToSelect);
                    pageTable.TableName = page.TableName;

                    foreach (DataColumn dc in pageTable.Columns)
                    {
                        if (dc.ColumnName != "GlobalRecordId")
                        {
                            viewTable.Columns.Add(dc.ColumnName, dc.DataType);
                        }
                    }

                    foreach (DataRow row in pageTable.Rows)
                    {
                        foreach (DataRow viewRow in viewTable.Rows)
                        {
                            if (viewRow["GlobalRecordId"].ToString().Equals(row["GlobalRecordId"].ToString()))
                            {
                                foreach (DataColumn dc in pageTable.Columns)
                                {
                                    viewRow[dc.ColumnName] = row[dc.ColumnName];
                                }
                            }
                        }
                    }
                }

                unfilteredTable = viewTable;
            }
            else
            {

                List columns = new List();

                if (columnsToSelect.Count == 0)
                {
                    unfilteredTable = Database.GetTableData(TableName);
                }
                else
                {
                    DataTable topTwoTable = Database.GetTopTwoTable(TableName);
                    foreach (DataColumn dc in topTwoTable.Columns)
                    {
                        if (columnsToSelect.Contains(dc.ColumnName, caseInsensitiveEqualityComparer))
                        {

                            columns.Add(dc.ColumnName);
                        }
                    }

                    unfilteredTable = Database.GetTableData(TableName, columns);
                }
            }




















            RecordCount = unfilteredTable.Rows.Count;
            AddSystemVariablesToTable(unfilteredTable);
            AddPermanentVariablesToTable(unfilteredTable);
            return unfilteredTable; 
        }






                GenericDbColumnType ConvertToGenericDbColumnType(string columnType)
        {
            switch (columnType)
            {
                case "System.Int16":
                    return GenericDbColumnType.Int16;
                case "System.Int32":
                    return GenericDbColumnType.Int32;
                case "System.Int64":
                    return GenericDbColumnType.Int64;
                case "System.String":
                    return GenericDbColumnType.String;
                case "System.Byte":
                    return GenericDbColumnType.Byte;
                case "System.Boolean":
                    return GenericDbColumnType.Boolean;
                case "System.Decimal":
                    return GenericDbColumnType.Decimal;
                case "System.Double":
                    return GenericDbColumnType.Double;
                case "System.DateTime":
                    return GenericDbColumnType.DateTime;
                case "System.Guid":
                    return GenericDbColumnType.Guid;
                case "System.UInt16":
                    return GenericDbColumnType.UInt16;
                case "System.UInt32":
                    return GenericDbColumnType.UInt32;
                case "System.UInt64":
                    return GenericDbColumnType.UInt64;
                case "System.Single":
                    return GenericDbColumnType.Single;
                case "System.SByte":
                    return GenericDbColumnType.SByte;
                default:
                    return GenericDbColumnType.Object;
            }
        }








                void RelateInto(DataTable parentTable, DataTable childTable, string parentKey, string childKey, bool useUnmatched, IGadgetParameters inputs = null)
        {
            Dictionary columnNameMapping = new Dictionary();

            if (inputs != null)
            {
                inputs.UpdateGadgetStatus(string.Format(SharedStrings.DASHBOARD_GADGET_STATUS_PROCESSING_RELATED_TABLE, childTable.TableName));
            }

            if (childKey == "GlobalRecordId" && !childTable.Columns.Contains("GlobalRecordId") && childTable.Columns.Contains("t.GlobalRecordId"))
            {
                childKey = "t.GlobalRecordId";
            }

            foreach (DataColumn dc in childTable.Columns)
            {
                string columnName = dc.ColumnName;
                int i = 1;

                while (parentTable.Columns.Contains(columnName))
                {
                    columnName = dc.ColumnName + i.ToString();
                    i++;
                }

                columnNameMapping.Add(dc.ColumnName, columnName); 
                parentTable.Columns.Add(columnName, dc.DataType);
            }

            bool fromMany = false;
            bool toMany = false;
            foreach (DataRow childRow in childTable.Rows)
            {
                if (ValueOccursMoreThanOnce(childTable, childKey, childRow[childKey].ToString()))
                {
                    toMany = true;
                    break;
                }
            }

            foreach (DataRow parentRow in parentTable.Rows)
            {
                if (ValueOccursMoreThanOnce(parentTable, parentKey, parentRow[parentKey].ToString()))
                {
                    fromMany = true;
                    break;
                }
            }

            if (!fromMany) 
            {
                try
                {


                    DataColumn[] parentPrimaryKeyColumns = new DataColumn[1];
                    parentPrimaryKeyColumns[0] = parentTable.Columns[parentKey];
                    parentTable.PrimaryKey = parentPrimaryKeyColumns;
                }
                catch
                {
                }
            }

            string parentKeyDataType = parentTable.Columns[parentKey].DataType.ToString();
            string childKeyDataType = childTable.Columns[childKey].DataType.ToString();

            if (toMany == false && parentTable.PrimaryKey.Contains(parentTable.Columns[parentKey]) && parentTable.PrimaryKey.Length == 1 && parentKeyDataType == childKeyDataType)
            {
                int counter = 0;
                int total = childTable.Rows.Count;

                foreach (DataRow childRow in childTable.Rows)
                {
                    DataRow parentRow = parentTable.Rows.Find(childRow[childKey]);
                    if (parentRow != null)
                    {
                        if (parentRow[parentKey].ToString().Equals(childRow[childKey].ToString()))
                        {
                            parentRow.BeginEdit();
                            foreach (DataColumn dc in childTable.Columns)
                            {
                                string mappedColumnName = columnNameMapping[dc.ColumnName];
                                parentRow[mappedColumnName] = childRow[dc.ColumnName];
                            }
                            parentRow.EndEdit();
                        }
                    }

                    counter++;

                    if (counter % 200 == 0 && inputs != null)
                    {
                        if (counter > total)
                        {
                            counter = total;
                        }

                        inputs.UpdateGadgetProgress(((double)counter / (double)total) * 100);
                        inputs.UpdateGadgetStatus(string.Format(SharedStrings.DASHBOARD_GADGET_STATUS_RELATING_TABLE, childTable.TableName, ((double)counter / (double)total).ToString("P0")));
                        if (inputs.IsRequestCancelled())
                        {
                            return;
                        }
                    }
                }
            }
            else
            {
                int counter = 0;
                int total = childTable.Rows.Count;

                if (toMany)
                {
                    parentTable.PrimaryKey = null;
                    Dictionary objects = new Dictionary();
                    List rowsToRemove = new List();

                    parentTable.Columns.Add("__INT__TRK__ID__", typeof(int));
                    childTable.Columns.Add("__INT__TRK__ID__", typeof(int));

                    for (int r = 0; r < childTable.Rows.Count; r++)
                    {
                        childTable.Rows[r]["__INT__TRK__ID__"] = r + 1;
                    }

                    counter = 0;
                    foreach (DataRow childRow in childTable.Rows)
                    {
                        int count = 0;

                        if (!string.IsNullOrEmpty(childRow[childKey].ToString().Trim()))
                        {
                            count = GetDistinctValueCount(childTable, childKey, childRow[childKey].ToString());
                            foreach (DataRow parentRow in parentTable.Rows)
                            {
                                if (parentRow[parentKey].ToString().Equals(childRow[childKey].ToString()))
                                {


                                    if (!objects.ContainsKey(childRow["__INT__TRK__ID__"].ToString()) && count >= 2)
                                    {
                                        objects.Add(childRow["__INT__TRK__ID__"].ToString(), parentRow.ItemArray);
                                        if (!rowsToRemove.Contains(parentRow))
                                        {
                                            rowsToRemove.Add(parentRow);
                                        }
                                    }

                                }
                            }
                        }

                        counter++;

                        if (counter % 200 == 0 && inputs != null)
                        {
                            if (counter > total)
                            {
                                counter = total;
                            }
                            inputs.UpdateGadgetProgress(((double)counter / (double)total) * 100);
                            inputs.UpdateGadgetStatus(string.Format(SharedStrings.DASHBOARD_GADGET_STATUS_PREPROCESSING_RELATED_TABLE, childTable.TableName, ((double)counter / (double)total).ToString("P0")));
                            if (inputs.IsRequestCancelled())
                            {
                                return;
                            }
                        }
                    }

                    counter = 0;

                    if (!useUnmatched)
                    {
                        parentTable.Rows.Clear();
                    }
                    else
                    {
                        foreach (DataRow row in rowsToRemove)
                        {
                            parentTable.Rows.Remove(row);
                        }
                    }

                    foreach (KeyValuePair kvp in objects)
                    {
                        parentTable.Rows.Add(kvp.Value);
                        parentTable.Rows[parentTable.Rows.Count - 1]["__INT__TRK__ID__"] = kvp.Key;
                    }

                    foreach (DataRow childRow in childTable.Rows)
                    {
                        foreach (DataRow parentRow in parentTable.Rows)
                        {
                            if (parentRow["__INT__TRK__ID__"].ToString().Equals(childRow["__INT__TRK__ID__"].ToString()))
                            {
                                parentRow.BeginEdit();
                                foreach (DataColumn dc in childTable.Columns)
                                {
                                    if (dc.ColumnName != "__INT__TRK__ID__")
                                    {
                                        string mappedColumnName = columnNameMapping[dc.ColumnName];
                                        parentRow[mappedColumnName] = childRow[dc.ColumnName];
                                    }
                                }
                                parentRow.EndEdit();
                                break;
                            }
                        }

                        counter++;

                        if (counter % 200 == 0 && inputs != null)
                        {
                            if (counter > total)
                            {
                                counter = total;
                            }
                            inputs.UpdateGadgetProgress(((double)counter / (double)total) * 100);
                            inputs.UpdateGadgetStatus(string.Format(SharedStrings.DASHBOARD_GADGET_STATUS_RELATING_TABLE, childTable.TableName, ((double)counter / (double)total).ToString("P0")));
                            if (inputs.IsRequestCancelled())
                            {
                                return;
                            }
                        }
                    }

                    childTable.Columns.Remove("__INT__TRK__ID__");
                    parentTable.Columns.Remove("__INT__TRK__ID__");
                }
                else
                {
                    foreach (DataRow childRow in childTable.Rows)
                    {
                        foreach (DataRow parentRow in parentTable.Rows)
                        {
                            if (parentRow[parentKey].ToString().Equals(childRow[childKey].ToString()))
                            {
                                parentRow.BeginEdit();
                                foreach (DataColumn dc in childTable.Columns)
                                {
                                    string mappedColumnName = columnNameMapping[dc.ColumnName];
                                    parentRow[mappedColumnName] = childRow[dc.ColumnName];
                                }
                                parentRow.EndEdit();
                                if (!fromMany)
                                {
                                    break;
                                }
                            }
                        }

                        counter++;

                        if (counter % 200 == 0 && inputs != null)
                        {
                            if (counter > total)
                            {
                                counter = total;
                            }

                            inputs.UpdateGadgetStatus(string.Format(SharedStrings.DASHBOARD_GADGET_STATUS_RELATING_TABLE, childTable.TableName, ((double)counter / (double)total).ToString("P0")));
                            if (inputs.IsRequestCancelled())
                            {
                                return;
                            }
                        }
                    }
                }
            }
        }






        public List GetStrataValuesAsDictionary(List strataVars, bool includeMissing, bool useFieldPrompts)
        {
            DataView filteredView = ds.Tables[0].DefaultView;

            List stratas = new List();

            //Input Validation
            if (strataVars == null || strataVars.Count == 0)
            {
                throw new ApplicationException("No strata variables.");
            }
            //

            DataTable distinctTable = SelectDistinct(filteredView, strataVars.ToArray());
            string sortClause = string.Empty;
            List booleanColumnNames = new List();

            foreach (string strataVar in strataVars)
            {
                string columnType = GetColumnType(strataVar);
                string sort = " ASC,";

                if (columnType.Equals("System.Boolean") || (IsUsingEpiProject && View.Fields.Contains(strataVar) && View.Fields[strataVar] is YesNoField))
                {
                    sort = " DESC,";
                    booleanColumnNames.Add(strataVar);
                }

                sortClause = sortClause + AddBracketsToString(strataVar) + sort;
            }
            sortClause = sortClause.TrimEnd(',');

            DataRow[] rowArray = distinctTable.Select("", sortClause);
            DataTable sortedDistinctTable = rowArray.CopyToDataTable().DefaultView.ToTable(distinctTable.TableName);
            DataTable sortedDistinctTableTranslated = new DataTable();

            sortedDistinctTableTranslated = sortedDistinctTable.Copy(); 




































            foreach (string booleanColumnName in booleanColumnNames)
            {
                DataColumn column = new DataColumn(booleanColumnName + "_TEMP_DB_X", typeof(string));
                sortedDistinctTableTranslated.Columns.Add(column);

                foreach (DataRow row in sortedDistinctTableTranslated.Rows)
                {
                    row[column] = RecodeBooleanToYesNo(row[booleanColumnName].ToString());
                }

                sortedDistinctTableTranslated.Columns.Remove(booleanColumnName);
                column.ColumnName = booleanColumnName;
            }

            foreach (DataColumn dc in sortedDistinctTable.Columns)
            {
                DataColumn dcT = sortedDistinctTableTranslated.Columns[dc.ColumnName];
                dcT.SetOrdinal(dc.Ordinal);
            }

            for (int j = 0; j < sortedDistinctTableTranslated.Rows.Count; j++)
            {
                List fieldNames = new List();
                List fieldValues = new List();

                DataRow row = sortedDistinctTable.Rows[j];
                DataRow translatedRow = sortedDistinctTableTranslated.Rows[j];

                string s = string.Empty;
                string epiValue = string.Empty;
                string rawStrataValue = string.Empty;

                for (int i = 0; i < sortedDistinctTable.Columns.Count; i++)
                {
                    string strataColumnType = GetColumnType(sortedDistinctTable.Columns[i].ColumnName);
                    string strataValue = row[i].ToString();
                    rawStrataValue = strataValue;

                    strataValue = FormatValue(strataValue, strataColumnType);

                    if (string.IsNullOrEmpty(rawStrataValue))
                    {
                        if (includeMissing)
                        {
                            if (sortedDistinctTable.Columns[i].DataType.ToString().Equals("System.String"))
                            {
                                s = s + "(" + AddBracketsToString(sortedDistinctTable.Columns[i].ColumnName) + " = '' OR " + AddBracketsToString(sortedDistinctTable.Columns[i].ColumnName) + " is null) ";
                            }
                            else
                            {
                                s = s + AddBracketsToString(sortedDistinctTable.Columns[i].ColumnName) + " is null ";
                            }
                        }
                        else
                        {
                            continue;
                        }
                    }
                    else
                    {
                        s = s + AddBracketsToString(sortedDistinctTable.Columns[i].ColumnName) + " = " + strataValue;
                    }

                    string translatedStrataValue = string.Empty;
                    translatedStrataValue = translatedRow[i].ToString();
                    if (string.IsNullOrEmpty(translatedStrataValue))
                    {
                        translatedStrataValue = Config.Settings.RepresentationOfMissing;
                    }

                    string fieldName = sortedDistinctTable.Columns[i].ColumnName;

                    if (useFieldPrompts)
                    {
                        Field field = GetAssociatedField(fieldName);
                        if (field != null && field is IDataField)
                        {
                            fieldName = ((IDataField)field).PromptText;
                        }
                    }

                    fieldNames.Add(fieldName);
                    fieldValues.Add(translatedStrataValue);

                    epiValue = epiValue + fieldName + " = " + translatedStrataValue;

                    if (i != sortedDistinctTable.Columns.Count - 1)
                    {
                        s = s + " and ";
                        epiValue = epiValue + " and ";
                    }
                }

                if (s.StartsWith(" and") && epiValue.StartsWith(" and"))
                {
                    s = s.Remove(0, 4);
                    epiValue = epiValue.Remove(0, 4);
                }

                if (string.IsNullOrEmpty(rawStrataValue))
                {
                    if (includeMissing)
                    {
                        stratas.Add(new Strata(fieldNames, fieldValues, epiValue, s));
                    }
                }
                else
                {
                    stratas.Add(new Strata(fieldNames, fieldValues, epiValue, s));
                }
            }
            return stratas;
        }







                Dictionary GetCrosstabValuesAsDictionary(DataTable filteredTable, string crosstabVar, string freqVar, bool includeMissing = false)
        {
            Dictionary crosstabValues = new Dictionary();

            //Input Validation
            if (string.IsNullOrEmpty(crosstabVar))
            {
                throw new ArgumentNullException("crosstabVar");
            }
            //

            SortOrder sort = SortOrder.Ascending;

            string columnType = GetColumnType(crosstabVar);
            bool isBoolean = false;
            string yesValue = Config.Settings.RepresentationOfYes;
            string noValue = Config.Settings.RepresentationOfNo;
            string missingValue = Config.Settings.RepresentationOfMissing;

            if (columnType.Equals("System.Boolean") || (IsUsingEpiProject && View.Fields.Contains(crosstabVar) && View.Fields[crosstabVar] is YesNoField))
            {
                isBoolean = true;
                sort = SortOrder.Descending;
            }

            DataTable distinctTable = SelectDistinct(filteredTable, crosstabVar);
            DataTable sortedDistinctTable = SortBySingleColumn(distinctTable, distinctTable.Columns[crosstabVar], sort);

            foreach (DataRow row in sortedDistinctTable.Rows)
            {
                if (!includeMissing && row[0].ToString().ToLower().Trim().Equals(string.Empty))
                {
                    continue;
                }

                if (isBoolean)
                {
                    string epiValue = RecodeBooleanToYesNo(row[0].ToString());
                    crosstabValues.Add(row[0].ToString(), epiValue);
                }
                else
                {
                    crosstabValues.Add(row[0].ToString(), row[0].ToString());
                }
            }
            return crosstabValues;
        }






                Dictionary GetCrosstabValuesAsDictionary(string crosstabVar, string freqVar, bool includeMissing = false)
        {
            Dictionary crosstabValues = new Dictionary();

            //Input Validation
            if (string.IsNullOrEmpty(crosstabVar))
            {
                throw new ArgumentNullException("crosstabVar");
            }
            //

            SortOrder sort = SortOrder.Ascending;
            DataView sourceView = ds.Tables[0].DefaultView;

            string columnType = GetColumnType(crosstabVar);
            bool isBoolean = false;
            string yesValue = Config.Settings.RepresentationOfYes;
            string noValue = Config.Settings.RepresentationOfNo;
            string missingValue = Config.Settings.RepresentationOfMissing;

            if (columnType.Equals("System.Boolean") || (IsUsingEpiProject && View.Fields.Contains(crosstabVar) && View.Fields[crosstabVar] is YesNoField))
            {
                isBoolean = true;
                sort = SortOrder.Descending;
            }

            DataTable distinctTable = SelectDistinct(sourceView, crosstabVar);
            DataTable sortedDistinctTable = SortBySingleColumn(distinctTable, distinctTable.Columns[crosstabVar], sort);























            foreach (DataRow row in sortedDistinctTable.Rows)
            {
                if (!includeMissing && row[0].ToString().ToLower().Trim().Equals(string.Empty))
                {
                    continue;
                }

                if (isBoolean)
                {
                    string epiValue = RecodeBooleanToYesNo(row[0].ToString());
                    crosstabValues.Add(row[0].ToString(), epiValue);
                }
                else
                {
                    crosstabValues.Add(row[0].ToString(), row[0].ToString());
                }
            }
            return crosstabValues;
        }






                string RecodeBooleanToYesNo(string value)
        {
            string recodedValue = string.Empty;

            if (value.ToLower().Equals("true") || value.ToLower().Equals("1"))
            {
                recodedValue = Config.Settings.RepresentationOfYes;
            }
            else if (value.ToLower().Equals("false") || value.ToLower().Equals("0"))
            {
                recodedValue = Config.Settings.RepresentationOfNo;
            }
            else if (value.ToLower().Trim().Equals(string.Empty))
            {
                recodedValue = Config.Settings.RepresentationOfMissing;
            }
            return recodedValue;
        }






                string FormatTableName(string tableName)
        {
            if (tableName.Contains('.'))
            {
                return tableName;
            }
            else
            {
                return StringLiterals.LEFT_SQUARE_BRACKET + TableName + StringLiterals.RIGHT_SQUARE_BRACKET;
            }
        }
        //

        //Classes
                class CaseInsensitiveEqualityComparer : IEqualityComparer
        {

            public bool Equals(string obj1, string obj2)
            {
                if (string.Compare(obj1, obj2, true) == 0)
                {
                    return true;
                }
                else
                {
                    return false;
                }
            }

            public int GetHashCode(string obj)
            {
                return obj.GetHashCode();
            }
        }
        //
    }
}

 