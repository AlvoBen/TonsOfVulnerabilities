<!--
Component Name   : CaseCommentsData_CMP_HUM.component
Version          : 1.0
Created On       : 08/31/2017
Function         : VF Component to display Casecomments table from the controller CaseCommentsDataTable_C_HUM

Modification Log: 
 * Developer Name           Code Review                 Date                         Description
 *------------------------------------------------------------------------------------------------------------------------------
 * Prasad Jandhyala         149239                     08/31/2017                   Original version
 * Pradeepkumar Dani        157327                     12/13/2017                   Pharmacy adjustaments
 * Suraj Patil              200646                     03/22/2018                   REQ - 354517 Pharmacy Case comment and non - Pharmacy case comment
 * Suraj Patil              208544                     04/04/2018                   Defect - 353012 
 * Suraj Patil              209421                     04/05/2018                   Defect - 352917 -REQ-354517_Issue in alingment of Save & Cancel button in case comment
 * Suraj Patil              214064                     04/12/2018                   Defect - 353288 -REQ-354517_Issue in alingment of Save & Cancel button in case comment
 * Srivinas Damera          222501                     05/01/2018                   REQ - 361141 Case Comments Edit and Delete for system Admin
 * Ananya Biswas            259008                     07/18/2018                   REQ - 367014 Log codes
 * Anurag Shah              267567                     08/30/2018                   REQ - 371266 Added a logic to determine page section for PDP Pilot access based on logged in user 
 * Prudhvi Pamarthi         296559                     10/15/2018                   REQ - 376380 Humana Pharmacy User - Case comments error message not displaying properly if member doesn't have an ePost account
 * Prudhvi Pamarthi                                    02/06/2019                   REQ - 361155 - Not allowing case creation on Legacy Deleted policies
 * Kiran Kumar                                         04/11/2019                   Defect 409800 Fix
 * Prathyu Tushar           351220                     04/11/2019                   REQ - 383718: added unsaved changes alert for Pharmaracy Create Order Save &  Log functionlaity.
 * Santhosh Ganji                                      04/19/2019                 REQ - 386935 - Case Detail Restrictions (MED vs non-MED cases)�READ ONLY features
 * Prathyu Tushar                                      07/29/2019                   ID-27, case Comments prefill for Non HP recordtypes on case detail
 * Kiran Kumar                                         09/09/2019                   REQ - 400170: Quickstart Add/Update Case Comments
 * Kiran Kumar                                         09/09/2019                   Defect - 442041 Unable to save Case Comments
 * Aaron Speakman                                      11/12/2019                   REQ - 410397 Humana Pharmacy Quick Start+ Page - Pretext (RxRF)
 * Kiran Kumar                                         11/13/2019                   REQ - 411299 Humana Pharmacy Quick Start+ Page - Add/Update Comment � Bring Case Comment Section to Focus (RxRF)
 * AshokKumar Nutalapati                               02/25/2020                   REQ - 821455 - Humana Pharmacy Quick Start+ Page - Add/Update Comment on Existing Case
 * Santhi Mandava                                      01/29/2021                   User Story 1791226: PR00094254 - MF 4- AEP Performance - SF Limits - Sync CPU Time Limit Analysis - Case Details
 * Kiran Kumar Bhuvanagiri                             02/26/2021                   User Story 1824140: Automatically Record Credit Card Updates to Case: Create Order Page (RxRF)
 * Aaron Speakman                                      03/23/2021                   DF-2700 - Regression Fix - 1900 Character Limit  
 * Mithra Bharadwaj                                    02/09/2021                   US#1522825 SonarQube Changes
 * Atia Uzma                                           06/11/2021                   User Story 2348146: T1PRJ0001827 - MF 1 - Quality - Ability to separate out 'Save' and 'Cancel' buttons while adding new comment on the Case Details page (CRM)
 * Amar Gadewar                                        08/09/2021                   User Story 2551528: T1PRJ0001827 - MF 1 - AHT - Ability to copy information in CRM - Phase 4 (RF)
 * Sunil kumar reddy                                   08/19/2021                   User Story 2594451: T1PRJ0001827 - MF 1 - AHT - Ability to update Case Comments from quick start on the Case Detail page (RF)
 * Amar Gadewar                                        09/01/2021                   DF-3641: 2594451 - Text in the HP Quick Start+ Case Comments section is not passed to the Case Detail page's Case Comment text box.
 * Sunil kumar reddy                                   09/03/2021                   DF-3683
 * Shaik Mujeebur Rahaman                              06/08/2022                   User Story 3366863: T1PRJ0010888 - MF [1] - Rebranding- Update text references from "Humana Pharmacy" to "Mail Order Pharmacy" - Main Page & Case Comments
 * Pinky Vijur                                          01/20/2023                  3172071	T1PRJ0891339 - MF 5 - TECH - Pharmville Decommissioning - Custom Permission Usage
 ****************************************************************************************************************************
 -->
 <apex:component controller="CaseCommentsDataTable_C_HUM"  id="CommentscmpId" allowDML="true">
  <apex:includeScript value="{!URLFOR($Resource.CRM_JQUERY, 'jquery.min.js')}"/>
  <script src="{!URLFOR($Resource.CaseDetailResources_SR_HUM,'/CaseComments/CaseComments_JS_HUM.js')}"/>
  <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.PharmacyCaseComment_SR_HUM, 'PharmacyCaseComment_SR_HUM/PharmacyCaseComment_CSS_HUM.css')}" />
  <apex:includescript value="/support/console/36.0/integration.js" />
  <apex:includescript value="{!URLFOR($Resource.CRM_JQUERY, 'jquery.min.js')}" />
  <apex:attribute name="caseRecordId" type="string" description="The Case Record ID" assignTo="{!sCaseID}"/>
  <script type="text/javascript">
    <!-- Please do not change this line as it breaks the JS tables. -->
    //dont enable P9 Critical Fix        $j = jQuery.noConflict();
    var logNotes = '{!$RemoteAction.CaseCommentsDataTable_C_HUM.sendRequestLogNotes}';
    var sNetworkUserid = '{!JSENCODE($User.Network_User_Id__c)}';
    var enterpriseID = '{!JSENCODE(objCase.Account.Enterprise_ID__c)}';
    var caseID = '{!JSENCODE(sCaseID)}';
    var recordId = '{!JSENCODE(objCase.AccountId)}';
    var typeValue = '{!JSENCODE($CurrentPage.parameters.type)}';
    var caseComments = '{!JSENCODE(sNewCaseCommentPharmacy)}';
    if(caseComments != "" && caseComments != null && caseComments.includes("\n\n")){
    caseComments = caseComments.split("\n\n");
    caseComments = caseComments[0]+"<br><br>"+caseComments[1];
    }
    var isFromLogging = '{!JSENCODE(IF(isThisFromLogging, "true", "false"))}';
    var accessRFPermissionSet ={!$Permission.RapidForceUser_AHT_HUM}; 
    var caseRecordid;
    var bIsPharmacy =  '{!($Profile.Name==$Label.PHARMACY_SPECIALIST_PROFILE_NAME) || (bIsPharmacyUser)}';
    var sClassificationID = '{!JSENCODE(objCase.CTCI_List__r.Classification__c)}';
    var sIntentID = '{!JSENCODE(objCase.CTCI_List__r.Intent__c)}';
    window.onload=function()
    {
    if(caseComments != ''){
    showSaveCancelButtons('block');
    }
    if(isFromLogging =='true'){
    sforce.console.getEnclosingTabId(setCaseTabDirty);
    }

    function setCaseTabDirty(result){
    sforce.console.setTabUnsavedChanges(true, null, result.id);
    }
    };
    function checkCharacters(sCommentAmount){
    if (sCommentAmount.length > 1900){
    document.getElementById('{!$Component.CommentscmpId:pharmacyCCPbs:pharmacyCCPbsi2:characterLimitError}').style.display = 'block';
    return sCommentAmount.substring(0,1900);
    } else{
    document.getElementById('{!$Component.CommentscmpId:pharmacyCCPbs:pharmacyCCPbsi2:characterLimitError}').style.display = 'none';
    return sCommentAmount;
    }
    }
  </script>
 <apex:outputPanel id="CCPanel">
  <script>
    function gotoCaseCommentsAF(){
     gotoLocation('{!SUBSTITUTE(SUBSTITUTE(SUBSTITUTE(SUBSTITUTE(SUBSTITUTE('Case Comments',' ',''),'&',''),'/',''),'[',''),']','')}');
    }
   </script>
</apex:outputPanel>
  <div id="opnlSaveCancel" style="display:none">
    <div>
      <apex:pageBlockSection columns="2" collapsible="false" id="CommentCCPbs">
        <apex:pageblockSectionItem id="pharmacyCCPbsi2">
          <apex:outputLabel Value="Comment" for="pharmacyCCBody" style="width: 200px;"/>
          <apex:outputPanel >
            <div class="requiredCss">
              <apex:inputTextarea id="itaNewCaseComment" value="{!sNewCaseComment}" label="New Case Comment" rows="8"  cols="80" style="margin: 0px;height: 96px;width: 497px;" />
              <span id="newCaseCommentMessage_CaseCommentSection" style="display:none" >
                <b>Error:</b> You must enter a value
              </span>
              <span id="charLimit_CaseCommentSection" style="display:none" >
                <br/><b>Error:</b>{!$Label.CaseCommentCharLimit_HUM} 
              </span>
            </div>
          </apex:outputPanel>
        </apex:pageblockSectionItem>
      </apex:pageBlockSection>

      <div style="text-align:left; padding-left:225px">
        <apex:commandButton onclick="validateCaseComment();"  value="Save"  style="padding:5px 10px;" reRender="opnlSaveCancel"/>
        <apex:commandButton onclick="showSaveCancelButtons('none'); return false;" value="Cancel" rerender="CommentscmpId" style="left:25px;position:relative;"/>
      </div>
      <apex:actionFunction name="createNewCaseCommentsave" action="{!createNewCaseComment}" reRender="CommentscmpId" oncomplete="onCompleteOfSaveButton();"/>
      <apex:actionFunction name="casecommentsJS" reRender="CCPanel" oncomplete="gotoCaseCommentsAF();"/>
    </div>
  </div>

  <!--Below changes are of Pharamacy-->

  <div id= 'PageMessageId'>
    <apex:outputPanel id="noRecordError" Styleclass="displayNone">
      <apex:PageMessage Summary="{!$Label.PHARMACYCOMMENT_EPOST_FAULT}" severity="Error" Strength="3" />
      <apex:pagemessages />
    </apex:outputPanel>
    <apex:outputPanel id="failError" Styleclass="displayNone">
      <apex:PageMessage Summary="{!$Label.PHARMACY_EPOST_FAILMSG}" severity="Error" Strength="3" />
      <apex:pagemessages />
    </apex:outputPanel>
    <apex:outputPanel id="memberNotFound" Styleclass="displayNone">
      <apex:PageMessage Summary="{!$Label.PHARMACYCOMMENT_EPOST_MEMBERNOTFOUND}" severity="Error" Strength="3" />
      <apex:pagemessages />
    </apex:outputPanel>
    <apex:outputPanel id="faultError" Styleclass="displayNone">
      <apex:PageMessage Summary="{!$Label.PHARMACYCOMMENT_EPOST_FAULT}" severity="Error" Strength="3" />
      <apex:pagemessages />
    </apex:outputPanel>

    <apex:outputpanel id="hiddenCaseCommentMemberNotFound">
      <apex:inputHidden value="{!sHiddenCaseCommentMemberNotFound}" id="pharmacyHiddenCCMemberNotFound" />
    </apex:outputpanel>
    <apex:outputpanel id="hiddenCaseCommentFaultError">
      <apex:inputHidden value="{!sHiddenCaseCommentFaultError}" id="pharmacyHiddenCCFaultError" />
    </apex:outputpanel>
  </div>
  <div id="opnlCreateNewCommentButton" styleclass="paddingLeft">
    <!--apex:commandButton onclick="openCaseComments('New'); return false;" value="New"/-->
    <apex:commandButton onclick="showSaveCancelButtons('block'); return false;" value="New" disabled="{!bdisableButton}" rendered="{!(!hPharmacyUser || (hPharmacyUser && hideTheButton))}"/>
  </div>
  <div id="opnlSaveCancelPharmacy" style="display:none">
    <div>
      <apex:pageBlockSection columns="2" collapsible="false" id="pharmacyCCPbs">
        <apex:actionRegion renderRegionOnly="true">
          <apex:outputpanel id="hiddenCode">
            <apex:pageblockSectionItem id="pharmacyCCPbsi1">
              <apex:inputHidden value="{!sCodeHidden}" id="pharmacyCCCode" />
            </apex:pageblockSectionItem>
          </apex:outputpanel>
        </apex:actionRegion>

        <apex:pageblockSectionItem >
          <apex:outputLabel Value="Mail Order Pharmacy Log Code" for="pharmacyCCBody" />
          <apex:outputPanel >
            <div class="requiredCss" id="logId">
              <apex:selectList value="{!sCode}" size="1" id="LogCodeID">
                <apex:selectOption itemValue="" itemLabel="" />
                <apex:selectOptions value="{!CaseCommentOptions}" />
                <apex:actionSupport event="onchange" action="{!populateHiddentVal}" rerender="hiddenCode" />
              </apex:selectList>
            </div>
          </apex:outputPanel>
        </apex:pageblockSectionItem>

        <apex:pageBlocksectionItem dataStyle="width: 20%;" >
          <apex:outputPanel styleClass="reminderMessage">
            <br/>
            <apex:outputText value="{!$Label.CaseReminderMessageCommentsHPLine1_CASE_HUM}" />
            <br/>
            <apex:outputText value="{!$Label.CaseReminderMessageCommentsHPLine2_CASE_HUM}" />
          </apex:outputPanel>
        </apex:pageBlocksectionItem>
        <apex:pageblockSectionItem id="pharmacyCCPbsi2" dataStyle="width: 80%;"  >
          <apex:outputLabel Value="Comment" for="pharmacyCCBody" />
          <apex:outputPanel >
            <div class="requiredCss">
              <apex:inputTextArea value="{!sNewCaseCommentPharmacy}"  id="pharmacyCCBody" label="{!$Label.case_comments}" html-maxlength="1900" rows="8" cols="75"/>
              <BR/>Limit:  1900 Characters <br/>
              <apex:outputLabel style="color: red; display: none;" id="characterLimitError">
                <b>Warning: </b>The Case Comment created from Quick Start+ exceeds the 1900 character limit.<br/>Please save this comment first then add an additional comment with the remaining information.
              </apex:outputLabel>
              <apex:outputLabel style="color: red; display: block;" id="characterLimitWarning" rendered="{!bCharWarning}">
                <b>Warning: </b>The system generated Case Comment exceeds the 1900 character limit.<br/>Please save the Case first, then add an additional comment with the remaining Order details.
              </apex:outputLabel>
            </div>
          </apex:outputPanel>
        </apex:pageblockSectionItem>
      </apex:pageBlockSection>
      <div id="CCLoadingImageId" class="centerAlign displayNone">
        <img src="/img/loading.gif" />
        <span class="waitingDescription">{!$Label.LOADING_HUM}</span>
      </div>
      <div style="text-align:center; padding-left:100px">
        <apex:commandButton id="saveCCId" onclick="logNotestoEpost();" value="Save"  style="position:relative;" reRender="CommentscmpId"/>
        <apex:commandButton id="cancelCCId" onclick="showNewButtonsPharmacy('none'); return false;" value="Cancel" rerender="CommentscmpId" style="left:25px;position:relative;"/>
      </div>
    </div>
  </div>
  <apex:actionFunction name="commitSaveComment" action="{!createNewCaseCommentPharmacy}"  rerender="CommentscmpId" oncomplete="fReloadCaseCommentsTable();">
    <apex:param name="redirectFlag" value="" />
    <apex:param name="errorCaseComment" value="" />
  </apex:actionFunction>
  <br/>
  <br/>
  <apex:outputPanel layout="block">
    <a href="#" id="expandAll_caseCommentsDataTable" style="display:inline-block;">
      <u>Expand All</u>
    </a> | <a href="#" id="collapseAll_caseCommentsDataTable" style="display:inline-block;">
      <u>Collapse All</u>
    </a>
  </apex:outputPanel>
  <br/>
  <apex:variable value="{!$Profile.Name == $Label.HUMAgencyCCSupervisor || sPharmacyUser== $Label.PharmacyUserSupervisorYes_HUM || $Profile.Name == $Label.HUMAgencySystemAdmin}" var="bIsAction" />
  <c:BaseDataTable_CMP_HUM col1_accordian="true"
                           jqueryvariable="jQuery"
                           tableid="caseCommentsDataTable"
                           tablecontainerid="caseCommentsDataTable_div"
                           htmlColumnName="CreatedBy,LastModified"
                           enablesearch="f"
                           columnname="{!columnName}"
                           objname="CaseComment"
                           columnHeader="{!columnHeader}"
                           accordionColumns="recId,CommentFull"
                           col1_editDelete="{!bIsAction}"
                           col1_orderable="false"
                           col2_orderable="{!!bIsAction}"
                           orderColumn="{!IF(bIsAction,2,1)}"
                           orderDirection="desc"
                           keyword="false" />
  <script>
    var vGetCaseCommentsData = '{!$RemoteAction.CaseCommentsDataTable_C_HUM.getCaseCommentsData}';
    var vCaseRecordId = '{!JSENCODE(caseRecordId)}';
    var vIsPharmacyUser = '{!!(sPharmacyUser=="No") || (bIsPharmacyUser)}';
    var vIsLogCodelistAvailable = '{!JSENCODE(IF(bIsLogCodelistAvailable, "true", "false"))}';
    var pagePharmacyCaseComment_VF_HUM = '{!$Page.PharmacyCaseComment_VF_HUM}';
    var SHOW_ALL_CHILDREN_FLAG = true;
    var CHILD_DISPLAY_STATE_OVERRIDE = true;
    var vPharmacyMemberNotFound = '{!JSENCODE(sPharmacyMemberNotFound)}';
    var vPharmacyFaultError = '{!JSENCODE(sPharmacyFaultError)}';
    Visualforce.remoting.timeout = '{!$Label.HUMMemWebActivityTimeout}';
  </script>
</apex:component>