<apex:page controller="DpaasFileClient">

    <apex:includeScript value="{!URLFOR($Resource.CRM_JQUERY, 'jquery.js')}" />
   

    <script>

//dont enable P9 Critical Fix    var jq = jQuery.noConflict();
    var zipFile = new JSZip();
      
      
    jQuery(document).ready(function() {
        jQuery("#statusDiv").css("visibility", "hidden"); 
        jQuery("#statusDiv").css("display", "none");                   
    }); 
  
    
   
    function processDocuments(argJSONDocContent){
        //console.log(argJSONDocContent);
        var downloadedDocs = argJSONDocContent.downloadedDocs;
        var keys = argJSONDocContent.keys;     
           
        ////console.log('Keys done : ' + keys);
        ////console.log('Keys length: ' + argJSONDocContent.keys.length);
        ////console.log(' argJSONDocContent : ' + downloadedDocs );
        for (var i=0;i<keys.length;i++)
        { 
            renderDoc(downloadedDocs[keys[i]]);                    
        }
        createZipFile();
    }
    
    function renderDoc(docData){
        var docId = docData.docId;
        var fileName = docData.fileName;
        var docBody = docData.docBody;
        //console.log('docBody : ' + docBody);
        zipFile.file(fileName ,docBody , {base64:true});         
    }
    
    function createZipFile(){
         content = zipFile.generate();
         location.href="data:application/zip;base64," + content ;    
         content = null;   
    }
    
    function hideStatusDiv(){
        jQuery("#statusDiv").css("visibility", "hidden"); 
        jQuery("#statusDiv").css("display", "none");    
    }
    
    function showStatusDiv(){
        jQuery("#statusDiv").css("visibility", "visible"); 
    }

</script>


    <apex:form >
        <div id="status"></div>
        <br />
        <br />
        <br />
        
        <apex:outputPanel id="ajaxDiv" title="Ajax Div">
       <center><div style='color:red'><b><apex:outputLabel >{!error}</apex:outputLabel></b></div></center>
            <apex:pageBlock id="thePageBlock" title="Selected Attachments">
            
            
             
                <apex:pageBlockSection >
                 <apex:outputLabel value="Application Name*" for="cipherTextValue"/>
                 <apex:inputText id="appName" value="{!appName}"/>
                </apex:pageBlockSection>
                <apex:pageBlockTable value="{!fileOperationsOutputList}"
                    var="fo" rendered="{!!ISBLANK(fileOperationsOutputList)}">
                    <apex:column headerValue="Document ID">
                        <apex:inputtext value="{!fo.docId}" />
                    </apex:column>
                    <apex:column headerValue="Document Name">
                        <apex:outputLabel >{!fo.name}</apex:outputLabel>
                    </apex:column>
                    <apex:column headerValue="Folder ID">
                        <apex:outputLabel >{!fo.folderid}</apex:outputLabel>
                    </apex:column>
                    <apex:column headerValue="File Type">
                        <apex:outputLabel >{!fo.type}</apex:outputLabel>
                    </apex:column>
                    <apex:column headerValue="Status">
                        <apex:outputLabel >{!fo.status}</apex:outputLabel>
                    </apex:column>

                </apex:pageBlockTable>
                <br />
                <br />
                
                 <div id="buttonDiv" width="" style="align:center">

                    <apex:outputpanel id="addRow">
                        <input type="button" value="Add Row"/>
                        <apex:actionSupport event="onclick" action="{!loadDocBlocks}"
                            rerender="ajaxDiv" status="counterStatus" oncomplete="hideStatusDiv();"/>
                    </apex:outputpanel>
                      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <apex:outputpanel id="removeRow">
                        <input type="button" value="Remove Row"/>
                       <apex:actionSupport event="onclick" action="{!removeDocBlocks}"
                            rerender="ajaxDiv" status="counterStatus" oncomplete="hideStatusDiv();"/>
                    </apex:outputpanel>
                      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <apex:outputpanel id="docDecrypter">
                        <input type="button" value=" Download "/>
                        <apex:actionSupport event="onclick" action="{!getDecryptedFiles}"
                            rerender="ajaxDiv" status="counterStatus"
                            oncomplete="showStatusDiv();if({!processZip}){processDocuments({!result})}" />
                    </apex:outputpanel>

                </div>
            </apex:pageBlock>

            <div id="statusDiv">
            <apex:pageBlock id="downloadedDocs" title="Downloaded Attachments Status">
                <apex:pageBlockTable value="{!downloadedOperationsOutputList }"
                    var="fo" rendered="{!!ISBLANK(downloadedOperationsOutputList)}">
                    <apex:column headerValue="Document ID">
                        <apex:outputLabel >{!fo.docId}</apex:outputLabel>
                    </apex:column>
                    <apex:column headerValue="Document Name">
                        <apex:outputLabel >{!fo.name}</apex:outputLabel>
                    </apex:column>
                    <apex:column headerValue="Folder ID">
                        <apex:outputLabel >{!fo.folderid}</apex:outputLabel>
                    </apex:column>
                    <apex:column headerValue="File Type">
                        <apex:outputLabel >{!fo.type}</apex:outputLabel>
                    </apex:column>
                    <apex:column headerValue="Status">
                        <apex:outputLabel >{!fo.status}</apex:outputLabel>
                    </apex:column>

                </apex:pageBlockTable>
            </apex:pageBlock>
            </div>


           

        </apex:outputPanel>
        <br />
        <br />
        <br />
        <br />

        <apex:actionStatus id="counterStatus" startText=" Loading Please wait..."
            stopText=" " />



        <div id="exceptionOccuredDiv" class="hidden">
            <div class="individualPalette" id="searchResultsHolderDiv">
                <div class="messages"></div>
                <div class="searchResultsMessageContainer">
                    <div class="message warningM4" id="searchResultsWarningMessageBox">
                        <table class="messageTable" border="0" cellpadding="0"
                            cellspacing="0">
                            <tbody>
                                <tr>
                                    <td>
                                        <img src="/s.gif" alt="Warning" class="msgIcon" title="Warning" />
                                    </td>
                                    <td class="messageCell">
                                        <div id="exceptionMessageText"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>


    </apex:form>
</apex:page>