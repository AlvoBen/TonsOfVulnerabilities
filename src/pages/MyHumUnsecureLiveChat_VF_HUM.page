<!--
Page Name        : MyHumUnsecureLiveChat_VF_HUM
Version          : 1.0 
Created Date     : December 12 2019
Function         : Custom window for Post Chat form on Live agent
Modification Log :
*   Modification ID     Developer                     Code Review         Date                 Description
* ------------------------------------------------------------------------------------------------------------------------------                
*   1.0             Joel George                                         12/12/2019              Original Version
*   1.1             Akshay Pai                                          02/02/2021              REQ - 1840251 - Visual Cue for New Messages in Chat Window –  Humana.com Unsecure
*   1.2             T Prasanna Sai Kumar                                03/11/2021              REQ - 1915578 - Live Agent Security Vulnerabilities for SonarQube Scan - MyHumana UnSecure Live Agent
*   1.3             Alvaro Madrid                                       08/18/2022              REQ - 3750632 - Adding BotTranscript to LiveChat Agent.
------------------------------------------------------------------------------------------------------------------------------------>
<apex:page controller="UnsecuredPreChat_C_HUM" showHeader="false" id="pageID" standardStyleSheets="false">
    <!-- JS Cannot be moved to Static Resource as Live agent JS loads after static resource and 
    liveagent attribute is defined in deployment.js file which will load after static resource.
    It will throw error as liveagent is undefined if JS moved into static resource.
    -->
    <head>
    <style>
    #liveAgentClientChat.liveAgentStateWaiting .liveAgentChatElement {display: none;}
    </style>
    <script type="text/javascript">
        //Code related to Code Metrics.
        var src = "{!JSENCODE(sWebChatVarMap['CodeMetricsJS'].value__c)}";
        if (window.location.host.indexOf("qa") >=0) 
        {
            src = "{!JSENCODE(sWebChatVarMap['CodeMetricsQaJS'].value__c)}";
        } 
        else if (window.location.host.indexOf("test") >=0 ) 
        {
            src = "{!JSENCODE(sWebChatVarMap['CodeMetricsTestJS'].value__c)}";
        }
        document.write('<script src="' + src + '" type="text/javascript"><' + '/script>');

        //Storing values from the prechat page.
        var sButtonId = '{!JSENCODE($CurrentPage.parameters.liveagent.prechat:SelBtnId)}';
        var sOrgId = '{!JSENCODE($CurrentPage.parameters.liveagent.prechat:org_id)}'; 
        var sDepId = '{!JSENCODE($CurrentPage.parameters.liveagent.prechat:deployment_id)}'; 
        var sSecondaryChatId = '{!JSENCODE($CurrentPage.parameters.liveagent.prechat:SecChatID)}'; 

        //liveagent Initialisation 
        liveagent.addEventListener(liveagent.chasitor.Events.CHAT_REQUEST_SUCCESSFUL,chatRequestSuccess);
        liveagent.addEventListener(liveagent.chasitor.Events.CHAT_ESTABLISHED,myCallBack);
        liveagent.addEventListener(liveagent.chasitor.Events.AGENT_CHAT_TRANSFERRED,newagent);
        if({!bSwitch})
		{
			liveagent.addEventListener(liveagent.chasitor.Events.AGENT_CHAT_MESSAGE,newAgentMessage);        
			//Getting custom label details
			window.$Label = window.$Label || {};
			$Label.HUMNewMsgDesktopNotification = '{!JSENCODE($Label.HUMNewMsgDesktopNotification)}';
        }
        //CHAT_REQUEST_SUCCESSFUL event callback helper function
        function chatRequestSuccess() 
        {
            var details = liveagent.chasitor.getDetails();
            
            for(i=0;i<details.prechatDetails.length;i++)
            {
                if(details.prechatDetails[i].label=='MemberGenKey')
                {
                    HumAnalytics.regid = details.prechatDetails[i].value;
                }
                else if(details.prechatDetails[i].label=='sLSessionID')
                {
                    HumAnalytics.ssid = details.prechatDetails[i].value;
                }
                HumAnalytics.secid = sSecondaryChatId;
            }
        }
        
        //CHAT_ESTABLISHED event callback helper function
        function myCallBack() 
        {
            var details = liveagent.chasitor.getDetails();
            var agentName = details['agent']['agentName'];
            document.getElementById('agNameId').style.display = '';
            document.getElementById('sendBtn').style.display = '';
            document.getElementById('agName').innerHTML = agentName;
            var labels = {
                AGENT_TYPING: agentName + ' is typing...'
            };
            SfdcApp.LiveAgent.Chasitor.loadLabels(labels);

            // Logic to send custom event for Bot Transcript
            console.log('BotTranscriptSwitch: ' + {!botTranscriptSwitch});
            if({!botTranscriptSwitch}){
                if({!humanaRoutingSwitch}){
		        data = getBotTranscript();
                console.log('##--BotTranscript: ' + data);
                liveagent.chasitor.sendMessage(data);
                }
			    else{
                type = 'botTranscriptGreeting';
                data = getBotTranscript();
                console.log('##--BotTranscript: ' + data);
                liveagent.chasitor.sendCustomEvent(type, data);
				}
            }
            commitTranscript();
        }
        
        //parsing botTranscript from liveagent details
        function getBotTranscript()
        {
            var details = liveagent.chasitor.getDetails();
            var botTranscript='';
            for(i=0;i<details.prechatDetails.length;i++)
            {
                if(details.prechatDetails[i].label=='BotTranscript')
                {
                    botTranscript = details.prechatDetails[i].value;
                }
            }
            return botTranscript;
        }
        
        //AGENT_CHAT_TRANSFERRED event callback helper function
        function newagent() 
        {
            var details = liveagent.chasitor.getDetails();
            var agentName = details['agent']['agentName'];
            document.getElementById('agName').innerHTML = agentName;
            var agentName = details['agent']['agentName'];
            var clientName = liveagent.chasitor.getName();
            var labels = {
                AGENT_TYPING: agentName + ' is typing...'
            };
            SfdcApp.LiveAgent.Chasitor.loadLabels(labels);
            
        }
        
        //Cannot Move it into static resource as it is using parameters that are related to live agent
        //Live agent components cannot be loaded inside static resource 
        function commitTranscript()
        {
            try
            {
                Visualforce.remoting.Manager.invokeAction('{!$RemoteAction.UnsecuredPreChat_C_HUM.onCommitTranscript}',liveagent.chasitor.getChatKey(),getAgentDetail(),function(result, event)
                {
                    if (event.status) 
                    {
                        return true;
                    } 
                    else
                    {
                        return false;
                    }
                 }, 
                 {
                    escape:true
                 });
            }
            catch (ex) 
            {
                return false;
            }
            return false;  
        }
        
        //commitTranscript helper function
        function getAgentDetail()
        {
            var details = liveagent.chasitor.getDetails();
            var tId='';
            tId = details['agent']['userId'];
            return tId;
        }
        
        //parsing the interaction info from liveagent details
        function getInteractionId()
        {
            var details = liveagent.chasitor.getDetails();
            var intId='';
            for(i=0;i<details.prechatDetails.length;i++)
            {
                if(details.prechatDetails[i].label=='InteractionId')
                {
                    intId = details.prechatDetails[i].value;
                }
            }
            return intId;
        }
        </script>   
       
       <!-- Start Tealium analytics v1_3 - do not remove or change -->
    <script type="text/javascript">
        var utag_data = {};
            if (typeof HumAnalytics == "undefined"){
                var HumAnalytics = window.HumAnalytics = {};}
        HumAnalytics.appid = [];
        HumAnalytics.autorenewflag = [];
        HumAnalytics.copayexcflag = [];
        HumAnalytics.prodcat = [];
        HumAnalytics.prodid = [];      
        HumAnalytics.prodname = [];
        HumAnalytics.prodpkgqty = [];      
        HumAnalytics.prodqty = [];
        HumAnalytics.prodsav = [];   
        HumAnalytics.prodtranstype = [];          
        HumAnalytics.prodtype = []; 
        HumAnalytics.produp = [];
    </script>

    <!-- Loading script asynchronously -->
    <script type="text/javascript">
        (function(a,b,c,d){
        a='{!JSENCODE(sWebChatVarMap['HumanaUnsecure_Tealium'].value__c)}';
        b=document;c='script';d=b.createElement(c);d.src=a;d.type='text/java'+c;d.async=true;
        a=b.getElementsByTagName(c)[0];a.parentNode.insertBefore(d,a);
        })();
    </script>
    <!-- End Tealium analytics - do not remove or change -->
       
       
        <title>Humana Chat</title>
        
        <!-- Loading CSS files received from digital team for Humana view standards -->
        <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.MyHumUnsecureLiveChatWindowCSS,'/LiveChatWindowCSS/base.css')}" />
        <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.MyHumUnsecureLiveChatWindowCSS,'/LiveChatWindowCSS/framework.css')}" />
        <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.MyHumUnsecureLiveChatWindowCSS,'/LiveChatWindowCSS/global.css')}" />
        <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.MyHumUnsecureLiveChatWindowCSS,'/LiveChatWindowCSS/global1.css')}" />
        <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.MyHumUnsecureLiveChatWindowCSS,'/LiveChatWindowCSS/humanacom.css')}" />
        <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.MyHumUnsecureLiveChatWindowCSS,'/LiveChatWindowCSS/lib.css')}" />
        <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.MyHumUnsecureLiveChatWindowCSS,'/LiveChatWindowCSS/styles.css')}" />
        <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.MyHumUnsecureLiveChatWindowCSS,'/LiveChatWindowCSS/renderings.css')}" />
        <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.MyHumUnsecureLiveChatWindowCSS,'/LiveChatWindowCSS/main.css')}" />
        <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.MyHumUnsecureLiveChatWindowCSS,'/LiveChatWindowCSS/Chat.css')}" />

        <!-- Loading jQuery toolkit as per VF standards -->
        <apex:includeScript value="{!URLFOR($Resource.CRM_JQUERY, 'jquery.min.js')}" />
		<apex:outputText rendered="{!bSwitch}">
            <apex:includeScript value="{!URLFOR($Resource.NewChatMsgNotification_SR_HUM,'NewChatMsgNotification/NewChatMsgNotification.js')}"/>   
            <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.NewChatMsgNotification_SR_HUM,'NewChatMsgNotification/NewChatMsgNotification.css')}" />    
        </apex:outputText>
    </head>
    <liveAgent:clientchat >
        <div class="row">
            <div class="small-glass-container">
                <div class=" columns x2 eighteen">
                    <div class="row">
                        <div class="eighteen columns ">
                            <div class="lifeblock-heading">
                                <h1
                                    class="link-list-heading lifeblock core-green bl-tail tl-br-curve">
                                    <span class="content">Humana chat</span>
                                </h1>
                            </div>
                        </div>
                    </div>
                    <liveAgent:clientChatAlertMessage />
                    <liveAgent:clientChatStatusMessage />
                    <table id="waitingMessage" cellpadding="0" cellspacing="0">
                        <tr>
                            <td><script type="text/javascript">
                                SfdcApp.LiveAgent.Chasitor.addQueueComponent("queuePosition");
                                </script>
                                
                                <div class="hide_queuePos" id="liveAgentQueuePosition">
                                    <span id="agnStatus">You are currently <span id="queuePosition" class="liveAgentQueuePosition"></span> in
                                        the queue. </span>A chat specialist will be with you soon.
                                </div>
                            </td>
                        </tr>
                    </table>
                    <div class="row">
                        <div class="small-glass-container">
                            <div class="row" style="display: none;" id="agNameId">
                                <div class="seventeen columns x2-left">
                                    <p class="x0 legal-copy">
                                        You are now connected with <span id="agName" value=""></span>.
                                    </p>
                                </div>
                            </div>
                            <div class="row">
                                <div class="seventeen columns scrollable-content x2-left">
                                    <div class="section-content">                                      
                                        <liveAgent:clientChatLog id="visitorNameLog" visitorNameLabel="{!$CurrentPage.parameters.liveagent.prechat:AccountName}"/>
                                        <apex:outputPanel rendered="{!bSwitch}">  
											<div id="newAgentMessage" onclick = "scrollToBottom();">
												<p id = "NewHUMUnsecureMessage" align="right">{!$Label.HUMNewMsgNotification}</p>
											</div>
										</apex:outputPanel>                                       
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                            <div><liveAgent:clientChatLogAlertMessage /></div><br />
                            <div class="seventeen columns x1-top x2-left">
                                   <liveagent:clientChatInput useMultiline="true" />
                                </div>
                            </div>
                            <div class="row x2">
                                <div class="eighteen columns x1-top x2-left">
                                    <button class="link-primary x1-right" style="display: none;" id="sendBtn" onclick="SfdcApp.LiveAgent.Chasitor.sendMessage();" title="Send">
                                        <span>Send</span>
                                    </button>
                                    <span class="link-tertiary x1-left"> <liveAgent:clientChatEndButton label="End chat" /> </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>         
    </liveAgent:clientchat>
</apex:page>