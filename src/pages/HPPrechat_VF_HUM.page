<!--
Page Name        : HPPrechat_Hum_VF 
Version          : 1.0 
Created Date     : 03/12/2019 
Function         : This page is pre-chat survey form. Which is filled in by user before chat is initiated.
Modification Log :
*   Modification ID     Developer               Code Review             Date                 Description
* ------------------------------------------------------------------------------------------------------------------------------                
*   1.0                 Joel George                                     03/12/2019           Original       
*   1.1                 Lakshmi Madduri                                 5/2/2019              Displaying visitor name in chat 
*   1.2                 Melkisan Selvaraj         357216                5/24/2019             Added Tealium script
*   1.3                 Lakshmi Madduri                                 6/12/2019               Modifications for Tealium Script
*   1.4                 Joel George                                     07/20/2020           REQ - 1159264 Include Chat Type
*   1.5                 T Prasanna Sai Kumar                            03/23/2021           REQ - 1910466 Live Agent Security Vulnerabilities for SonarQube Scan - HP Live Agent
*   1.6                 Alvaro Madrid                                   05/10/2022           REQ - 3298630 CenterWell rebranding for Live Chat on HP.com
*   1.7                 Alvaro Madrid                                   07/13/2023           US 4842692 - Decrypt the IVA Bot Transcript from CWP
*   1.8                 Alvaro Madrid                                   09/21/2023           US 5140245 -  Ability for the prechat page to dynamically set the button id and name
*   1.9                 Sivaprakash Rajendran                           09/25/2023           US 5158379 - Skipping Prechat for CWP Secured Chat.
-------------------------------------------------------------------------------------------------------------------------------->
<apex:page controller="HPPreChatController_C_HUM" id="thePage" showheader="false" standardStyleSheets="false" >
    <!-- Loading CSS files received from digital team for Humana view standards -->
    <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.HPHUMLiveAgentCSS,'/library/base.css')}"/>
    <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.HPHUMLiveAgentCSS,'/library/framework.css')}"/>
    <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.HPHUMLiveAgentCSS,'/library/global.css')}"/>
    <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.HPHUMLiveAgentCSS,'/library/global1.css')}"/>
    <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.HPHUMLiveAgentCSS,'/library/humanacom.css')}"/>
    <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.HPHUMLiveAgentCSS,'/library/humanacom1.css')}"/>
    <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.HPHUMLiveAgentCSS,'/library/lib.css')}"/>
    <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.HPHUMLiveAgentCSS,'/library/styles.css')}"/>
    <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.HPHUMLiveAgentCSS,'/library/tools.css')}"/> 
    
    <!-- Loading jQuery toolkit as per VF standards -->
    <apex:includeScript value="{!URLFOR($Resource.CRM_JQUERY, 'jquery.min.js')}" />  
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>CenterWell Pharmacy</title>
    </head>
    <body>
        <!--Do not remove. Tealium code snippet for Humana analytics/metrics-->
        <script type="text/javascript">
            var utag_data = {};
            if (typeof HumAnalytics == "undefined"){
                var HumAnalytics = window.HumAnalytics = {};
            }
            HumAnalytics.appid = [];
            HumAnalytics.autorenewflag = [];
            HumAnalytics.copayexcflag = [];
            HumAnalytics.prodcat = [];
            HumAnalytics.prodid = [];      
            HumAnalytics.prodname = [];
            HumAnalytics.prodpkgqty = [];      
            HumAnalytics.prodqty = [];
            HumAnalytics.prodsav = [];   
            HumAnalytics.prodtranstype = [];          
            HumAnalytics.prodtype = []; 
            HumAnalytics.produp = [];
        </script>
        <script type="text/javascript">
           <!-- Loading script asynchronously -->
            (function(a,b,c,d){
                a='{!JSENCODE(sWebChatVarMap['HP_Tealium'].value__c)}';
                b=document;c='script';d=b.createElement(c);d.src=a;d.type='text/java'+c;d.async=true;
                a=b.getElementsByTagName(c)[0];a.parentNode.insertBefore(d,a);
            })();
        </script>
        
        <form id="theform" method="post">
            <div class="row">
                <div class="small-glass-container">
                    <div class=" columns x1 eighteen"> 
                        <div class="row">
                            <apex:image styleClass="hpHeaderImage" url="{!URLFOR($Resource.HPHUMLiveAgentCSS,'library/images/header1.png')}"/>
                            <span class="hpHeader">CenterWell Pharmacy Chat</span>
                        </div>
                        <apex:outputpanel rendered="{!bShowError}">
                            <apex:pageMessages ></apex:pageMessages>
                        </apex:outputpanel>
                        <apex:outputpanel rendered="{!!bShowError}">
                            <div class="row">
                                <div class="small-glass-container" id="preChat">
                                    <div id="statusImageHUMPrechat" style="display: Block;">
                                        <div id="displayLoadingMsg" class="row" style="display: none;">
                                            <div class="seventeen columns x1-left">
                                                <p class="x1">{!$Label.HPThankYouMsg_SkipPreChat}</p>
                                            </div>
                                        </div>                            
                                        <!-- This block will render a spinner image to indicate table loading in the UI -->
                                        <div class="loadingSectionStyle" style="padding-left: 40%;">
                                            <img src="/img/loading.gif" />
                                            <span class="waitingDescription"> {!$Label.LOADING_HUM}</span>
                                        </div>
                                    </div>
                                    
                                    <div id="prechatform" class="row" style="display: none;">
                                        <div class="hpContainer">
                                            <p class="hpMainText">{!$Label.HPThankyou}</p>
                                        </div>
                                        <div class="hpContainer">                                  
                                            <div class="">
                                                <apex:outputPanel id="testIDng">
                                                    <p class="x1">
                                                        <div class="x0" id="errPanelForCategorySelect">
                                                            <label id="categorySelectLabel" class="hpFieldLabel" for="CategorySelect">
                                                                {!$ObjectType.LiveChatTranscript.Fields['Subject__c'].Label} <span class="hpAsterisk">*</span>
                                                            </label>
                                                            <div class="fixedWidth">
                                                                <span class="userSelectWebKit" id="categorySelectSpan" style="display:none">{!$Label.HUMSelectLabel}</span>
                                                                <select id="CategorySelect" class="hpMainText hpTextInput" multiselect="false" onFocus="removeErrorMessage(this);" onchange="fnHandleCategoryChange(this.options[this.selectedIndex]);" size="1" style="height:48px">
                                                                    <option value="Select">{!$Label.HPLiveAgentSelect}</option>
                                                                    <option value="Order Status/Track Shipment">{!$Label.HPLiveAgentOrderStatus}</option>
                                                                    <option value="Refill/Renew a Rx">{!$Label.HPLiveAgentRefill}</option>
                                                                    <option value="Order OTC Product">{!$Label.HPLiveAgentOTC}</option>
                                                                    <option value="Start a New Rx">{!$Label.HPLiveAgentNewRX}</option>
                                                                    <option value="Manage Account/Payment">{!$Label.HPLiveAgentManageAccount}</option>
                                                                </select>                                                                                     
                                                                <img alt="error" class="hpIcon error-icon displayStyle" id="categorySelectError" src="{!URLFOR($Resource.HPHUMLiveAgentCSS,'/library/images/forms/alertIcon.png')}"/>
                                                                <span class="hpErrorLabel field-validation-error errMsgStyle displayStyle" id="categorySelectErrMsg">{!$Label.HUMRequiredErrMsg}</span>                                 
                                                            </div>
                                                        </div>
                                                    </p>
                                                    <label for="help" class="hpFieldLabel">
                                                        {!$Label.HUMIssueLabel} 
                                                    </label>
                                                </apex:outputPanel>
                                            </div>
                                            <div id="chatAvailable">
                                                <div class="row">
                                                    <div class="fourteen columns x2">
                                                        <textarea class="hpTextInput hpMainText resizeStyle" cols="190" id="issue" name="liveagent.prechat:Issue" onfocus="removeErrorMessage(this);" onkeyup="textLimit(this,200);" rows="6"/>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="row">
                                                        <div class="row x1-top x1" style="margin-left: 5px;">
                                                            <p class="x1">
                                                                <span class="hpText300">{!$Label.HUMTermsOfUse1}</span>
                                                                <a class="hpLink" href="#" onclick="fnGoToTermsOfUse();">
                                                                    {!$Label.HUMTermsOfUse2} 
                                                                </a>
                                                            </p>
                                                        </div>
                                                    </div> 
                                                
                                                    <input name="liveagent.prechat:BotTranscript" type="hidden" value="" id="BotTranscriptDecrypt" />
                                                    <input name="liveagent.prechat:Category" type="hidden" value="CategoryValue" id="CategoryValue" />
                                                    <input name="liveagent.prechat.save:Category" type="hidden" value="Subject__c"/>
                                                    <input name="liveagent.prechat:ChatType" type="hidden" value="{!sCType}" id="ChatTypeValue" />
                                                    <input name="liveagent.prechat.save:ChatType" type="hidden" value="Chat_Type__c"/> 
                                                    <input name="liveagent.prechat.save:Issue" type="hidden" value="Issue__c"/>
                                                    <input name="liveagent.prechat:URL" id="testURI" type="hidden" value=""/>
                                                    <input name="liveagent.prechat.save:URL" type="hidden" value="URL__c"/>
                                                    <input name="liveagent.prechat:AccountId" id="accountid" type="hidden" value=""/>
                                                    <input name="liveagent.prechat.name" id="namefield" type="hidden" value=""/>
                                                    <input name="liveagent.prechat:AccountName" id="accountname" type="hidden" value=""/>

                                                    <input name="liveagent.prechat:InteractionId" id="interactionid" type="hidden" value=""/>
                                                    <input name="liveagent.prechat:InteractionName" id="interactionname" type="hidden" value=""/>
                                                    <input name="liveagent.prechat.findorcreate.map:Account" type="hidden" value="Id,AccountId"/>                                           
                                                    <input name="liveagent.prechat.findorcreate.saveToTranscript:Account" type="hidden" value="Account"/>                                           
                                                    <input name="liveagent.prechat.findorcreate.map.doFind:Account" type="hidden" value="Id,true"/>                                         
                                                    <input name="liveagent.prechat:customAccountId" type="hidden" id="customAccountId" value=""/>
                                                    <input name="liveagent.prechat.save:customAccountId" type="hidden" value="AccountId__C"/>
                                                    <input name="liveagent.prechat:SecChatID" id="secchatid" type="hidden" value=""/>
                                                    <input name="liveagent.prechat.findorcreate.map:Interaction__c" type="hidden" value="Id,InteractionId"/>
                                                    <input name="liveagent.prechat.findorcreate.saveToTranscript:Interaction__c" type="hidden" value="Interaction__c"/>
                                                    <input name="liveagent.prechat.findorcreate.map.doFind:Interaction__c" type="hidden" value="Id,true"/>
                                                    <input name="liveagent.prechat.findorcreate.map:LiveChatTranscript" type="hidden" value="Secondary_Chat_ID__c,SecChatID"/>
                                                    <input name="liveagent.prechat.findorcreate.map.doFind:LiveChatTranscript" type="hidden" value="Secondary_Chat_ID__c,true"/>
                                                    <input name="liveagent.prechat.save:SecChatID" type="hidden" value="Secondary_Chat_ID__c"/> 

                                                    <input name="liveagent.prechat:MemberGenKey" id="MemberGenKey" type="hidden" value =""/>
                                                    <input name="liveagent.prechat:sLSessionID" id="sLSessionID"  type="hidden" value=""/>                                         
                                                    <input name="liveagent.prechat:deployment_id" id="depId" type="hidden" value="{!sWebChatVarMap['DeploymentID'].value__c}"/>
                                                    <input name="liveagent.prechat:org_id" id="comId" type="hidden" value="{!sWebChatVarMap['CompanyID'].value__c}"/>
                                                    <input name="liveagent.prechat.findorcreate.displayToAgent:sLSessionID" type= "hidden" value= "false" />
                                                    <input name="liveagent.prechat.findorcreate.displayToAgent:MemberGenKey" type= "hidden" value= "false" />
                                                    <input name="liveagent.prechat.findorcreate.displayToAgent:AccountId" type= "hidden" value= "false" />
                                                    <input name="liveagent.prechat.findorcreate.displayToAgent:InteractionId" type= "hidden" value= "false" />
                                                    <input name="liveagent.prechat.findorcreate.displayToAgent:customAccountId" type= "hidden" value= "false" />
                                                    <input name="liveagent.prechat:SelBtnId" type="hidden" id="SelButttonID" value=""/>
                                                    <input name="liveagent.prechat.findorcreate.displayToAgent:SelBtnId" type= "hidden" value= "false" />
                                                    <input name="liveagent.prechat.findorcreate.displayToAgent:SecChatID" type= "hidden" value= "false" />
                                                    <input name="liveagent.prechat.findorcreate.displayToAgent:deployment_id" type= "hidden" value= "false" />
                                                    <input name="liveagent.prechat.findorcreate.displayToAgent:org_id" type= "hidden" value= "false" /> 
                                                    <input name="liveagent.prechat.findorcreate.displayToAgent:AccountName" type= "hidden" value= "false" /> 
                                                    <input name="liveagent.prechat.findorcreate.displayToAgent:BotTranscript" type= "hidden" value= "false" />
                                                    <input name="liveagent.prechat:Skill Name" type="hidden" value="" id="SkillNameLabel" />

                                                    <input type="hidden" name="liveagent.prechat:Case Origin" id="caseOrigin" /> 
                                                    <input type="hidden" name="liveagent.prechat:Case Type" id="caseType" />
                                                    <input type="hidden" name="liveagent.prechat:InteractingWithType" id="interactingWithType" />
                                                    <input type="hidden" name="liveagent.prechat.findorcreate.map:Case" value="ChatKey__c,SecChatID;Origin,Case Origin;Interacting_With__c,AccountId;AccountId,AccountId;Interacting_With_Type__c,InteractingWithType;Interacting_About_Type__c,InteractingWithType;Type,Case Type" />
                                                    <input type="hidden" name="liveagent.prechat.findorcreate.map.doCreate:Case" value="ChatKey__c,true;Origin,true;Interacting_With__c,true;AccountId,true;Interacting_With_Type__c,true;Interacting_About_Type__c,true;Type,true" />
                                                    <input type="hidden" name="liveagent.prechat.findorcreate.saveToTranscript:Case" value="Case" />
                                                    <input type="hidden" name="liveagent.prechat.findorcreate.showOnCreate:Case" value="true" />  

                                                    <div class="row x1">
                                                        <div class="eighteen columns">
                                                            <button class="hpBlueButton" onclick="createSubmitURL()" type="button">
                                                                <span>{!$Label.HUMStartChat}</span>
                                                            </button>
                                                            <a class="hpCancelButton" href="javascript:window.close();"><span>{!$Label.HUMCancel}</span></a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>                                  
                                        </div>
                                    </div>
                                </div> 
                                <div class="row" id="memberNotFound">
                                    <div class="hpContainer">
                                        <div class="row">
                                            <div style="margin-right: 10px;">
                                                <h4 style="color: black!IMPORTANT;">{!$Label.HPMemberNotFound}</h4>
                                                <p class="x1"><span>{!$Label.HPMemberNotFound1}</span>
                                                    <a target="_blank" href="{!HTMLENCODE(sWebChatVarMap['HPContactUsLink'].value__c)}">{!$Label.HUMContactCenter}</a>
                                                    <span>{!$Label.HPMemberNotFound2}</span>
                                                </p>
                                                <br/>
                                                <span class="link-tertiary" onclick="javascript:window.close();">{!$Label.HPCloseWindow}</span>
                                            </div>                                    
                                        </div>
                                    </div>
                                </div>
                                <div class="row" id="termsOfUse">
                                    <div class="hpContainer">
                                        <H2 class="hpHeading1">{!$Label.HUMTermsOfUse2}</H2>
                                        <div class="row">
                                            <ul class="hpMainText">
                                                <li class="hpBullet">
                                                    <a class="hpLink" href="{!$Label.HPLegalURL}" target="_blank">{!$Label.HUMClickHere}</a>
                                                    {!$Label.HPLegalClickHere}
                                                </li>
                                                <li class="hpBullet">
                                                    <a class="hpLink" href="{!$Label.HPPrivacyURL}" target="_blank">{!$Label.HUMClickHere}</a>
                                                    {!$Label.HpPrivacyClickHere}.
                                                </li>
                                                <li class="hpBullet">
                                                    <a class="hpLink" href="{!$Label.HPInternetPrivacyURL}" target="_blank">{!$Label.HUMClickHere}</a>
                                                    {!$Label.HPInternetClickHere}.
                                                </li>
                                                <li class="hpBullet">{!$Label.HPBullet1}</li>
                                                <li class="hpBullet">{!$Label.HUMBullet4}</li>
                                                <li class="hpBullet">{!$Label.HPBullet2}</li>
                                            </ul>
                                        </div>
                                        <div class="row x1">
                                            <div class="eighteen columns">
                                                <button class="hpBlueButton x1-right" onclick="fnGoBackToPreChat();" type="button">
                                                    <span>{!$Label.HUMBack}</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </apex:outputpanel>
                    </div>
                </div>
            </div>
        </form>
    </body>

    <apex:includeScript value="{!URLFOR(sWebChatVarMap['DeploymentJS'].value__c)}"/> 
    <apex:includeScript value="{!URLFOR(sWebChatVarMap['PreChatJS'].value__c)}"/>
    <apex:includeScript value="{!URLFOR($Resource.HPHUMLiveAgentCSS,'/library/HUMPreChat.js')}"/>
    <script type="text/javascript">  
        //Code related to Code Metrics.
        var src = "{!JSENCODE(sWebChatVarMap['CodeMetricsJS'].value__c)}";
        if (window.location.host.indexOf("qa") >=0) 
        {
            src = "{!JSENCODE(sWebChatVarMap['CodeMetricsQaJS'].value__c)}";
        } 
        else if (window.location.host.indexOf("test") >=0) 
        {
            src = "{!JSENCODE(sWebChatVarMap['CodeMetricsTestJS'].value__c)}";
        }
        document.write('<script src="' + src + '" type="text/javascript"><' + '/script>');  
        
        //default actions to hide error blocks & terms of use blocks
        jQuery('#chatAvailable').show();
        jQuery('#termsOfUse').hide();
        jQuery('#memberNotFound').hide();

        //global variables to be used in the functionlity in JS resource
        var sLsessionId = '';
        var sMemberGenKey = '';
        var sUrlNew = '';
        var btnValue = JSON.parse('{!btnMapJson}');

        //global Dom elements to be used in the functionlity in JS resource
        var sSecChatID = document.getElementById('secchatid');
        var sSecondary_Chat_Id = '{!JSENCODE(sSecondary_Chat_Id)}';
        document.getElementById('secchatid').value = sSecondary_Chat_Id ;
        
        var sSelbtnId = document.getElementById('SelButttonID');
        var sIssue = document.getElementById('issue');
        var sCategoryValue = document.getElementById("CategoryValue");
        var sMemberGenKeyEle = document.getElementById("MemberGenKey");
        var sLSessionIDEle = document.getElementById("sLSessionID");
        var sEncryptedPersonID = '';
        var sUr = document.getElementById("testURI");
        var sAccountId = document.getElementById('accountid');   
        var sIntId = document.getElementById('interactionid');
        var sIntMemberId = document.getElementById('intMemberId');
        var sInteractionName = document.getElementById('interactionname');
        var sTheForm = document.forms["theform"];
        var stheFormToSubmit = document.getElementById("theform");
        var sCustomAccountId = document.getElementById('customAccountId');
        var sCategorySelect = document.getElementById("CategorySelect");
        var sRemotingTarget = '{!$RemoteAction.HPPreChatController_C_HUM.findAccountByPersonId}';
        var sRemotingTargetOnLoadDecrypt = '{!$RemoteAction.HPPreChatController_C_HUM.decryptUserIdentifiers}';
        var sAccountName = document.getElementById('accountname');
        var sInteractingWithType = document.getElementById('interactingWithType');
        var sCaseOrigin = document.getElementById('caseOrigin'); 
        var sCaseType = document.getElementById('caseType');
        var sAccNameAgentSide = document.getElementById('namefield');
        var sDecryptBotTranscript = document.getElementById("BotTranscriptDecrypt");
        var sSkillNameLabel = document.getElementById('SkillNameLabel');
        var btnSkillHashMap = JSON.parse('{!btnSkillMapJson}');
        var sCWPRoutingIsOn = JSON.parse('{!CWPRoutingIsOn}');
        var sCWPSkippingPreChat = JSON.parse('{!CWPSkippingPreChat}');

        /**
        As Live Agent API Does not work when we include it in the Static resource, hence
        we have kept the live agent and event firing related code on the page.
        Rest event handlers and remoting methods are moved in static resource.
        */
        //liveagent preChatInit initialization
        liveagent.details.preChatInit("{!JSENCODE(sWebChatVarMap['LiveChatURL'].value__c)}", 'detcall');
        //liveagent initialization
        liveagent.init("{!JSENCODE(sWebChatVarMap['LiveChatURL'].value__c)}","{!JSENCODE(sWebChatVarMap['DeploymentID'].value__c)}","{!JSENCODE(sWebChatVarMap['CompanyID'].value__c)}", false, true);
    </script>
</apex:page>