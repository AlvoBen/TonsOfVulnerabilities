<!--
Page Name        : HUMLiveChat_VF_HUM
Version          : 1.0 
Created Date     : March 12, 2019
Function         : Custom Chat Window page for Live Agent Pharmacy
Modification Log :
*   Modification ID     Developer          Code Review         Date                 Description
* ------------------------------------------------------------------------------------------------------------------------------                
*           1.0         Lakshmi Madduri                     3/12/2019              Original Version
*           1.1         Lakshmi Madduri                     4/29/2019               Defect fix 413366.0001
*           1.2         Melkisan Selvaraj   357216          5/24/2019              Added Tealium script
*           1.3         Lakshmi Madduri                     6/12/2019               Modifications for Tealium Script
*           1.4         Akshay Pai                          1/18/2021             REQ - 1840097 - Visual Cue for New Messages in Chat Window - HP
*           1.5         Lakshmi Madduri                     2/16/2021               REQ-1840097 Switch Creation
*           1.6         T Prasanna Sai Kumar                03/23/2021            REQ - 1910466 Live Agent Security Vulnerabilities for SonarQube Scan - HP Live Agent
*           1.7         Alvaro Madrid                       05/10/2022            REQ - 3298630 CenterWell rebranding for Live Chat on HP.com
-------------------------------------------------------------------------------------------------------------------------------->
<apex:page controller="HPPreChatController_C_HUM" showHeader="false" id="pageID" standardStyleSheets="false" action="{!initVariable}">
    <!-- JS Cannot be moved to Static Resource as Live agent JS loads after static resource and 
    liveagent attribute is defined in deployment.js file which will load after static resource.
    It will throw error as liveagent is undefined if JS moved into static resource.
    -->
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <script type="text/javascript">
            //Code related to Code Metrics.
            var src = "{!JSENCODE(sWebChatVarMap['CodeMetricsJS'].value__c)}";
            if (window.location.host.indexOf("qa") >=0) 
            {
                src = "{!JSENCODE(sWebChatVarMap['CodeMetricsQaJS'].value__c)}";
            } 
            else if (window.location.host.indexOf("test") >=0 ) 
            {
                src = "{!JSENCODE(sWebChatVarMap['CodeMetricsTestJS'].value__c)}";
            }
            document.write('<script src="' + src + '" type="text/javascript"><' + '/script>');

            //Storing values from the prechat page.
            var sButtonId = '{!JSENCODE($CurrentPage.parameters.liveagent.prechat:SelBtnId)}';
            var sOrgId = '{!JSENCODE($CurrentPage.parameters.liveagent.prechat:org_id)}'; 
            var sDepId = '{!JSENCODE($CurrentPage.parameters.liveagent.prechat:deployment_id)}'; 
            var sSecondaryChatId = '{!JSENCODE($CurrentPage.parameters.liveagent.prechat:SecChatID)}'; 
            
            //liveagent Initialisation 
            liveagent.chasitor.setOrgId(sOrgId);
            liveagent.chasitor.setDeploymentId(sDepId);
            liveagent.chasitor.setButtonId(sButtonId);
            liveagent.addEventListener(liveagent.chasitor.Events.CHAT_REQUEST_SUCCESSFUL,chatRequestSuccess);
            liveagent.addEventListener(liveagent.chasitor.Events.CHAT_ESTABLISHED,myCallBack);
            liveagent.addEventListener(liveagent.chasitor.Events.AGENT_CHAT_TRANSFERRED,newagent);

            if({!bSwitch})
            {
                liveagent.addEventListener(liveagent.chasitor.Events.AGENT_CHAT_MESSAGE,newAgentMessage);
                //Getting custom label details
                window.$Label = window.$Label || {};
                $Label.HUMNewMsgDesktopNotification = '{!JSENCODE($Label.HUMNewMsgDesktopNotification)}';
            }
            //CHAT_REQUEST_SUCCESSFUL event callback helper function
            function chatRequestSuccess() 
            {
                var details = liveagent.chasitor.getDetails();
                for(i=0;i<details.prechatDetails.length;i++)
                {
                    if(details.prechatDetails[i].label=='MemberGenKey')
                    {
                        HumAnalytics.regid = details.prechatDetails[i].value;
                    }
                    else if(details.prechatDetails[i].label=='sLSessionID')
                    {
                        HumAnalytics.ssid = details.prechatDetails[i].value;
                    }
                    HumAnalytics.secid = sSecondaryChatId;
                }
            }
            
            //CHAT_ESTABLISHED event callback helper function
            function myCallBack() 
            {
                var details = liveagent.chasitor.getDetails();
                var agentName = details['agent']['agentName'];
                document.getElementById('agNameId').style.display = '';
                document.getElementById('sendBtn').style.display = '';
                document.getElementById('agName').innerHTML = agentName;
                var labels = {
                    AGENT_TYPING: agentName + ' is typing...'
                };
                SfdcApp.LiveAgent.Chasitor.loadLabels(labels);
                commitTranscript();
            }
            
            //AGENT_CHAT_TRANSFERRED event callback helper function
            function newagent() 
            {
                var details = liveagent.chasitor.getDetails();
                var agentName = details['agent']['agentName'];
                document.getElementById('agName').innerHTML = agentName;
                var agentName = details['agent']['agentName'];
                var clientName = liveagent.chasitor.getName();
                var labels = {
                    AGENT_TYPING: agentName + ' is typing...'
                };
                SfdcApp.LiveAgent.Chasitor.loadLabels(labels);   
            }
            
            //Cannot Move it into static resource as it is using parameters that are related to live agent
            //Live agent components cannot be loaded inside static resource 
            function commitTranscript()
            {
                try
                {
                    Visualforce.remoting.Manager.invokeAction('{!$RemoteAction.HPPreChatController_C_HUM.onCommitTranscript}',liveagent.chasitor.getChatKey(),getAgentDetail(),function(result, event)
                    {
                        if (event.status) 
                        {
                            return true;
                        } 
                        else
                        {
                            return false;
                        }
                    }, 
                    {
                        escape:true
                    });
                }
                catch (ex) 
                {
                    return false;
                }
                return false;  
            }
            
            //commitTranscript helper function
            function getAgentDetail()
            {
                var details = liveagent.chasitor.getDetails();
                var tId='';
                tId = details['agent']['userId'];
                return tId;
            }
            
            //parsing the interaction info from liveagent details
            function getInteractionId()
            {
                var details = liveagent.chasitor.getDetails();
                var intId='';
                for(i=0;i<details.prechatDetails.length;i++)
                {
                    if(details.prechatDetails[i].label=='InteractionId')
                    {
                        intId = details.prechatDetails[i].value;
                    }
                }
                return intId;
            }
        </script>
        
        <title>CenterWell Pharmacy Chat</title>
        <!-- Loading CSS files received from digital team for Humana view standards -->
        <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.HPHUMLiveChatWindowCSS,'/LiveChatWindowCSS/base.css')}" />
        <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.HPHUMLiveChatWindowCSS,'/LiveChatWindowCSS/framework.css')}" />
        <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.HPHUMLiveChatWindowCSS,'/LiveChatWindowCSS/global.css')}" />
        <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.HPHUMLiveChatWindowCSS,'/LiveChatWindowCSS/global1.css')}" />
        <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.HPHUMLiveChatWindowCSS,'/LiveChatWindowCSS/humanacom.css')}" />
        <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.HPHUMLiveChatWindowCSS,'/LiveChatWindowCSS/lib.css')}" />
        <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.HPHUMLiveChatWindowCSS,'/LiveChatWindowCSS/styles.css')}" />
        <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.HPHUMLiveAgentCSS,'/library/styles.css')}"/>
        <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.HPHUMLiveChatWindowCSS,'/LiveChatWindowCSS/renderings.css')}" />
        <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.HPHUMLiveChatWindowCSS,'/LiveChatWindowCSS/main.css')}" />
        <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.HPHUMLiveChatWindowCSS,'/LiveChatWindowCSS/Chat.css')}" />
        
        <!-- Loading jQuery toolkit as per VF standards -->
        <apex:includeScript value="{!URLFOR($Resource.CRM_JQUERY, 'jquery.min.js')}" /> 
        <apex:outputText rendered="{!bSwitch}">
            <apex:includeScript value="{!URLFOR($Resource.NewChatMsgNotification_SR_HUM,'NewChatMsgNotification/NewChatMsgNotification.js')}"/>   
            <link rel="stylesheet" text="text/css" href="{!URLFOR($Resource.NewChatMsgNotification_SR_HUM,'NewChatMsgNotification/NewChatMsgNotification.css')}" />    
        </apex:outputText>
    </head>
    <!--Do not remove. Tealium code snippet for Humana analytics/metrics-->
    <script type="text/javascript">
        var utag_data = {};
        if (typeof HumAnalytics == "undefined"){
            var HumAnalytics = window.HumAnalytics = {};
        }
        HumAnalytics.appid = [];
        HumAnalytics.autorenewflag = [];
        HumAnalytics.copayexcflag = [];
        HumAnalytics.prodcat = [];
        HumAnalytics.prodid = [];      
        HumAnalytics.prodname = [];
        HumAnalytics.prodpkgqty = [];      
        HumAnalytics.prodqty = [];
        HumAnalytics.prodsav = [];   
        HumAnalytics.prodtranstype = [];          
        HumAnalytics.prodtype = []; 
        HumAnalytics.produp = [];
    </script>
    <script type="text/javascript">
        <!-- Loading script asynchronously -->
        (function(a,b,c,d){
            a='{!JSENCODE(sWebChatVarMap['HP_Tealium'].value__c)}';
            b=document;c='script';d=b.createElement(c);d.src=a;d.type='text/java'+c;d.async=true;
            a=b.getElementsByTagName(c)[0];a.parentNode.insertBefore(d,a);
        })();
    </script>
    <liveAgent:clientchat >
        <div class="row">
            <div class="small-glass-container">
                <div class=" columns x2 eighteen">
                    <div class="row">
                        <apex:image url="{!URLFOR($Resource.HPHUMLiveAgentCSS,'library/images/header1.png')}"/>
                        <span class="hpHeader">CenterWell Pharmacy Chat</span>
                    </div>
                    <liveAgent:clientChatAlertMessage />
                    <liveAgent:clientChatStatusMessage />
                    <table id="waitingMessage" cellpadding="0" cellspacing="0">
                        <tr>
                            <td>
                                <script type="text/javascript">
                                    SfdcApp.LiveAgent.Chasitor.addQueueComponent("queuePosition");
                                </script>
                                <div class="hpContainer hide_queuePos" id="liveAgentQueuePosition">
                                    <span id="agnStatus" class="hpMainText">You are currently <span id="queuePosition" class="liveAgentQueuePosition"></span> in
                                        the queue. A chat specialist will be with you soon.
                                    </span>
                                </div>
                            </td>
                        </tr>
                    </table>
                    <div class="row">
                        <div class="small-glass-container">
                            <div class="row" style="display: none; padding-top:15px" id="agNameId">
                                <span class="hpText300">
                                    You are now connected with <span id="agName" value=""></span>.
                                </span>
                            </div>
                            <div class="row">
                                <div class="seventeen columns scrollable-content x2-left">
                                    <div class="section-content">                                      
                                        <span class="hpMainText"><liveAgent:clientChatLog id="visitorNameLog" visitorNameLabel="{!$CurrentPage.parameters.liveagent.prechat:AccountName}"/></span>
                                        <apex:outputPanel rendered="{!bSwitch}">  
                                            <div id="newAgentMessage" onclick = "scrollToBottom();">
                                                <p id = "NewHPMessage" align="right">{!$Label.HUMNewMsgNotification}</p>
                                            </div>
                                        </apex:outputPanel>                                       
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div><liveAgent:clientChatLogAlertMessage /></div><br />
                                <div class="seventeen columns x1-top x2-left">
                                   <liveagent:clientChatInput useMultiline="true"/>
                                </div>
                            </div>
                            <div class="row x2">
                                <div class="eighteen columns x1-top x2-left">
                                    <button class="hpBlueButton" style="display: none;" id="sendBtn" onclick="SfdcApp.LiveAgent.Chasitor.sendMessage();" title="Send">
                                        <span>Send</span>
                                    </button>
                                    <liveAgent:clientChatEndButton label="End Chat" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>         
    </liveAgent:clientchat>
</apex:page>