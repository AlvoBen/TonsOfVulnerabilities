<!--
Page Name        : HUMPostWebChatPage
Version          : 1.0 
Created Date     : AUGUST 25 2014
Function         : Custom window for Post Chat form on Live agent
Modification Log :
*   Modification ID     Developer                     Code Review         Date                 Description
* ------------------------------------------------------------------------------------------------------------------------------                
*           1.0         Sagar Tapadia                    18240              08/25/2014               Original Version
*           2.0         Sagar Tapadia                    18801              10/27/2014               Removed Exclamation from a text. 
*           3.0         Sagar Tapadia                    18975              10/30/2014               Updated code for changes related to CR-50,Humana Analytics with Chat
*           4.0         Sagar Tapadia                    18975              11/03/2014               Updated verbiage related to Unavailability to make it same as Pre Chat Page.
*           5.0         Sagar Tapadia                    21883              03/26/2015               CA Ticket#4974139: Move Core metrics code to Page rather than keep it inside static resource.
*           6.0         Shreya Choodamani                25923              08/28/2015               made changes to pass the interaction number(name) in the URL for survey monkey as per REQ - 205290.
*           7.0         Shiva Pasumarty                                     08/17/2016               REQ 270037 : Ability to provide the RSO segment with a separate Post Chat Survey
*           8.0         Muralidhar Kollu                 80609              02/28/2017               REQ - 306319: Post Web Chat - Additional Debugging on empty interactionId (CA Tix 6197943 and 6351830)
*           9.0         Santhi Mandava                   90926              05/09/2017               REQ - 313381 : Implemented additional debugging on OK button click
*           10.0        Santhi Mandava                   93720              05/17/2017               REQ - 313381 : Fixed survey monkey chrome browser issue.
*			11.0        Rajesh C	            		 144547             11/03/2017               REQ - 321230 CRM will expose the unique identifier(s) that can be used to link Chat and Web Data sets
*           12.0        Vandana Chaudhari                160906             12/22/2017               REQ - 347548 Users Unable to Save the chat
*			13.0        Rajesh C        			     171913             01/11/2018               REQ - 350669 CR735: Securing the Save Chat Option - Live Chat & Post Chat Windows.
*	        14.0        Praveen Kumar Parimi       		 286713	            09/14/2018               REQ - 374888 aka CA Incident #7744195 - Fix for handling Line breaking Chars in Issue Field.
*           15.0         Prafull Verma				     328794	            12/28/2018               REQ - 380424: Web Chat Windows Display Proportionately on Small Glass.
*   	    16.0        Praveen Kumar Parimi 	         	    		    11/01/2019			     REQ - 409545 - Adding Tealium Script to the Chat Pages. 
* 			17.0        Akshay Pai                                        	07/16/2020               REQ - 1292117 IVA NINA - Member Secure chat changes
*           18.0        T. Prasanna Sai Kumar                               04/05/2021               REQ - 1915569  Live Agent Security Vulnerabilities for SonarQube Scan - MyHumana Secure Live Agent
*           19.1        Vishnu Pilli                                        11/02/2020               Updated the logic to make Close Window visible and added PostMessage
*           19.2	    Vishnu Pilli                                 	    09/14/2022               US3773361 - Using Post Message to send the transcript to Mobile
-->
<apex:page showheader="false" controller="HUMPreChatController" standardStyleSheets="false" >
    <apex:stylesheet value="{!URLFOR($Resource.HUMLiveAgentCSS,'/library/base.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.HUMLiveAgentCSS,'/library/framework.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.HUMLiveAgentCSS,'/library/global.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.HUMLiveAgentCSS,'/library/global1.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.HUMLiveAgentCSS,'/library/humanacom.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.HUMLiveAgentCSS,'/library/humanacom1.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.HUMLiveAgentCSS,'/library/lib.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.HUMLiveAgentCSS,'/library/styles.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.HUMLiveAgentCSS,'/library/tools.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.HUMPostWebChatPageCSS,'HUMPostWebChatPage/library/Postchatstyleclass.css')}" />
    <apex:includeScript value="{!URLFOR($Resource.CRM_JQUERY, 'jquery.min.js')}"/>
    <script type="text/javascript">
    var src = "{!JSENCODE(sWebChatVarMap['CodeMetricsJS'].value__c)}";
        if (window.location.host.substring(0, 2) == "qa") 
        {
            src = "{!JSENCODE(sWebChatVarMap['CodeMetricsQaJS'].value__c)}";
        } 
        else if (window.location.host.substring(0, 4) == "test") 
        {
            src = "{!JSENCODE(sWebChatVarMap['CodeMetricsTestJS'].value__c)}";
        }
        document.write('<script src="' + src + '" type="text/javascript"><' + '/script>');
          
          var sLogSMClick = "{!sWebChatVarMap['LogSMClick'].value__c}";
		  var sChatDetails2 = '{!JSENCODE($CurrentPage.parameters.chatDetails)}';
		  var pageParams = '{!JSENCODE(pageParams)}';          
          var headerParams = '{!JSENCODE(pageHeaders)}';
          var logInteractionDetails = '{!$RemoteAction.HUMPreChatController.logInteractionDetails}';
                   
          var sInteractionName ='{!JSENCODE(sInteractionName)}';
         function saveMyHumanaChatConfirmation()
          {
            var webChatDownloadConfirmResponse = confirm('{!$Label.Web_Chat_Download_Confirmation_Message}');      
            if (webChatDownloadConfirmResponse)
            {        
                if({!savechatswitch})
                sendChatTranscript();       
                callGoToHUMSaveChatTranscriptPageMethod();
            }
            return false;
          }
        
        /*
            GBO Watson: Adding post message to help GBO Watson team to close the window
          */
          function postMessageAndClose() {
            window.parent.postMessage('Close Window', '*');
            setTimeout(function(){ window.close(); }, 1000);
        }   //  end of postMessageAndClose

            /*
                GBO Watson: Adding logic to send the transcript via Post message
                so that it could be read within the WebView
            */
            function sendChatTranscript(){
                let myHumanaDomain = '{!sWebChatVarMap['MyHumanaDomain'].value__c}';
                let standalone = window.navigator.standalone;
                let userAgent = window.navigator.userAgent.toLowerCase();
                let safari = /safari/.test(userAgent);
                let ios = /iphone|ipod|ipad/.test(userAgent);
                let botTranscript = "{! JSENCODE(webChatTranscriptDetail)}";

                if (ios) {
                    if (!standalone && !safari) {
                        window.parent.postMessage(botTranscript, myHumanaDomain);
                    };
                } else {
                    if (userAgent.includes('android') || userAgent.includes('wv')) {
                        window.parent.postMessage(botTranscript, myHumanaDomain);
                    } 
                };
            }   //  end of sendChatTranscript
        </script>
    <head>
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
      <title>Post Chat</title>
        <apex:includeScript value="{!URLFOR($Resource.HUMPostWebChatPageCSS,'HUMPostWebChatPage/library/HUMPostWebChatPage.js')}"/>
    </head>
    <body>
    <!--Do not remove. Tealium code snippet for Humana analytics/metrics-->
        <script type="text/javascript">
        var utag_data = {};
        if (typeof HumAnalytics == "undefined"){
        	var HumAnalytics = window.HumAnalytics = {};}
	HumAnalytics.appid = [];
	HumAnalytics.autorenewflag = [];
	HumAnalytics.copayexcflag = [];
	HumAnalytics.prodcat = [];
	HumAnalytics.prodid = [];      
	HumAnalytics.prodname = [];
	HumAnalytics.prodpkgqty = [];      
	HumAnalytics.prodqty = [];
	HumAnalytics.prodsav = [];   
	HumAnalytics.prodtranstype = [];          
	HumAnalytics.prodtype = []; 
	HumAnalytics.produp = [];
        </script>
        <script type="text/javascript">
        <!-- Loading script asynchronously -->
            (function(a,b,c,d){
                a='{!JSENCODE(sWebChatVarMap['HP_Tealium'].value__c)}';
                b=document;c='script';d=b.createElement(c);d.src=a;d.type='text/java'+c;d.async=true;
                a=b.getElementsByTagName(c)[0];a.parentNode.insertBefore(d,a);
            })();
        </script>
        <apex:form id="theForm">
            <div id="test" class="row">
                <div class="small-glass-container">
                    <div class=" columns x2 eighteen">
                        <div class="row">
                            <div class="eighteen columns x2">
                                <div class="lifeblock-heading">
                                    <h1 class="link-list-heading lifeblock core-green bl-tail tl-br-curve">
                                    <span class="content">Humana Chat</span>
                                </h1>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="small-glass-container">
                                <div class="row">
                                    <div class="seventeen columns x2-left">
                                        <apex:outputPanel rendered="{!IF($CurrentPage.parameters.transcript!='',true,false)}">
                                            <h1>Thank you&#33;</h1>
                                            <p class="x0">Thank you for your time, we hope your experience with Humana chat was helpful.</p>
                                        </apex:outputPanel>
                                        <apex:outputPanel rendered="{!IF($CurrentPage.parameters.transcript=='',true,false)}">
                                            <h1>Chat is not available</h1>
                                            <p class="x0">{!$Label.HUMNoAgentAvailable} {!$Label.HUMAssistance1} <a target="_blank" href="{!HTMLENCODE(sWebChatVarMap['ContactUsLink'].value__c)}">{!$Label.HUMContactCenter}</a> {!$Label.HUMAssistance2}
                                            </p>
                                        </apex:outputPanel>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="seventeen columns x1 x2-left">
                                        <p class="x2 ">
										<apex:outputPanel rendered="{!IF($CurrentPage.parameters.transcript!='',true,false)}">
                                          <apex:outputLink styleClass=" module-sharing-utility link-tertiary save x1-top" onclick="return saveMyHumanaChatConfirmation();">
                                            <span>Save Chat</span>
                                          </apex:outputLink>
										  </apex:outputPanel>										  										                                           
                                        </p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="eighteen columns x1-top x2-left">
                                        <p class="x1">
                                            <apex:outputPanel rendered="{!IF($CurrentPage.parameters.transcript!='',true,false)}">
                                                Please take a moment to complete a brief survey about your chat experience.
                                            </apex:outputPanel>
                                        </p>
                                        <div id="opPan" class="row x2">
                                            <div class="eighteen columns">
                                                <apex:outputPanel rendered="{!IF($CurrentPage.parameters.transcript!='',true,false)}">
                                                  <apex:outputPanel rendered="{!bGSO}">
                                                    <button class="link-primary x1-right" onclick="openSurvey('{!JSENCODE(sWebChatVarMap['SurveyURL'].value__c)}');return false;" type="submit">
                                                        <span>OK</span>
                                                    </button>
                                                  </apex:outputPanel>  
                                                  <apex:outputPanel rendered="{!bRSO}">
                                                  <button class="link-primary x1-right" onclick="openSurvey('{!JSENCODE(sWebChatVarMap['RSOSurveyURL'].value__c)}');return false;" type="submit">
                                                        <span>OK</span>
                                                    </button>
                                                  </apex:outputPanel>   
                                                    <a href="javascript:postMessageAndClose();" class="link-tertiary x1-left"><span>No thanks</span></a>
                                                </apex:outputPanel>
                                                
                                                <apex:outputPanel rendered="{!IF($CurrentPage.parameters.transcript=='',true,false)}">
                                                    <button class="link-primary x1-right" onclick="javascript:window.close();" type="submit">
                                                        <span>Close Window</span>
                                                    </button>
                                                </apex:outputPanel>                                              
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
          <apex:actionFunction name="callGoToHUMSaveChatTranscriptPageMethod" action="{!goToHUMSaveChatTranscriptPage}"/>
        </apex:form>
    </body>
</apex:page>